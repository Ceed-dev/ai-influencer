# Video Analytics Hub - Context

This file maintains the complete project history for AI continuity.

## Project Purpose

Manage the complete AI influencer video production lifecycle: component management, video production planning, multi-platform analytics (YouTube Shorts / TikTok / Instagram Reels), and AI-driven improvement recommendations.

## Key IDs and Resources

| Resource | ID / URL |
|----------|----------|
| Master Spreadsheet | `1fI1s_KLcegpiACJYpmpNe9tnQmnZo2o8eHIXNV5SpPg` |
| Apps Script Project | `1nbGkujRb6PwtkVuxBh1Vb9NKIUFi_uBa8NbdPSEx_PoxREmyMUKivA0S` |
| Root Drive Folder (AI-Influencer) | `1KRQuZ4W7u5CXRamjvN4xmavfu-7TPb0X` |
| Web App Deployment URL | `https://script.google.com/macros/s/{DEPLOYMENT_ID}/exec` (created via `clasp deploy`) |
| GitHub Repository | `Ceed-dev/video-analytics-hub` |

### Inventory Spreadsheet IDs (stored in Script Properties)

These are auto-generated by `setupCompleteSystem()` and stored in GAS Script Properties:
- `SCENARIOS_INVENTORY_ID`
- `MOTIONS_INVENTORY_ID`
- `CHARACTERS_INVENTORY_ID`
- `AUDIO_INVENTORY_ID`

---

## Session History

### 2026-02-06: Project Initialization (v1.0)

**What was done:**
- Created project folder structure
- Created initial documentation (README.md, ARCHITECTURE.md, CONTEXT.md)
- Defined GAS project structure with component breakdown
- Established Google Sheets schema for multi-platform metrics

**Key decisions:**
1. **GAS over GCP VM**: Chose Google Apps Script for simplicity and native Sheets integration
2. **video_uid linking**: Each video gets a unique ID to link across platforms
3. **CSV-first approach**: Platform APIs have severe limitations. CSV export is the primary data source

### 2026-02-06: Phase 2-5 Implementation (v1.0)

**What was done:**
- CSV parsers, normalizers, linkers, KPI engine, LLM analyzer, sheet writer
- 223 tests across 6 test suites
- n8n integration documentation
- Sample CSV files

### 2026-02-09: Complete v2.0 Rebuild

**Why v2.0 was needed:**
- v1.0 was analytics-only (CSV import and analysis). It had no concept of video production lifecycle, no component management, and no way to track which content elements contributed to performance.
- v2.0 adds the complete production loop: component inventories, production workflow, approval gates, component-aware AI analysis, and performance scoring.

**What was done:**

- **Phase 1: Foundation**
  - `Config.gs` - Complete rewrite with Drive structure, master columns, component types, ID prefixes, KPI defaults, column aliases, dropdown options, colors
  - `Utils.gs` - Added readSheetAsObjects, findRowByColumn, findAllRowsByColumn, updateRowByIndex, ID generators (generateVideoUid, generateComponentId, generateScenarioId, generateMotionId, generateCharacterId, generateAudioId), getInventoryTypeFromId, getComponentById, getComponentsById
  - `Setup.gs` - One-click system setup: creates Drive folders (Scenarios/Motions/Characters/Audio/Analytics with subfolders), inventory spreadsheets (4 separate spreadsheets), all master sheet tabs, demo data, KPI defaults, formatting (dropdowns, conditional colors, checkbox)
  - `Migration.gs` - v1 to v2 migration (renames videos_master to master, adds new columns, creates video_analysis sheet, updates recommendations schema)

- **Phase 2: Data Layer**
  - `ComponentManager.gs` (NEW) - Component CRUD (addComponent, updateComponent, archiveComponent), listComponents with filters (type/status/tags), getTopPerformingComponents, buildVideoComponentContext, incrementComponentUsage, getComponentPerformanceHistory, buildRecommendationComponentPool
  - `MasterManager.gs` (NEW) - Master sheet operations (createProduction, getVideosByStatus, getApprovedVideos, getProductionData), production workflow (updateVideoStatus, approveVideo), updateMetricsSnapshot, writeAIRecommendations, updateAnalysisResults, getAllVideoUids, getMasterData
  - `ScoreUpdater.gs` (NEW) - updateAllComponentScores, calculateAvgScore, updateComponentScoresForVideo, updateSingleComponentScore, normalizeOverallScore, getScoreSummary

- **Phase 3: Analysis Extension**
  - `LLMAnalyzer.gs` - Rewritten with component-aware prompts (analyzWithLLMEnhanced), includes component history and top performers in AI context, generates component-specific recommendations via separate prompt, single-video analysis with component context
  - `Linker.gs` - Updated for v2.0 master sheet references, added updateMasterMetricsSnapshot
  - `KPIEngine.gs` - Added normalizeOverallScore for cross-platform scoring
  - `SheetWriter.gs` - Added writeToInventory, writeVideoAnalysis, writeRecommendationsEnhanced, clearAllData

- **Phase 4: Integration**
  - `Code.gs` - Complete rewrite with 13 API actions (doGet: get_status, get_approved, get_production, get_components, get_score_summary; doPost: import_csv, analyze, analyze_single, analyze_all, link_videos, create_production, approve_video, update_status, add_component, update_component, get_components, update_scores)
  - UI menu with submenus: Import CSV (YouTube/TikTok/Instagram), Analyze (Single/All), Production (Create/Approve/Status), Components (Add/Browse/Scores)

- **Phase 5: Testing**
  - 3 new test files: ComponentManager.test.js, MasterManager.test.js, ScoreUpdater.test.js
  - Updated all existing tests for v2.0 (master sheet references, removed scenario_cuts)
  - Updated setup.js with all v2.0 utility mocks
  - **330 tests passing across 9 test suites**

- **Phase 6: Documentation**
  - Updated all documentation for v2.0

**Key v2.0 decisions:**
1. **Separate inventory spreadsheets**: Each component type (scenarios, motions, characters, audio) has its own spreadsheet, accessed via `SpreadsheetApp.openById()`
2. **Component ID system**: Prefix-based (SCN_H_, SCN_B_, SCN_C_, MOT_, CHR_, AUD_) for type identification
3. **Production workflow**: draft -> approved -> in_production -> published -> analyzed, with human approval gate
4. **Component-aware AI analysis**: AI receives full component context (history, scores, top performers) when analyzing

### 2026-02-09: v2.0.1 - Checkbox Bug Fix

**Problem:** The `human_approved` checkbox column in the master sheet was causing `getLastRow()` to return 101 instead of 2 (or the actual data row count), because `requireCheckbox()` data validation auto-fills `FALSE` into empty cells, making them appear as data rows.

**Fix:** Changed `applyMasterSheetFormatting_()` to only apply checkbox validation to rows that have actual data (checked `sheet.getLastRow()` before applying), rather than applying to a range of 100 rows.

**Commit:** `62f7400 Fix insertDemoData false positive: checkbox FALSE values triggered data check`

### 2026-02-09: v2.0.2 - appendRow Bug Fix

**Problem:** Because of the checkbox FALSE values filling up to row 101, `sheet.appendRow()` was writing new data at row 102 instead of the next available row after actual data.

**Fix:** Updated `insertDemoData()` to clear any existing rows (including checkbox FALSE values) before writing demo data, and then apply checkbox validation only to the data rows.

**Commit:** `4c36712 Fix checkbox causing appendRow to write at row 101 instead of row 2`

### 2026-02-09: v2.0.3 - Config Sheet Fallback for API Keys

**Problem:** Setting Script Properties via the Apps Script editor is cumbersome, especially for the OpenAI API key. The `_config` sheet in the spreadsheet provides a more accessible way to store configuration.

**What changed:**
- `Config.gs`: Added `getConfigFromSheet_()` function that reads from a `_config` sheet (columns: key, value, description) as a fallback when Script Properties are not set
- `Config.gs`: Added `migrateConfigToProperties()` to migrate _config sheet values to Script Properties
- `OPENAI_API_KEY` now reads from Script Properties first, then falls back to `_config` sheet

### 2026-02-09: v2.0.4 - Web App Access Configuration

**Problem:** The Web App was not accessible externally because `appsscript.json` had `oauthScopes` configured (for bound script) but no `webapp` section. The webapp needed to be accessible without authentication for n8n integration.

**What changed:**
- `appsscript.json`: Replaced `oauthScopes` array with `webapp` configuration:
  ```json
  "webapp": {
    "access": "ANYONE_ANONYMOUS",
    "executeAs": "USER_DEPLOYING"
  }
  ```
- This allows anyone with the deployment URL to access the Web App endpoints
- OAuth scopes are inferred automatically by GAS for bound scripts

### 2026-02-09: OAuth Setup for Google Sheets/Drive API

**Purpose:** Enable Claude Code to directly read/write to Google Sheets and Drive for E2E testing and debugging.

**What was set up:**
- Created OAuth 2.0 credentials in Google Cloud Console (project: video-analytics-hub)
- Created `scripts/gsheet.py` CLI utility for direct Sheets/Drive API access
- Token stored in `.gsheets_token.json` (gitignored)
- OAuth client credentials in `video_analytics_hub_claude_code_oauth.json` (gitignored)
- MCP servers configured in `.mcp.json` for google-workspace and google-sheets integration (gitignored)

### 2026-02-09: E2E Testing Results

**End-to-end testing was performed against the live spreadsheet:**
- Confirmed all 9 sheet tabs exist with correct headers
- Confirmed master sheet has 3 demo videos (2 analyzed, 1 draft)
- Confirmed metrics sheets have data for analyzed videos
- Confirmed KPI targets are set with default values
- Confirmed component inventories are connected and populated with demo data
- All 330 unit tests pass

### 2026-02-09: LLM Analysis Execution (Live Test)

**Live test of the analysis pipeline was verified:**
- OpenAI API key configured via `_config` sheet (auto-migrated to Script Properties)
- `analyzeVideoSingle` and `analyzeAllVideosEnhanced` functions tested via GAS editor execution
- Analysis writes to `video_analysis` and `recommendations` sheets
- Component scores updated after analysis
- AI-recommended components written to `ai_next_*` columns

### 2026-02-09: MANUAL.md Creation

**Created comprehensive Japanese-language user manual (`MANUAL.md`):**
- Complete system overview with architecture diagrams (ASCII art)
- Detailed Google Drive data structure documentation
- All spreadsheet schemas with column descriptions
- Component management workflows
- Video production lifecycle documentation
- CSV import procedures for all 3 platforms
- Analysis and KPI explanation
- AI recommendation and approval flow
- n8n/API integration guide with all endpoint specifications
- GAS menu operation guide
- Troubleshooting section
- Initial setup instructions

### 2026-02-09: v2.1.0 - Documentation Update and .gitignore Hardening

**What was done:**
- Updated CONTEXT.md with complete project history
- Added `.mcp.json` and `tmp/` to `.gitignore` to prevent credential leaks
- Verified all documentation files are consistent with v2.0 codebase
- Committed, pushed, and deployed to Apps Script

---

## Current System State (as of 2026-02-09)

### Deployed and Working
- Master Spreadsheet with all 9 tabs initialized and formatted
- 4 Component Inventory spreadsheets (Scenarios, Motions, Characters, Audio)
- Google Drive folder structure (AI-Influencer root with all subfolders)
- Web App deployed with anonymous access for n8n integration
- OpenAI integration working (via _config sheet fallback)
- Demo data: 3 videos (2 analyzed with metrics, 1 draft)
- Demo components: 7 scenarios, 5 motions, 3 characters, 4 audio
- All 330 tests passing

### Files in Repository
```
gas/
  Code.gs              # Web App endpoints + UI menu (1157 lines)
  Config.gs            # Settings, schema, constants (389 lines)
  Setup.gs             # One-click system setup (762 lines)
  Migration.gs         # v1 to v2 migration (224 lines)
  CSVParser.gs         # Platform-specific CSV parsers (190 lines)
  Normalizer.gs        # Unified schema conversion (208 lines)
  Linker.gs            # video_uid matching (238 lines)
  KPIEngine.gs         # KPI comparison (249 lines)
  LLMAnalyzer.gs       # OpenAI integration (665 lines)
  SheetWriter.gs       # Sheet write operations (275 lines)
  ComponentManager.gs  # Component CRUD + context (283 lines)
  MasterManager.gs     # Master sheet + workflow (255 lines)
  ScoreUpdater.gs      # Component scoring (212 lines)
  Utils.gs             # ID generators, helpers (544 lines)
  appsscript.json      # GAS manifest
  tests/               # 9 test suites, 330 tests

docs/
  USER_GUIDE.md        # Japanese user guide
  n8n-integration.md   # n8n workflow integration guide

MANUAL.md              # Comprehensive Japanese user manual
README.md              # Project README
ARCHITECTURE.md        # System architecture
CONTEXT.md             # This file - project history
scripts/gsheet.py      # Google Sheets CLI utility
```

---

## Technical Notes

### Platform CSV Column Variations

YouTube may change column names between exports. Known variations:
- "Views" / "View count" / "視聴回数"
- "Watch time (hours)" / "総再生時間（時間）"

TikTok variations:
- "Video views" / "Views"
- "Average watch time" / "Avg. watch time"

Instagram variations:
- "Plays" / "Views"
- "Reach" / "Accounts reached"

### GAS Limitations to Remember
- 6-minute execution timeout
- 20MB response size limit
- 100 triggers per user limit
- Properties Service: 500KB total, 9KB per property

### OpenAI Integration Notes
- Use TSV output format for structured responses (more reliable parsing than JSON)
- Batch multiple videos per request to reduce API calls
- Implement exponential backoff for rate limiting
- v2.0: Include component context for better recommendations

### v2.0 Component Score System
- Each analyzed video's overall_score contributes to its components' avg_performance_score
- Scores normalized 0-100 across platforms
- Top-performing components surfaced in AI recommendation prompts
- Score updates cascade: video analyzed -> master updated -> all linked components updated

### Sensitive Data Locations (NOT in git)
- `.clasp.json` - clasp config with Script ID
- `.gsheets_token.json` - OAuth token for Sheets/Drive API
- `video_analytics_hub_*oauth*.json` - OAuth client credentials
- `client_secret_*.json` - Google Cloud client secrets
- `.mcp.json` - MCP server config with OAuth credentials
- `_config` sheet in spreadsheet - contains OpenAI API key
