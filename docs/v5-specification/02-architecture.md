# システムアーキテクチャ

> v5.0のシステム全体構造、各層の設計、データフロー、移行ポイントを詳細に定義する

## 目次

- [1. 全体アーキテクチャ](#1-全体アーキテクチャ)
  - [層間の通信方向](#層間の通信方向)
- [2. データ基盤層](#2-データ基盤層)
  - [2.1 PostgreSQL 16+ (Cloud SQL)](#21-postgresql-16-cloud-sql)
  - [2.2 pgvector拡張](#22-pgvector拡張)
  - [2.3 Google Drive (Shared Drive)](#23-google-drive-shared-drive)
  - [2.4 なぜSheetsからPostgreSQLに移行するのか](#24-なぜsheetsからpostgresqlに移行するのか)
- [3. AIエージェント層](#3-aiエージェント層)
  - [3.1 LangGraph.js v1.0によるオーケストレーション](#31-langgraphjs-v10によるオーケストレーション)
  - [3.2 4つの独立したLangGraphグラフ](#32-4つの独立したlanggraphグラフ)
  - [3.3 グラフ1: 戦略サイクルグラフ (Strategy Cycle)](#33-グラフ1-戦略サイクルグラフ-strategy-cycle)
  - [3.4 グラフ2: 制作パイプライングラフ (Production Pipeline)](#34-グラフ2-制作パイプライングラフ-production-pipeline)
  - [3.5 グラフ3: 投稿スケジューラーグラフ (Publishing Scheduler)](#35-グラフ3-投稿スケジューラーグラフ-publishing-scheduler)
  - [3.6 グラフ4: 計測ジョブグラフ (Measurement Jobs)](#36-グラフ4-計測ジョブグラフ-measurement-jobs)
  - [3.7 グラフ間のDB連携フロー](#37-グラフ間のdb連携フロー)
- [4. MCP Server層](#4-mcp-server層)
  - [4.1 自作MCP Server (Node.js)](#41-自作mcp-server-nodejs)
  - [4.2 MCP Serverの設計原則](#42-mcp-serverの設計原則)
  - [4.3 langchain-mcp-adaptersによる接続](#43-langchain-mcp-adaptersによる接続)
- [5. コンテンツ制作層 (動的レシピアーキテクチャ)](#5-コンテンツ制作層-動的レシピアーキテクチャ)
  - [5.1 content_formatによるワーカー分岐](#51-content_formatによるワーカー分岐)
  - [5.2 動画制作ワーカー (レシピ駆動・コードのみ)](#52-動画制作ワーカー-レシピ駆動コードのみ)
  - [5.3 テキスト制作ワーカー (LLM駆動)](#53-テキスト制作ワーカー-llm駆動)
  - [5.4 制作レシピとツールスペシャリスト](#54-制作レシピとツールスペシャリスト)
  - [5.5 v4.0パイプラインの位置づけ](#55-v40パイプラインの位置づけ)
  - [5.6 動画制作をMCP化しない理由](#56-動画制作をmcp化しない理由)
- [6. ダッシュボード層](#6-ダッシュボード層)
  - [6.1 Next.js + Shadcn/ui](#61-nextjs--shadcnui)
  - [6.2 ダッシュボードの設計方針](#62-ダッシュボードの設計方針)
  - [6.3 エージェント思考ログビューア (Agent Thought Log Viewer)](#63-エージェント思考ログビューア-agent-thought-log-viewer)
  - [6.4 人間↔エージェント対話インターフェース (Human-Agent Dialogue)](#64-人間エージェント対話インターフェース-human-agent-dialogue)
  - [6.5 エージェント進化ダッシュボード (Agent Evolution Dashboard)](#65-エージェント進化ダッシュボード-agent-evolution-dashboard)
  - [6.6 プロンプト管理UI (Prompt Management UI)](#66-プロンプト管理ui-prompt-management-ui)
  - [6.7 推奨プロンプト改善パネル (Prompt Improvement Suggestions)](#67-推奨プロンプト改善パネル-prompt-improvement-suggestions)
  - [6.8 エージェント個別成長トラッキング (Individual Agent Growth Tracking)](#68-エージェント個別成長トラッキング-individual-agent-growth-tracking)
  - [6.9 エージェントからの受信トレイ (Agent Inbox)](#69-エージェントからの受信トレイ-agent-inbox)
  - [6.10 ダッシュボード画面一覧](#610-ダッシュボード画面一覧)
  - [6.11 ダッシュボード機能一覧 (サマリ)](#611-ダッシュボード機能一覧-サマリ)
  - [6.12 キュレーション結果レビュー (Curation Review)](#612-キュレーション結果レビュー-curation-review)
- [7. データフロー図](#7-データフロー図)
  - [7.1 全体データフロー](#71-全体データフロー)
  - [7.2 エージェント共通のデータアクセスパターン](#72-エージェント共通のデータアクセスパターン)
- [8. コンテンツライフサイクル](#8-コンテンツライフサイクル)
  - [8.1 ステータス遷移](#81-ステータス遷移)
  - [8.2 ステータス定義](#82-ステータス定義)
  - [8.3 時間軸とタイムスタンプ](#83-時間軸とタイムスタンプ)
- [9. エラーリカバリーアーキテクチャ](#9-エラーリカバリーアーキテクチャ)
  - [9.1 3段階リカバリーモデル](#91-3段階リカバリーモデル)
  - [9.2 エスカレーションフロー](#92-エスカレーションフロー)
  - [9.3 ダッシュボードでのエラー可視化](#93-ダッシュボードでのエラー可視化)
- [10. コンテンツレビューワークフロー](#10-コンテンツレビューワークフロー)
  - [10.1 レビューフロー概要](#101-レビューフロー概要)
  - [10.2 レビューダッシュボード](#102-レビューダッシュボード)
  - [10.3 自動承認の条件](#103-自動承認の条件)
- [11. システム設定管理（ソフトコーディング原則）](#11-システム設定管理ソフトコーディング原則)
  - [11.1 設計原則](#111-設計原則)
  - [11.2 設定値の読み込みパターン](#112-設定値の読み込みパターン)
  - [11.3 ダッシュボードの設定画面](#113-ダッシュボードの設定画面)
- [12. クレデンシャル管理アーキテクチャ](#12-クレデンシャル管理アーキテクチャ)
  - [12.1 プラットフォーム認証情報](#121-プラットフォーム認証情報)
  - [12.2 ツールAPIキー](#122-ツールapiキー)
  - [12.3 ダッシュボードからの入力フロー](#123-ダッシュボードからの入力フロー)
- [13. 人間介入ポイント一覧](#13-人間介入ポイント一覧)
  - [13.1 介入が必須な箇所（システムが代行不可能）](#131-介入が必須な箇所システムが代行不可能)
  - [13.2 介入が選択可能な箇所（system_settingsで切り替え）](#132-介入が選択可能な箇所system_settingsで切り替え)
  - [13.3 介入の段階的縮小](#133-介入の段階的縮小)
- [14. v4.0からの移行ポイント](#14-v40からの移行ポイント)
  - [14.1 移行対象一覧](#141-移行対象一覧)
  - [14.2 移行アーキテクチャ図](#142-移行アーキテクチャ図)
  - [14.3 段階的移行の順序](#143-段階的移行の順序)
  - [14.4 互換性と並行運用](#144-互換性と並行運用)
- [15. 環境分離設計](#15-環境分離設計)
  - [15.1 環境構成](#151-環境構成)
  - [15.2 DB分離](#152-db分離)
  - [15.3 環境変数管理](#153-環境変数管理)
  - [15.4 デプロイフロー](#154-デプロイフロー)
- [16. コンテナアーキテクチャ](#16-コンテナアーキテクチャ)
  - [16.1 docker-compose構成図](#161-docker-compose構成図)
  - [16.2 コンテナ一覧](#162-コンテナ一覧)
  - [16.3 ボリューム](#163-ボリューム)
  - [16.4 ネットワーク](#164-ネットワーク)
  - [16.5 Phase別の段階的Docker化計画](#165-phase別の段階的docker化計画)

## 1. 全体アーキテクチャ

v5.0は **4層構造** で構成される。上位層が方針を決定し、下位層がデータを蓄積・提供する。全ての層はMCP Serverを介して疎結合に接続される。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│   Layer 1: Human Dashboard (Next.js + Shadcn/ui)                        │
│                                                                         │
│   ┌───────────────┐  ┌────────────────┐  ┌───────────────────────┐      │
│   │ KPI進捗モニタ │  │アルゴリズム精度│  │ 人間介入パネル        │            │
│   │ ・目標 vs 実績│  │・仮説的中率推移│  │ ・仮説の差し込み      │             │
│   │ ・アカウント別│  │ ・学習ログ     │  │ ・参考コンテンツ指定  │             │
│   │ ・日次/週次   │  │ ・改善トレンド │  │ ・計測タイミング変更  │             │
│   └───────────────┘  └────────────────┘  └───────────────────────┘      │
│   ┌─────────────────┐ ┌─────────────────┐ ┌────────────────────────┐    │
│   │ 思考ログ        │ │ エージェント    │ │ プロンプト管理         │         │
│   │ ビューア        │ │ 対話 (1on1)     │ │ ・閲覧/編集            │       │
│   │ ・判断過程可視化│ │ ・個別フィード  │ │ ・バージョン管理       │           │
│   │ ・データ追跡    │ │   バック        │ │ ・効果比較             │        │
│   │ ・サイクル別    │ │ ・全体通知      │ │ ・テンプレート         │          │
│   └─────────────────┘ └─────────────────┘ └────────────────────────┘    │
│   ┌──────────────────────────────────────────────────────────────┐      │
│   │ エージェント進化ダッシュボード                               │           │
│   │ ・蓄積知見数/仮説的中率/品質スコア 時系列推移                │             │
│   │ ・エージェント別パフォーマンス  ・学習停滞/退行アラート      │              │
│   └──────────────────────────────────────────────────────────────┘      │
│   ┌────────────────────────────────┐ ┌─────────────────────────┐        │
│   │エージェント個別成長トラッキング│ │ エージェント受信トレイ  │                │
│   │ ・個別パフォーマンスカード     │ │ ・優先度/未読バッジ     │               │
│   │ ・成長軌跡グラフ               │ │ ・返信→human_directive  │           │
│   │ ・個別学習ブラウザ             │ │ ・週次ダイジェスト      │              │
│   └────────────────────────────────┘ └─────────────────────────┘        │
│                                                                         │
│                         │ Prisma/Drizzle ORM (DB直結)                    │
├─────────────────────────┼───────────────────────────────────────────────┤
│                          ▼                                              │
│   Layer 2: LangGraph.js Orchestration                                   │
│                                                                         │
│   ┌──────────────────────────────────────────────────────────────┐      │
│   │ ┌───────────────┐ ┌─────────────────┐ ┌───────────────────┐  │      │
│   │ │ 戦略サイクル  │ │ 制作パイプライン│ │ 投稿スケジューラー│  │             │
│   │ │グラフ (日次)  │ │ グラフ (連続)   │ │ グラフ (連続)     │  │           │
│   │ └───────┬───────┘ └────────┬────────┘ └─────────┬─────────┘  │      │
│   │         │                  │                    │            │      │
│   │         │           ┌──────┴───────┐            │            │      │
│   │         │           │ 計測ジョブ   │            │            │        │
│   │         │           │ グラフ (連続)│            │            │        │
│   │         │           └──────────────┘            │            │      │
│   │         │                                       │            │      │
│   │         │  ┌───────────────────────────────┐    │            │      │
│   │         │  │ ツールスペシャリスト (Sonnet) │    │            │         │
│   │         │  │AIツール特性把握+レシピ推奨    │    │            │          │
│   │         │  └───────────────────────────────┘    │            │      │
│   │         │                                       │            │      │
│   │         └──────────────────┼────────────────────┘            │      │
│   │                            │ langchain-mcp-adapters          │      │
│   └────────────────────────────┼─────────────────────────────────┘      │
│                                │                                        │
├────────────────────────────────┼────────────────────────────────────────┤
│                                ▼                                        │
│   Layer 3: MCP Server (自作 Node.js, 102ツール)                           │
│                                                                         │
│   ┌────────────────────────────────────────────────────────────────┐    │
│   │ アカウント管理  │ コンテンツ管理 │ 仮説管理 │ 計測管理         │           │
│   │ 投稿管理        │ 戦略管理       │ 知見管理 │ スケジュール管理 │          │
│   │ キャラクター管理│ シナリオ管理   │ 分析管理 │ 設定管理         │           │
│   └────────────────────────────────────────────────────────────────┘    │
│                    │ SQL (pg)                    │ googleapis           │
├────────────────────┼────────────────────────────┼───────────────────────┤
│                    ▼                             ▼                      │
│   Layer 4: Data Stores                                                  │
│                                                                         │
│   ┌──────────────────────────┐    ┌──────────────────────────────┐      │
│   │ PostgreSQL 16+ (Cloud SQL)│    │ Google Drive (Shared Drive)  │      │
│   │                          │    │                              │      │
│   │ ・全構造化データ         │    │ ・動画ファイル (MP4)         │           │
│   │ ・pgvector (類似検索)    │    │ ・キャラクター画像 (PNG)     │          │
│   │ ・タスクキュー           │    │ ・音声ファイル (MP3)         │          │
│   │ ・時系列メトリクス       │    │ ・モーション参照動画         │            │
│   │ ・仮説 + 知見 + embedding│    │ ・アナリティクスCSV          │          │
│   └──────────────────────────┘    └──────────────────────────────┘      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 層間の通信方向

```
                    ┌──────────────────┐
                    │  Human Dashboard │
                    └────────┬─────────┘
                      読み取り│▲書き込み
                 (KPI,ログ等) ││(仮説投入, 設定変更)
                             │▼
                    ┌────────┴─────────┐
                    │   LangGraph.js   │
                    │  (4つのグラフ)     │
                    └────────┬─────────┘
                  MCPツール呼│▲結果返却
                  び出し     ││(JSON)
                             │▼
                    ┌────────┴─────────┐
                    │   MCP Server     │
                    └───┬─────────┬────┘
             SQL実行│                  │ Drive API
                        ▼         ▼
               ┌──────────┐  ┌──────────┐
               │PostgreSQL │  │Google   │
               │           │  │Drive    │
               └──────────┘  └──────────┘
```

**原則**: 上位層は下位層に「何をしたいか」を伝え、下位層は「結果」を返す。エージェントがSQLを直接書くことはない。全てMCPツールの呼び出しで抽象化する。

## 2. データ基盤層

### 2.1 PostgreSQL 16+ (Cloud SQL)

全ての構造化データを一元管理するリレーショナルデータベース。Cloud SQL for PostgreSQLを使用する。

```
┌──────────────────────────────────────────────────────────────┐
│                    PostgreSQL 16+                            │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐     │
│  │ Core Tables                                          │    │
│  │                                                      │    │
│  │  accounts        アカウント情報 (プラットフォーム別) │         │
│  │  characters      キャラクター設定 + Drive file_id    │      │
│  │  components       コンポーネント (シナリオ/モーション等)│      │
│  │  content         コンテンツ (制作ライフサイクル)    │         │
│  │  content_sections セクション構成 (動的N件)           │       │
│  │  publications     投稿記録 (1コンテンツ→N投稿)      │        │
│  └─────────────────────────────────────────────────────┘     │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐     │
│  │ Intelligence Tables                                  │    │
│  │                                                      │    │
│  │  hypotheses       仮説管理 (embedding付き, pgvector) │      │
│  │  market_intel     市場情報統合 (embedding付き)       │      │
│  │  metrics          パフォーマンス計測値 (時系列)     │         │
│  │  analyses         分析結果                         │        │
│  │  learnings        蓄積知見 (embedding付き)          │       │
│  └─────────────────────────────────────────────────────┘     │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐     │
│  │ Operational Tables                                   │    │
│  │                                                      │    │
│  │  cycles              戦略サイクル管理               │        │
│  │  human_directives    人間指示管理                   │       │
│  │  task_queue          タスクキュー                   │        │
│  │  algorithm_performance アルゴリズム精度追跡         │         │
│  └─────────────────────────────────────────────────────┘     │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐     │
│  │ System Management Tables                            │     │
│  │                                                      │    │
│  │  system_settings       システム設定 (ソフトコーディング) │    │
│  └─────────────────────────────────────────────────────┘     │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐     │
│  │ pgvector Extension                                   │    │
│  │                                                      │    │
│  │  hypotheses.embedding   vector(1536)                  │   │
│  │  market_intel.embedding vector(1536)                  │   │
│  │  learnings.embedding    vector(1536)                  │   │
│  │                                                      │    │
│  │  用途: 類似仮説検索、関連知見の自動発見、            │          │
│  │        トレンドの類似性比較                         │        │
│  └─────────────────────────────────────────────────────┘     │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 2.2 pgvector拡張

仮説・知見・市場調査データにベクトル埋め込み (embedding) を付与し、類似検索を可能にする。

| 用途 | テーブル | カラム | 埋め込みモデル | 次元数 |
|---|---|---|---|---|
| 類似仮説の検索 | hypotheses | embedding | text-embedding-3-small or Voyage-3 | 1536 |
| 関連知見の自動発見 | learnings | embedding | 同上 | 1536 |
| 市場調査の類似検索 | market_intel | embedding | 同上 | 1536 |

**検索例**:
- 新しい仮説を生成する際、過去の類似仮説とその検証結果を自動参照
- 「このトレンドに似た過去のトレンド」を発見し、当時のパフォーマンスを参考にする
- ジャンル・テーマ横断で関連する知見を自動クラスタリング

### 2.3 Google Drive (Shared Drive)

動画・画像・音声などのバイナリファイルは引き続きGoogle Driveに保存する。PostgreSQLにはDriveのfile_idを格納し、メタデータとファイル実体を紐付ける。

```
Shared Drive: Product > AI-Influencer (1KRQuZ4W7u5CXRamjvN4xmavfu-7TPb0X)
├── Characters/        キャラクター画像 (PNG)
│   └── CHR_XXXX/      キャラクター別フォルダ
├── Motions/           モーション参照動画
│   └── {tag}/         用途別フォルダ (自由タグで整理)
│       例: Hooks/, Bodies/, CTAs/, Transitions/, FullBody/ 等
│       ※ v4.0のHook/Body/CTA分類は一例。セクション構成はコンテンツごとに異なる
├── Scenarios/         シナリオ関連ファイル
├── Audio/             音声ファイル
├── Productions/       制作済み動画
│   └── YYYY-MM-DD/    日付別
│       └── CNT_YYYYMM_XXXX/  コンテンツ別
│           ├── section_01.mp4    セクション連番
│           ├── section_02.mp4    (数はコンテンツにより異なる)
│           ├── section_03.mp4
│           └── final.mp4
└── Analytics/         分析CSV (レガシー、段階的廃止)
```

**PostgreSQLとDriveの紐付け**:

```
PostgreSQL                              Google Drive
┌──────────────────────┐               ┌──────────────────  ┐
│ characters           │               │ Characters/        │
│  id: CHR_0001        │──drive_file_id──>│ CHR_0001/       │
│  drive_file_id: 1zAZ │               │   image.png        │
│  name: "Hana"        │               │                    │
└──────────────────────┘               └──────────────────  ┘

┌──────────────────────┐               ┌──────────────────  ┐
│ content             │               │ Productions/        │
│  id: CNT_202602_0001 │──drive_folder_id─>│ 2026-02-10/    │
│  drive_folder_id: .. │               │   CNT_202602_0001/ │
│  status: "ready"     │               │     final.mp4      │
└──────────────────────┘               └──────────────────  ┘

┌──────────────────────┐    1:N         ┌────────────────── ┐
│ content             │──────────────>│ publications        │
│  id: CNT_202602_0001 │               │                    │
│                      │               │  pub#1: YouTube    │
│  (1つのコンテンツが  │               │  pub#2: TikTok       │
│   複数プラットフォーム│               │  pub#3: Instagram    │
│   に投稿される)      │               └────────┬─────────    ┘
└──────────────────────┘                        │ 1:N
                                        ┌───────▼───────── ┐
                                        │ metrics          │
                                        │                  │
                                        │  各publicationの  │
                                        │  パフォーマンス    │
                                        │  (時系列計測)      │
                                        └──────────────────┘
```

### 2.4 なぜSheetsからPostgreSQLに移行するのか

v4.0ではGoogle Sheetsを全データの管理基盤として使用していた。v5.0でPostgreSQLに移行する理由を以下に整理する。

| 観点 | Google Sheets (v4.0) | PostgreSQL (v5.0) | 移行の必要性 |
|---|---|---|---|
| **横断クエリ** | 5つの独立したSpreadsheet。JOIN不可。inventory-reader.jsで個別にフェッチし、コード内で結合 | 全テーブルをSQLのJOINで横断クエリ。1クエリで「このキャラの過去30日の全投稿パフォーマンス」を取得可能 | AIエージェントが自律的に分析するには横断クエリが必須 |
| **時系列分析** | タイムスタンプのフィルタリングはGASコードで手動実装。日付範囲指定が困難 | `WHERE posted_at BETWEEN ... AND ...` + ウィンドウ関数 (`LAG`, `LEAD`, `MOVING AVG`) で時系列分析がネイティブ | 「先週vs今週」「30日移動平均」等の分析が頻繁に必要 |
| **ACID保証** | シートの同時編集でデータ破損のリスク。トランザクションなし | ACID準拠のトランザクション。制作・投稿・計測の同時並行でもデータ整合性を保証 | 複数エージェントが同時にDB操作する前提 |
| **スケール耐性** | Sheets API: 300リクエスト/分。3,500アカウント運用時にレート制限に到達 | PostgreSQL: 数万行/秒のスループット。インデックスで高速検索 | KPI目標 3,500アカウント/日に対応 |
| **ベクトル検索** | 不可能。類似仮説の検索はコード内でコサイン類似度を計算する必要がある | pgvectorで `ORDER BY embedding <=> $1 LIMIT 10` と書くだけ | 仮説駆動サイクルの中核機能 |
| **型安全性** | 全カラムが文字列。数値・日付・配列は全てテキスト表現 | カラム型 (INTEGER, TIMESTAMP, JSONB, vector) を厳密に定義。ORMで型安全 | LLMが扱うデータの品質向上 |

## 3. AIエージェント層

### 3.1 LangGraph.js v1.0によるオーケストレーション

全エージェントの実行制御はLangGraph.js v1.0が担う。エージェントを「ノード」、状態遷移を「エッジ」としてグラフを定義する。

**LangGraphの採用理由** (詳細は [01-tech-stack.md](https://github.com/Ceed-dev/ai-influencer/blob/main/docs/v5-specification/01-tech-stack.md#%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%83%AF%E3%83%BC%E3%82%AF%E9%81%B8%E5%AE%9A%E3%81%AE%E6%AF%94%E8%BC%83%E7%B5%90%E6%9E%9C) を参照):
- 唯一のv1.0 GA安定版
- Supervisorパターン + 階層Supervisorが公式サポート
- 耐久実行 (Durable Execution): 12分の動画生成中にプロセスが落ちてもチェックポイントから再開
- JS/TS公式サポート

### 3.2 4つの独立したLangGraphグラフ

v5.0は **4つの独立したグラフ** で構成される。各グラフは独立して実行され、**PostgreSQLを通じてのみ連携**する（直接通信しない）。

```
┌──────────────────────────────────────────────────────────────────────┐
│                      LangGraph.js Runtime (PM2管理)                   │
│                                                                      │
│  ┌────────────────┐ ┌────────────────────┐ ┌──────────────────────┐  │
│  │ 1. 戦略サイクル│ │ 2. 制作パイプライン│ │ 3. 投稿スケジューラー│         │
│  │    グラフ      │ │    グラフ          │ │    グラフ            │     │
│  │    (日次実行)  │ │    (連続実行)      │ │    (連続実行)        │      │
│  │                │ │                    │ │                      │  │
│  │ Opus + Sonnet×3│ │ Sonnet×N           │ │ Sonnet×N             │  │
│  └────────┬───────┘ └──────────┬─────────┘ └───────────┬──────────┘  │
│           │                    │                       │             │
│           │             ┌──────┴─────────┐             │             │
│           │             │ 4. 計測ジョブ  │             │               │
│           │             │    グラフ      │             │              │
│           │             │    (連続実行)  │             │              │
│           │             │                │             │             │
│           │             │ Sonnet×N       │             │             │
│           │             └──────┬─────────┘             │             │
│           │                    │                       │             │
│           └────────────────────┼───────────────────────┘             │
│                                │                                     │
│           ┌───────────────────────────────────────────────┐          │
│           │ ツールスペシャリスト (Sonnet)                 │             │
│           │ ・AIツールの特性・クセを把握                  │              │
│           │ ・コンテンツ制作に最適なツール組み合わせを推奨│                 │
│           │ ・制作パイプライングラフの動的レシピ生成      │                │
│           └───────────────────────────────────────────────┘          │
│                                                                      │
│           ┌───────────────────────────────────────────────┐          │
│           │ データキュレーター (Sonnet)                    │            │
│           │ ・生データの構造化・コンポーネント自動生成    │                 │
│           │ ・リサーチャー/人間からの生データをキュー処理  │                │
│           │ ・重複検出・品質スコア初期設定                │               │
│           └───────────────────────────────────────────────┘          │
│                                │                                     │
│                    全グラフ共通: MCP Server経由でDB読み書き              │
│                    グラフ間通信: なし (DBのステータス変更で間接連携)        │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

**グラフ間の間接連携の例**:
1. 戦略サイクルグラフが `content` テーブルにステータス `planned` のレコードを作成
2. 制作パイプライングラフが `planned` ステータスの行をポーリングして検出し、制作を開始
3. 制作完了で `ready` に更新
4. 投稿スケジューラーグラフが `ready` のコンテンツを検出し、`publications` テーブルに投稿先アカウント分のレコードを作成（1コンテンツ→N件）、スケジュールに従って各プラットフォームに投稿
5. 各 `publication` の投稿完了で `posted` に更新、`posted_at` を記録
6. 計測ジョブグラフが各 `publication` の `posted_at + 48h` を過ぎた行を検出し、プラットフォーム別にメトリクスを収集

### 3.3 グラフ1: 戦略サイクルグラフ (Strategy Cycle)

**実行頻度**: 日次 (1日1回)
**目的**: 市場データを分析し、仮説を生成し、コンテンツ制作計画を策定する

```
                    ┌──────────────┐
                    │    START     │
                    └──────┬───────┘
                           │
                           ▼
              ┌─────────────────────────┐
              │  市場データ収集        │  リサーチャー (Sonnet)
              │                         │
              │  ・トレンドAPI取得     │  MCPツール:
              │  ・競合データ取得      │   get_trending_topics
              │・過去パフォーマンス取得│   get_competitor_data
              │  ・類似市場調査を検索  │   search_similar_research
              │    (pgvector)          │   get_performance_summary
              └────────────┬────────────┘
                           │
                           ▼
              ┌─────────────────────────┐
              │  仮説生成              │  アナリスト (Sonnet)
              │                         │
              │  ・過去仮説の的中率参照│  MCPツール:
              │  ・類似仮説をpgvectorで│   get_hypothesis_accuracy
              │    検索して重複回避    │   search_similar_hypotheses
              │  ・新仮説をDB保存      │   create_hypothesis
              │  ・embedding付与       │   get_recent_insights
              └────────────┬────────────┘
                           │
                           ▼
              ┌─────────────────────────┐
              │  計画策定              │  プランナー (Sonnet)
              │                         │
              │  ・仮説に基づく        │  MCPツール:
              │    コンテンツ計画作成  │   create_content_plan
              │ ・アカウント×シナリオの│   get_available_accounts
              │    マッチング          │   get_scenarios
              │  ・planned_post_date   │   assign_scenario_to_account
              │    の設定              │   set_planned_date
              └────────────┬────────────┘
                           │
                           ▼
              ┌─────────────────────────┐
              │  計画承認              │  戦略Agent (Opus)
              │                         │
              │  ・計画の妥当性レビュー│  MCPツール:
              │  ・コスト上限チェック  │   review_plan
              │  ・承認 → planned      │   approve_plan
              │    (または pending_   │   reject_plan
              │     approval)         │   save_insight
              │ ・差戻 → 計画策定に戻る    │
              │  ・知見の要約と保存        │
              └────────────┬────────────┘
                           │
                     ┌─────┴──────┐
                     │            │
          承認       │         差戻│ (rejection_category)
                     ▼            │
         ┌───────────────────────┐ │
         │ REQUIRE_HUMAN_APPROVAL│ │
         │ = true ?              │ │
         └───────────┬───────────┘ │
                     │            │
               ┌─────┴──────┐     │
               │            │     │
           true│       false│     │
               ▼            ▼     │
    ┌──────────────┐ ┌──────────┐  │
    │ 人間承認     │ │   END    │   │
    │              │ │ (DB更新: │   │
    │ ・DB更新:    │ │  planned) │  │
    │  pending_    │ └──────────┘  │
    │  approval    │               │
    │ ・Dashboard  │               │
    │  で計画一覧  │                 │
    │  を表示      │                │
    │ ・人間が     │                │
    │  承認/差戻   │                │
    │  (+カテゴリ) │                │
    └──────┬───────┘               │
           │                      │
     ┌─────┴──────┐               │
     │            │               │
  承認│      差戻  │               │
     ▼            │               │
┌──────────┐      │               │
│   END    │      │               │
│ (DB更新: │      │                │
│  planned) │      │              │
└──────────┘      │               │
                   ▼               ▼
          差戻しカテゴリに応じたルーティング:
            plan_revision    → 計画策定ノードに戻る
            data_insufficient → 市場データ収集に戻る
            hypothesis_weak  → 仮説生成に戻る
```

**参加エージェントとLLMモデル**:

| エージェント | LLMモデル | 役割 | 判断の重さ |
|---|---|---|---|
| 戦略Agent | Claude Opus 4.6 | 最終承認・方針決定 | 高 (コスト判断、品質基準) |
| リサーチャー | Claude Sonnet 4.5 | 市場データ収集・整理 | 低 (データ取得が主) |
| アナリスト | Claude Sonnet 4.5 | 仮説生成・分析 | 中 (パターン認識) |
| プランナー | Claude Sonnet 4.5 | 制作計画の具体化 | 中 (リソース配分) |
| ツールスペシャリスト | Claude Sonnet 4.5 | AIツール特性把握・最適レシピ推奨 | 中 (ツール選定・組合せ最適化) |
| データキュレーター | Claude Sonnet 4.5 | 生データの構造化・コンポーネント自動生成 | 中 (データ分類・品質判定) |

**ツールスペシャリストの役割**:

ツールスペシャリストは、動画生成・画像生成・音声合成・リップシンク等のAIツールの特性やクセを深く理解し、コンテンツ制作の品質を最大化するためのツール組み合わせ (レシピ) を推奨するエージェントである。

| 観点 | 説明 |
|---|---|
| **ツール知識の蓄積** | 各AIツール (Kling, Fish Audio, Lipsync等) の得意/不得意・パラメータ制約・出力品質の傾向をDBに蓄積 |
| **レシピ推奨** | コンテンツの種別・セクション構成・ジャンル・キャラクター特性に応じた最適なツール組み合わせを動的に推奨 |
| **新ツール評価** | 新しいAIツールやモデルバージョンが登場した際に、既存レシピとの比較検証を設計 |
| **失敗分析** | 制作失敗時のエラーパターンを分析し、ツール固有の回避策を知見として蓄積 |
| **制作ワーカーへの指示** | 推奨レシピを制作パイプライングラフに渡し、動的にツールフローを構成 |

### 3.4 グラフ2: 制作パイプライングラフ (Production Pipeline)

**実行頻度**: 連続 (ポーリング)
**目的**: `planned` ステータスのコンテンツを検出し、`content_format` に応じて適切なワーカーにディスパッチする
**同時実行**: N個のコンテンツを並行制作可能 (設定値 `MAX_CONCURRENT_PRODUCTIONS` で上限管理)

v4.0では固定フロー (Kling→Fish Audio→Lipsync→ffmpeg) だったが、v5.0ではツールスペシャリストが **戦略サイクルグラフで事前に** 推奨した **動的レシピ** (`content.recipe_id`) に基づいてツールフローを構成する。制作ワーカーは **動画制作ワーカー** と **テキスト制作ワーカー** の2分類に分かれる。

また、v4.0では固定3セクション (Hook/Body/CTA) だったが、v5.0ではセクション数・種類をコンテンツごとに **動的に決定** する。プランナーがコンテンツ種別・プラットフォーム・ターゲット層に応じた最適なセクション構成を `plan_content` で定義し、ツールスペシャリストはそのセクション構成を受け取って各セクションに最適なツールレシピを割り当てる (この選定は戦略サイクルグラフの `select_tools` ノードで行われ、制作パイプライングラフに入る時点では `recipe_id` が確定済み)。

> **注**: ツールスペシャリストによる制作レシピ選定は **戦略サイクルグラフ** (§3.3) の `select_tools` ノードで実行される。制作パイプライングラフでは、事前に確定した `recipe_id` を読み込んで実行するのみ。詳細は [04-agent-design.md §5.2](04-agent-design.md#52-グラフ2-制作パイプライングラフ-production-pipeline-graph) を参照。

```
              ┌──────────────┐
              │    START     │
              └──────┬───────┘
                                                   │
                     ▼
          ┌──────────────────────────────────────────────────────┐
          │  タスク取得                                            │
          │                    │  MCPツール:
          │  status='planned'  │   get_production_task
          │  のコンテンツを検索                                     │
          │  (最大N件を同時取得│  設定: MAX_CONCURRENT_PRODUCTIONS
          │   現在の処理数を   │  デフォルト: 10
          │   差し引いて取得)                                      │
          │                    │  なければ待機 (30秒sleep)
          └────────┬─────────────────────────────────────────────┘
                     │
            タスクあり│         タスクなし
                   │ │
                   ▼              ▼
          ┌────────────────┐  ┌────────                          ┐
          │ データ取得      │  │ 待機   │──→ タスク取得に戻る
          │                │  └────────                          ┘
          │ キャラクター情報│  MCPツール:
          │ コンポーネント  │   get_character_info
          │ データを取得    │   get_component_data (xN)
          │ → status=       │   update_content_status
          │   'producing'   │     → status='producing'
          └────────┬─────────────────────────────────────────────┘
                     │
                   ▼
          ┌──────────────────────────────────────────────────────┐
          │ content_format                                       │
          │ ディスパッチ                                           │
          │                                                      │
          │ content_format で                                    │
          │ ワーカーを振り分け                                      │
          └────────┬─────────────────────────────────────────────┘
                     │
    ┌──────────────┴──────────────┐
    │                             │
  short_video                  text_post
    │                             │
    ▼                             ▼
          ┌───────────────────────┐    ┌───────────────────────  ┐
          │ 動画制作ワーカー      │    │ テキスト制作ワーカー          │
          │ (コードのみ、LLMなし) │    │ (LLM: Sonnet)             │
          │                       │    │                         │
          │ recipe_id から        │    │ X投稿/キャプション等       │
          │ production_recipes    │    │                         │
          │ .stepsを読み込み      │    │ ・LLMによるテキスト生成      │
          │                       │    │ ・キャラ性格の反映         │
          │ ┌───────────────────┐ │    │ ・プラットフォーム別       │
          │ │ Promise.all       │ │    │   フォーマット調整        │
          │ │ (Nセクション並列) │ │    │                           │
          │ │                   │ │    │ MCPツール:               │
          │ │ content_sections  │ │    │  update_content_status  │
          │ │ テーブルで定義    │ │    │  (#10で結果書戻し)          │
          │ │ されたN個の       │ │    └───────────┬───────────    ┘
          │ │ セクションを      │ │                                │
          │ │ 並列実行          │ │                               │
          │ │                   │ │                              │
          │ │ ※ ツール名は     │ │                                 │
          │ │   レシピで指定    │ │                                │
          │ │  (Kling/Runway等) │ │                              │
          │ └───────────────────┘ │                              │
          │          │            │                              │
          │          ▼            │                              │
          │ ffmpeg concat         │                              │
          │ + 黒フレーム検証      │                                │
          │          │            │                              │
          │          ▼            │                              │
          │ Google Drive 保存     │                               │
          └──────────┬────────────┘                              │
                     │                             │
                     └──────────────┬──────────────┘
                                    │
                               ┌────┴────┐
                             成功      失敗
                               │         │
                               ▼         ▼
          ┌────────────────────────┐  ┌──────────────────        ┐
          │ 品質チェック           │  │ エラー処理                  │
          │                        │  │                          │
          │  動画: ファイルサイズ   │  │ error_message記録          │
          │    黒フレーム検出      │  │ retry_count確認             │
          │    Drive保存確認       │  │                           │
          │  テキスト: 文字数      │  │ リトライ可能 →               │
          │    キャラ一貫性        │  │   task再キュー              │
          │  → ツールSPへのFB記録  │  │ 不可 → failed               │
          │                        │  │                          │
          │  合格 → status='ready' │  └────────┬─────────         ┘
          │  不合格 → status=      │                              │
          │    'failed' + エラーログ│                              │
          └────────────┬───────────┘                             │
                       │                       │
                       └──────────┬────────────┘
                                  │
                                  ▼
                           タスク取得に戻る
```

**マルチ動画並行制作**:

v5.0では1日の投稿数が大量になるため、複数のコンテンツを同時並行で制作する。

```
                      制作パイプライングラフ
                              │
                ┌─────────────┼─────────────┐
                │             │             │
                ▼             ▼             ▼
         ┌──────────┐  ┌──────────┐  ┌──────────┐   ... 最大N個
         │ CNT_0001 │  │ CNT_0002 │  │ CNT_0003 │       (設定値)
         │          │  │          │  │          │
         │ 3 sect.  │  │ 2 sect.  │  │ 4 sect.  │
         │ 並列実行 │  │ 並列実行 │  │ 並列実行     │
         └──────────┘  └──────────┘  └──────────┘

  例: MAX_CONCURRENT_PRODUCTIONS = 10 の場合
  → 最大10動画が同時に制作される
  → 各動画内のセクションも並列実行
  → 合計プロセス数 = 動画数 × 平均セクション数
     (例: 10動画 × 3セクション = 30並列プロセス)
```

| 設定値 | 説明 | デフォルト |
|---|---|---|
| `MAX_CONCURRENT_PRODUCTIONS` | 同時制作可能な動画数の上限 | 10 |
| `PRODUCTION_POLL_INTERVAL` | タスク取得のポーリング間隔 (秒) | 30 |
| `MAX_RETRIES_PER_SECTION` | セクション制作失敗時の最大リトライ | 3 |
| `REQUIRE_HUMAN_APPROVAL` | 人間によるコンテンツ計画の承認を必須にする | `true` (Phase 1) |

**REQUIRE_HUMAN_APPROVALについて**:
- **Phase 1 (初期)**: `true` — Opus承認後、`pending_approval` ステータスでダッシュボードに表示。人間が最終承認して `planned` に遷移する。AIの判断基準を人間が学習・検証する期間
- **Phase 2 (安定期)**: `false` — Opusが承認すると直接 `planned` に遷移 (現行フロー)。ただし高コスト案件や新ジャンルは人間承認を維持する運用も可能

**v4.0→v5.0の制作パイプライン変更点**:

| 項目 | v4.0 (固定フロー) | v5.0 (動的レシピ) |
|---|---|---|
| ツール選定 | 固定 (Kling→Fish Audio→Lipsync→ffmpeg) | ツールスペシャリストが推奨するレシピに基づく動的選定 |
| セクション構成 | 固定3分割 (Hook/Body/CTA) | 動的N分割 (プランナーがコンテンツ種別に応じて決定) |
| 同時制作数 | 1動画ずつ (セクション内は並列) | N動画同時制作 (MAX_CONCURRENT_PRODUCTIONS, デフォルト10) |
| 対応コンテンツ | 動画のみ | 動画 + テキスト (X投稿、キャプション等) |
| ワーカー分類 | なし (単一パイプライン) | 動画制作ワーカー / テキスト制作ワーカー |
| ツール知識 | コードにハードコード | DBに蓄積 (ツール特性・成功率・回避策) |
| 失敗時の対応 | リトライのみ | ツールスペシャリストが失敗パターンを分析し、代替レシピを推奨 |

### 3.5 グラフ3: 投稿スケジューラーグラフ (Publishing Scheduler)

**実行頻度**: 連続 (ポーリング)
**目的**: `ready` ステータスのコンテンツを適切なタイミングで各プラットフォームに投稿する

**1:N投稿モデル**: 1つのコンテンツは複数のアカウント・プラットフォームに投稿される。例えばキャラクターAがYouTube + TikTok + Instagramの3アカウントを持つ場合、1つの動画を3プラットフォームに投稿する。`publications` テーブルでコンテンツと投稿先の関係を管理する。

```
              ┌──────────────┐
              │    START     │
              └──────┬───────┘
                     │
                     ▼
          ┌────────────────────────┐
          │  投稿対象の検出        │  MCPツール:
          │                        │   get_ready_content
          │  ・status='ready' の   │   get_content_target_accounts
          │    コンテンツを検出    │   get_account_posting_rules
          │  ・対象アカウントの       │
          │    一覧を取得            │
          │    (1コンテンツ→N件)     │
          │  ・各アカウントの        │
          │    投稿制限チェック      │
          │  ・最適投稿時間帯確認     │
          └────────────┬───────────┘
                                 │
                投稿対象あり│      なし
                       │         │
                       ▼         ▼
          ┌──────────────────┐  ┌──────── ┐
          │ publication作成  │  │ 待機   │──→ 投稿対象の検出に戻る
          │ + 投稿実行       │  └────────  ┘
          │                        │
          │ 各アカウントに対し│  MCPツール:
          │ publicationを作成│   create_publication
          │ してから投稿:            │
          │                  │  (v4.0の投稿アダプターを再利用)
          │  ・YouTube             │
          │  ・Instagram           │
          │  ・TikTok              │
          │  ・X/Twitter           │
          │                        │
          │ ※同一コンテンツの        │
          │  複数投稿を並列実行       │
          └────────┬───────────────┘
                   │
                   ▼
          ┌────────────────────────┐
          │  結果記録 (per pub.) │  MCPツール:
          │                      │   record_post_result
          │  publication単位:    │   update_publication_status
          │  ・status = 'posted' │   set_measure_after
          │  ・posted_at記録        │
          │  ・platform_post_id    │
          │  ・measure_after設定    │
          │    (posted_at + 48h)   │
          │                        │
          │  ※contentのstatusは     │
          │   変更しない             │
          │   (readyのまま維持)      │
          └──────────┬─────────────┘
                     │
                     ▼
              投稿対象の検出に戻る
```

### 3.6 グラフ4: 計測ジョブグラフ (Measurement Jobs)

**実行頻度**: 連続 (ポーリング)
**目的**: 投稿後一定時間が経過した各 `publication` のパフォーマンスをプラットフォームAPIから包括的に計測する

```
              ┌──────────────┐
              │    START     │
              └──────┬───────┘
                     │
                     ▼
          ┌──────────────────────────────────┐
          │  計測対象検出          │  MCPツール:
          │                        │   get_publications_needing_measurement
          │  ・publications.status           │
          │    = 'posted'                    │
          │ ・NOW() > measure_after          │
          │  ・まだ計測されていない             │
          │    or 追加計測時期到来             │
          └────────────┬─────────────────────┘
                                 │
                対象あり │      なし
                       │         │
                       ▼         ▼
          ┌──────────────────┐  ┌────────    ┐
          │  メトリクス収集  │  │ 待機   │──→ 計測対象検出に戻る
          │                  │  └────────    ┘
          │  プラットフォーム別に│  MCPツール:
          │  API経由で包括取得:  │   fetch_youtube_metrics
          │                      │   fetch_tiktok_metrics
          │  (詳細は下表参照)    │   fetch_instagram_metrics
          │                      │   fetch_x_metrics
          └────────┬─────────────────────────┘
                   │
                   ▼
          ┌──────────────────────────────────┐
          │  DB保存              │  MCPツール:
          │                      │   save_metrics
          │  ・metricsテーブルに │   update_publication_status
          │    構造化データ保存                │
          │  ・raw_dataに生APIレスポンス保存    │
          │  ・platform_dataに                │
          │    プラットフォーム                │
          │    固有メトリクス保存               │
          │  ・次回計測日設定                  │
          │    (48h, 7日, 30日)               │
          └──────────┬───────────────────────┘
                     │
                     ▼
              計測対象検出に戻る
```

**計測タイミング**: 1つのpublicationに対して最大3回計測する

| 計測回 | タイミング | 目的 |
|---|---|---|
| 1回目 | posted_at + 48h | 初動パフォーマンスの計測 |
| 2回目 | posted_at + 7日 | 中期パフォーマンス (推薦アルゴリズム反映後) |
| 3回目 | posted_at + 30日 | 長期パフォーマンス (最終結果) |

**プラットフォーム別取得メトリクス**:

| カテゴリ | YouTube (Analytics API) | TikTok (API v2) | Instagram (Graph API) | X (API v2) |
|---|---|---|---|---|
| **基本指標** | views, estimatedMinutesWatched | view_count | plays, impressions | impression_count |
| **エンゲージメント** | likes, comments, shares | like_count, comment_count, share_count | likes, comments, shares, saves | like_count, reply_count, retweet_count, quote_count, bookmark_count |
| **視聴行動** | averageViewDuration, averageViewPercentage | — (APIでは非公開) | ig_reels_avg_watch_time (ms), completion_rate | — |
| **リテンション** | audienceWatchRatio (秒単位の視聴維持率カーブ) | — | forward_taps, backward_taps, drop_off | — |
| **リーチ** | impressions, impressionClickThroughRate | — | reach (ユニークユーザー) | — |
| **トラフィック** | insightTrafficSourceType (検索/推薦/外部等) | — | — | url_link_clicks, user_profile_clicks |
| **フォロワー** | subscribersGained, subscribersLost | — | — | — |
| **デモグラフィック** | ageGroup, gender, country (レポートAPI) | — (限定的) | — (アカウントレベル) | — |
| **動画固有** | — | — | skip_rate (3秒以内離脱率), repost_count | video_view_count |
| **クロスプラットフォーム** | — | — | crossposted_views, facebook_views | — |
| **収益** | estimatedRevenue, estimatedAdRevenue | — | — | — |

**各メトリクスの活用例** (AIアナリストの分析パターン):

| メトリクス | 分析パターン | アクション例 |
|---|---|---|
| `audienceWatchRatio` (YT) | 秒単位で離脱ポイントを特定 | 「15秒地点で40%が離脱 → このセクションを別の素材に差し替え」 |
| `ig_reels_avg_watch_time` | 平均視聴時間の変化を追跡 | 「avg 3.2s → 4.8s: hookの改善が効果的」 |
| `skip_rate` (IG) | 3秒以内離脱率を監視 | 「skip_rate 65% → hook部分の強化が急務」 |
| `completion_rate` (IG) | 完視聴率とセクション構成の相関 | 「3セクション構成より2セクション構成の方が完視聴率1.3倍」 |
| `insightTrafficSourceType` (YT) | 流入経路別のパフォーマンス差 | 「検索流入は推薦流入よりER 2倍 → SEO最適化を強化」 |
| `subscribersGained` (YT) | 投稿→チャンネル登録の変換率 | 「CTA強化版は登録率1.5倍 → CTA改善の仮説を confirmed」 |

### 3.7 グラフ間のDB連携フロー

4つのグラフは互いに直接通信しない。全ての連携はPostgreSQLのステータス遷移を通じて行われる。

**ステータス管理の2層構造**:
- `content.status`: 制作ライフサイクル (`pending_approval` → `planned` → `producing` → `ready`)
  - 注: `pending_approval` は `REQUIRE_HUMAN_APPROVAL=true` の場合のみ使用。`false` の場合は `planned` から開始
- `publications.status`: 各投稿先のライフサイクル (`scheduled` → `posted` → `measured`)

1つのコンテンツが `ready` になった後、N件の `publications` が作成され、それぞれが独立してステータス遷移する。

```
戦略サイクル          制作パイプライン        投稿スケジューラー       計測ジョブ
グラフ               グラフ                グラフ                グラフ
    │                    │                    │                    │
    │ content.status     │                    │                    │
    │ = 'pending_approval'│                   │                    │
    │  (REQUIRE_HUMAN_   │                    │                    │
    │   APPROVAL=true時) │                    │                    │
    │                    │                    │                    │
    │ 人間がDashboardで  │                    │                     │
    │ 承認               │                    │                     │
    │ → content.status   │                    │                    │
    │   = 'planned'      │                    │                    │
    │                    │                    │                    │
    │ content.status     │                    │                    │
    │ = 'planned'        │                    │                    │
    ├──────────────────>│                    │                     │
    │   (contentに書込) │ content.status      │                     │
    │                    │ = 'producing'      │                    │
    │                    ├─ (status更新)      │                     │
    │                    │                    │                    │
    │                    │ content.status      │                   │
    │                    │ = 'ready'          │                    │
    │                    ├──────────────────>│                     │
    │                    │   (contentに書込) │ publications作成      │
    │                    │                    │ (N件、各platformに  │
    │                    │                    │  1レコードずつ)      │
    │                    │                    ├─ pub.status        │
    │                    │                    │  = 'scheduled'     │
    │                    │                    │                    │
    │                    │                    │ pub.status         │
    │                    │                    │ = 'posted'         │
    │                    │                    ├──────────────────> │
    │                    │                    │  (各pubに書込)      │
    │                    │                    │                    │ pub.status
    │                    │                    │                    │ = 'measured'
    │                    │                    │                    ├─(status更新)
    │                    │                    │                    │
    │                    │                    │                    │ content.status
    │                    │                    │                    │ = 'analyzed'
    │<───────────────────────────────────────────────────────────  ┤
    │   (次サイクルで分析結果を読み取り、次の仮説生成に反映)               │
    │                    │                    │                    │
    ▼                    ▼                    ▼                    ▼
─────────────────────────────────────────────────────────────────────
                        PostgreSQL (共有データストア)
```

**ステータス遷移のまとめ**:

| テーブル | ステータス遷移 | 担当グラフ |
|---|---|---|
| `content` | `pending_approval` → `planned` → `producing` → `ready` → `analyzed` | 戦略(→Dashboard承認)→制作→(投稿+計測完了後)→戦略 |
| `publications` | `scheduled` → `posted` → `measured` | 投稿スケジューラー→計測ジョブ |

> **注**: `pending_approval` → `planned` の遷移は `REQUIRE_HUMAN_APPROVAL=true` の場合のみ。`false` の場合、戦略サイクルグラフが直接 `planned` を設定する。

### 3.8 データキュレーター (Data Curator)

**実行方式**: 非同期・連続実行 (キューポーリング)
**目的**: リサーチャーや人間から受け取った生データを、適切に分解・構造化・分類して `components` テーブル等に保存する

v4.0では人間が手動でシナリオ・モーション・音声等のインベントリを作成していたが、KPI 3,500アカウントの規模では非現実的。データキュレーターが生データを自動的にコンポーネントに変換することで、全自動パイプラインを実現する。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    データキュレーションフロー                               │
│                                                                         │
│  入力ソース                          処理                出力              │
│                                                                         │
│  ┌──────────────┐                                                       │
│  │ リサーチャー   │─── 市場データ                                          │
│  │ (自動)        │    (トレンド、競合投稿、参考コンテンツ)                    │
│  └──────────────┘         │                                             │
│                            ▼                                            │
│  ┌──────────────┐    ┌─────────────────────────┐   ┌──────────────┐     │
│  │ 人間          │───>│ task_queue               │──>│データ         │    │
│  │ (ダッシュボード│    │ (type='curate')          │   │キュレーター   │     │
│  │  から参考動画/ │    │                          │   │ (Sonnet)     │    │
│  │  参考投稿提出) │    │ キューをポーリング        │   │              │      │
│  └──────────────┘    └─────────────────────────┘   │ ・生データ分析 │     │
│                                                     │ ・構造化      │    │
│  ┌──────────────┐                                   │ ・重複チェック │    │
│  │ アナリスト    │─── スコア分析に基づく改良指示     │ ・品質判定    │         │
│  │ (推奨)       │                                   └──────┬───────┘     │
│  └──────────────┘                                          │            │
│                                                            ▼            │
│                                                   ┌──────────────┐      │
│                                                   │ components    │     │
│                                                   │ テーブル       │     │
│                                                   │               │     │
│                                                   │ type=scenario │     │
│                                                   │ type=motion   │     │
│                                                   │ type=audio    │     │
│                                                   │ type=image    │     │
│                                                   │               │     │
│                                                   │ + 品質スコア   │      │
│                                                   │   初期値設定   │      │
│                                                   └──────────────┘      │
│                                                                         │
│  人間レビュー (初期フェーズ):                                               │
│  ┌──────────────────────────────────────────────────────────────┐       │
│  │ REQUIRE_AUTO_CURATION = true (デフォルト)                      │       │
│  │ ・キュレーション結果をダッシュボードの「レビューパネル」に表示  │              │
│  │ ・人間が確認して修正・承認・削除が可能                         │           │
│  │ ・信頼度が高まれば人間レビューなしで自動承認に移行             │             │
│  └──────────────────────────────────────────────────────────────┘       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**データソースと処理の詳細**:

| ソース | トリガー | 処理内容 | 出力先 |
|--------|---------|---------|--------|
| リサーチャーの市場データ | `task_queue` (type='curate') に自動投入 | トレンド情報をシナリオ素案に変換、参考動画をモーション参照に分類 | `components` (scenario/motion) |
| 人間の参考コンテンツ | ダッシュボードから提出 → キューに投入 | URL/ファイルを分析し、適切なコンポーネント種別に構造化 | `components` (種別に応じて) |
| アナリストの改良推奨 | スコア分析完了後に改良対象をキューに投入 | 既存コンポーネントのデータを改良版として再生成 | `components` (既存の更新 or 新規作成) |

**v4.0 vs v5.0 コンポーネント管理の比較**:

| データ | v4.0 | v5.0 |
|--------|------|------|
| シナリオ | 人間が手動作成 | データキュレーターが自動生成 + 人間レビュー |
| モーション | 人間が手動作成 | データキュレーターが自動分類・登録 |
| 音声 | 人間が手動作成 | データキュレーターが自動設定 |
| 画像 | 人間が手動作成 | データキュレーターが自動分類・登録 |

## 4. MCP Server層

### 4.1 自作MCP Server (Node.js)

エージェントとデータ基盤の間に位置する中間層。エージェントは **SQLを直接書かず、MCPツールを呼び出す** ことでデータベースにアクセスする。

```
┌───────────────────────────────────────────────────────────────────────┐
│                       MCP Server (Node.js)                            │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │ Tool Registry (89 MCPツール + 13 Dashboard REST API = 計102)    │   │
│  │                                                                  │ │
│  │  [MCPツール — エージェントが MCP Protocol 経由で呼び出す]        │      │
│  │                                                                  │ │
│  │  戦略管理 (10)              市場情報管理 (12)                    │    │
│  │  ├ get_portfolio_kpi_..     ├ save_trending_topic                │ │
│  │  ├ create_cycle             ├ save_competitor_post               │ │
│  │  ├ allocate_resources       ├ search_similar_intel               │ │
│  │  └ send_planner_directive   └ get_intel_gaps                    │  │
│  │                                                                  │ │
│  │  分析・知見管理 (14)        コンテンツ計画管理 (9)               │      │
│  │  ├ verify_hypothesis        ├ plan_content                      │  │
│  │  ├ extract_learning         ├ create_hypothesis                 │  │
│  │  ├ detect_anomalies         ├ get_content_pool_status           │  │
│  │  └ get_component_scores     └ request_production                │  │
│  │                                                                  │ │
│  │  ツール知識管理 (5)         制作管理 (12)                        │    │
│  │  ├ get_tool_knowledge       ├ start_video_generation            │  │
│  │  ├ save_tool_experience     ├ start_tts / start_lipsync         │  │
│  │  └ get_tool_recommendations └ upload_to_drive                   │  │
│  │                                                                  │ │
│  │  投稿管理 (6)               計測管理 (7)                        │    │
│  │  ├ publish_to_youtube       ├ collect_youtube_metrics            │ │
│  │  ├ publish_to_tiktok        ├ collect_tiktok_metrics             │ │
│  │  └ publish_to_instagram     └ collect_account_metrics           │  │
│  │                                                                  │ │
│  │  データキュレーション (6)   エージェント学習 (8)                 │       │
│  │  ├ get_curation_queue       ├ save_reflection                   │  │
│  │  ├ create_component         ├ save_individual_learning          │  │
│  │  └ get_similar_components   └ peek_other_agent_learnings        │  │
│  │                                                                  │ │
│  │  [Dashboard REST API — 人間がダッシュボードから操作]             │     │
│  │  ※ MCP Protocolではなく Next.js API Routes として実装           │     │
│  │                                                                  │ │
│  │  ダッシュボード操作 (10)    キュレーション操作 (3)               │       │
│  │  ├ approve_or_reject_plan   ├ approve_curated_component         │  │
│  │  ├ submit_learning_guidance ├ submit_reference_content          │  │
│  │  └ get_pending_approvals    └ get_curated_components_..         │  │
│  │                                                                  │ │
│  │  ※ 全ツールの詳細定義 → 04-agent-design.md セクション4参照     │        │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │ Business Logic Layer                                             │ │
│  │                                                                  │ │
│  │  ・ツール入力のバリデーション                                   │      │
│  │  ・SQLクエリの構築 (pg ドライバー)                               │     │
│  │  ・pgvectorの類似検索クエリ生成                                 │     │
│  │  ・Drive API呼び出し (ファイルID解決)                            │    │
│  │  ・結果のフォーマット (エージェントが理解しやすい形式)          │          │
│  │  ・エラーハンドリング + リトライ                                │      │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │ Connection Pool                                                  │ │
│  │                                                                  │ │
│  │  PostgreSQL (pg)  ←→  max: 20 connections                       │  │
│  │  Google Drive API ←→  googleapis (service account)              │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
```

### 4.2 MCP Serverの設計原則

| 原則 | 説明 | 理由 |
|---|---|---|
| **SQLを隠蔽** | エージェントはSQLを書かない。`get_pending_tasks` のようなセマンティックなツール名で呼び出す | LLMのSQLハルシネーションを防止。クエリの最適化をサーバー側で一元管理 |
| **ビジネスロジック内包** | 「計測タイミングの計算」「仮説の的中率算出」等はMCPサーバー内で実装 | エージェントのプロンプトを軽量化。ロジック変更時にサーバーだけ更新 |
| **結果フォーマット** | 返却値はエージェントが理解しやすいJSON形式にフォーマット | トークン消費の最適化。不要なDB内部情報を隠蔽 |
| **冪等性** | 同じツールを同じ引数で複数回呼んでも副作用が発生しない (書き込み系はupsert) | LLMのリトライ時に安全 |

### 4.3 langchain-mcp-adaptersによる接続

LangGraph.jsからMCP Serverへの接続は `langchain-mcp-adapters` パッケージを使用する。

```
LangGraph.js
    │
    │  エージェントノード内で
    │  MCPツールをLangChainのTool形式で呼び出し
    │
    ▼
langchain-mcp-adapters
    │
    │  MCP Protocol (stdio or HTTP)
    │  ツール一覧の自動検出 (list_tools)
    │  入力スキーマの自動変換
    │
    ▼
自作 MCP Server (Node.js)
    │
    │  ツールハンドラーが実行
    │  SQL組み立て + 実行
    │
    ▼
PostgreSQL
```

## 5. コンテンツ制作層 (動的レシピアーキテクチャ)

v4.0では「ショート動画」のみを固定パイプラインで制作していた。v5.0では `content_format` によって制作方法を分岐し、**制作レシピ** (`production_recipes`) によってツール組み合わせを動的に切り替えるアーキテクチャに進化する。

### 5.1 content_formatによるワーカー分岐

コンテンツの形式 (`content_format`) に応じて、異なるワーカーが制作を担当する。

```
content テーブル
                           │
  │ content_format
                           │
  ├── 'short_video' ───→ 動画制作ワーカー (コードのみ、LLMなし)
  │                        │
  │                        │ production_recipes.steps に従い
  │                        │ ツールを切り替えて実行
  │                        │
  │                        ├── デフォルトレシピ: v4.0パイプライン
  │                        │   (Kling + Fish Audio + Sync Lipsync)
  │                        └── 代替レシピ: Runway + ElevenLabs + Hedra 等
                           │
  ├── 'text_post' ─────→ テキスト制作ワーカー (LLM駆動: Sonnet)
  │                        │
  │                        │ テキスト生成は「判断」タスク
  │                        │ キャラクター設定 + シナリオ → 投稿文生成
  │                        │
  │                        └── X投稿、キャプション等
                           │
  └── 'image_post' ────→ 画像制作ワーカー (将来拡張)
                           │
                           └── 現時点では未実装。スコープ外
```

**設計判断: なぜワーカーを分けるか**

| 観点 | 動画制作 | テキスト制作 |
|------|---------|------------|
| 処理の性質 | 機械的な変換 (画像+音声→動画) | 判断を伴う生成 (文脈→文章) |
| LLMの必要性 | 不要 (コードで十分) | 必須 (言語生成は判断タスク) |
| 実行時間 | 12分以上 (外部API待ち) | 数秒 (LLM応答) |
| ツール選択 | レシピで事前決定 | 固定 (LLM直接呼び出し) |
| コスト構造 | API利用料が支配的 | トークンコストが支配的 |

### 5.2 動画制作ワーカー (レシピ駆動・コードのみ)

動画制作ワーカーはLLMを使わず、**制作レシピ** (`production_recipes.steps`) に記載されたツール順序とパラメータに従って機械的に実行する。

```
制作パイプライングラフ (LangGraph)
  │
  │ content_format = 'short_video'
  │
  ▼
┌──────────────────────────────────────────────────────────┐
│ 動画制作ワーカー (Node.js コード)                           │
│                                                          │
│  1. recipe_id から production_recipes.steps を読み込み     │
│  2. キャラクター画像取得 (Drive → fal.storage)              │
│  3. content_sections テーブルからセクション構成を取得         │
│  4. セクション並列処理 (parallel_group でグルーピング)        │
│                                                          │
│  ┌──────────────────────────────────────────────────┐    │
│  │ Promise.all (Nセクション並列)                      │    │
│  │                                                    │  │
│  │  ┌────────────┐ ┌────────────┐      ┌────────────┐│   │
│  │  │ Section 1  │ │ Section 2  │ ...  │ Section N  ││   │
│  │  │            │ │            │      │            ││   │
│  │  │ [動画Gen]┐ │ │ [動画Gen]┐ │      │ [動画Gen]┐ ││     │
│  │  │ [TTS] ──┤ │ │ [TTS] ──┤ │      │ [TTS] ──┤ ││      │
│  │  │         ▼ │ │         ▼ │      │         ▼ ││      │
│  │  │ [Lipsync]  │ │ [Lipsync]  │      │ [Lipsync]  ││   │
│  │  └────────────┘ └────────────┘      └────────────┘│   │
│  │                                                    │  │
│  │  ※ [ツール名] はレシピの steps で指定:              │     │
│  │    step.tool_name → 対応するNode.js関数を呼び出し   │    │
│  └──────────────────────────────────────────────────┘    │
│                       │                                  │
│                       ▼                                  │
│              ffmpeg concat (H.264 CRF18)                 │
│              + blackdetect 検証 + 自動トリム               │
│                       │                                  │
│                       ▼                                  │
│              Google Drive 保存                            │
│              (Productions/YYYY-MM-DD/CNT_YYYYMM_XXXX/)   │
└──────────────────────────────────────────────────────────┘
```

**v4.0との違い**:
- セクション数が固定3 (Hook/Body/CTA) → 動的N件 (`content_sections` テーブルで定義)
- ツールが固定 (Kling/Fish Audio/Sync Lipsync) → レシピで切り替え可能
- 並列実行のグルーピングもレシピの `parallel_group` で定義

### 5.3 テキスト制作ワーカー (LLM駆動)

テキスト投稿 (X投稿等) の生成は **LLMによる判断タスク** である。キャラクターの口調・世界観を反映した文章生成にはLLMが必須。

```
制作パイプライングラフ (LangGraph)
  │
  │ content_format = 'text_post'
  │
  ▼
┌──────────────────────────────────────────────────────────────┐
│ テキスト制作ワーカー (Node.js + Claude Sonnet 4.5)              │
│                                                              │
│  1. content + content_sections からシナリオを取得               │
│  2. characters テーブルからキャラクター設定を取得                 │
│  3. LLM呼び出し: シナリオ + キャラ設定 → 投稿文生成                │
│  4. 生成テキストを content_sections.script に保存               │
│  5. status → 'ready'                                         │
│                                                              │
│  ※ LLMを使う理由:                                              │
│    テキスト生成は「入力→変換→出力」ではなく                        │
│    「文脈を理解して適切な表現を選択する」判断タスク                 │
│    キャラの性格・口調・ニッチの文脈をLLMが解釈する必要がある         │
│                                                              │
│  ※ プラットフォーム別制約:                                      │
│    X: 280文字以内、ハッシュタグ2〜5個、スレッド対応                │
│    Instagram: 2,200文字以内、ハッシュタグ10〜20個                │
│    TikTok: 2,200文字以内、短文推奨                              │
│    YouTube: タイトル100文字以内、概要5,000文字以内                │
│    → 詳細は 04-agent-design.md §1.7 参照                       │
└──────────────────────────────────────────────────────────────┘
```

### 5.4 制作レシピとツールスペシャリスト

動画制作で使用するツールの組み合わせは `production_recipes` テーブルで管理される。ツールスペシャリスト (→ [04-agent-design.md §1.4](04-agent-design.md#14-layer-2-専門職--ツールスペシャリスト-tool-specialist-x-1体)) がコンテンツ要件に基づいて最適なレシピを選択する。

```
レシピ選択フロー:

  プランナー                      ツールスペシャリスト
    │                                │
    │ 制作レシピ要求:                  │
    │  - content_format: short_video │
    │  - niche: beauty               │
    │  - character: アジア人          │
    │  - platform: youtube           │
    │                                │
    └──────────────────────────────→ │
                                     │ production_recipes テーブルを検索:
                                     │  1. content_format + target_platform で絞込
                                     │  2. recommended_for (niche, ethnicity等) でマッチ
                                     │  3. avg_quality_score + success_rate で順位付け
                                     │  4. is_active = true のみ
                                     │
                                     │ 該当なし or 初回 → is_default = true を使用
                                     │
    ┌──────────────────────────────  ┘
    │ 選択結果:
    │  recipe_id: 1
    │  recipe_name: 'asian_beauty_short'
    │  steps: [video_gen→TTS→lipsync→concat]
    ▼
  content.recipe_id に記録
```

**レシピの steps JSONB 構造** (→ [03-database-schema.md §6.4](03-database-schema.md#64-production_recipes--制作レシピ)):

```json
[
  {
    "order": 1,
    "step_name": "video_generation",
    "tool_name": "kling_v2.6",
    "params": { "duration": "5", "aspect_ratio": "9:16" },
    "parallel_group": "section"
  },
  {
    "order": 2,
    "step_name": "tts",
    "tool_name": "fish_audio_tts",
    "params": { "format": "mp3" },
    "parallel_group": "section"
  },
  {
    "order": 3,
    "step_name": "lipsync",
    "tool_name": "fal_lipsync",
    "params": {},
    "depends_on": [1, 2]
  },
  {
    "order": 4,
    "step_name": "concat",
    "tool_name": "ffmpeg",
    "params": { "codec": "h264", "crf": 18 }
  }
]
```

`parallel_group` が同じステップはセクション内で並列実行される。`depends_on` で依存関係を宣言し、先行ステップの完了を待つ。

### 5.5 v4.0パイプラインの位置づけ

v4.0で構築した動画生成パイプライン (orchestrator.js) は **デフォルトレシピ** としてそのまま残る。

```
v4.0 (現行)                          v5.0 (新)
─────────────────                    ─────────────────
タスク発行者: 人間                     タスク発行者: 戦略サイクルグラフ (LLM)
  │                                    │
  ▼                                    ▼
データソース: Google Sheets             データソース: PostgreSQL
  (inventory-reader.js)                  (MCP Server経由)
  │                                    │
  ▼                                    ▼
パイプライン: 固定                      レシピ選択: ツールスペシャリスト
  Kling + Fish Audio                     │
  + Sync Lipsync + ffmpeg                ├→ デフォルトレシピ (= v4.0と同一構成)
  │                                    │   Kling + Fish Audio
  │                                    │   + Sync Lipsync + ffmpeg
  │                                    │
  │                                    └→ 代替レシピ (ツールSPが設計)
  │                                        Runway + ElevenLabs + Hedra 等
  ▼                                    ▼
出力: Google Drive                      出力: Google Drive (変更なし)
```

| 項目 | v4.0 | v5.0 |
|------|------|------|
| タスク発行者 | 人間 (Sheets UIでキューイング) | 戦略サイクルグラフ (LLM) |
| タスク読み取り元 | Google Sheets (production タブ) | PostgreSQL (content + task_queue) |
| ジョブ検出方法 | watch-pipeline.js (30秒ポーリング) | 制作パイプライングラフ (LangGraphノード) |
| 結果記録先 | Google Sheets (production タブ 33カラム) | PostgreSQL (content テーブル) + Drive |
| コンテンツ形式 | ショート動画のみ | short_video / text_post / image_post |
| ツール選択 | 固定 (Kling + Fish Audio + Sync Lipsync) | 制作レシピで動的切替 (デフォルトはv4.0と同一) |
| セクション構成 | 固定3分割 (Hook/Body/CTA) | 動的N件 (content_sections テーブル) |
| ファイル保存先 | Google Drive | 同じ (変更なし) |

### 5.6 動画制作をMCP化しない理由

動画制作パイプラインはMCPツールとして公開 **しない**。テキスト制作ワーカーのLLM呼び出しとは設計が異なる。

| 観点 | MCP化した場合 | 直接コード実行 (採用) |
|------|-------------|---------------------|
| 実行主体 | LLMがツールとして呼び出す | Node.jsコードが直接実行 |
| トークンコスト | fal.aiのレスポンス (数百行) をLLMが読む | コードが直接処理。LLMは不要 |
| エラー処理 | LLMが判断 (コスト高) | コードで自動リトライ (コスト0) |
| 処理時間 | LLMの応答待ち分遅延 | 最速 |
| 適合パターン | 判断を伴うタスク | 機械的な変換タスク |

**結論**: 動画制作は「判断」ではなく「変換」のタスク。画像+音声→動画の生成はLLMの介在なしにコードが最も効率的に処理できる。LangGraphのノードからNode.jsの関数を直接呼び出す。一方、テキスト制作は「判断」を伴うためLLM (Sonnet) を使用する — この使い分けが本アーキテクチャの核心。

## 6. ダッシュボード層

### 6.1 Next.js + Shadcn/ui

人間がシステムの状態を監視し、必要に応じて介入するためのWebダッシュボード。

**UIフレームワーク**: Next.js 14+ (App Router) + Shadcn/ui + Tailwind CSS

**テーマ (Solarized)**:

| 要素 | Dark (デフォルト) | Light |
|---|---|---|
| 背景 (bg) | `#002b36` (base03) | `#fdf6e3` (base3) |
| 前景 (fg) | `#839496` (base0) | `#657b83` (base00) |
| サイドバー | `#073642` (base02) | `#eee8d5` (base2) |
| アクセント (blue) | `#268bd2` | `#268bd2` |
| アクセント (cyan) | `#2aa198` | `#2aa198` |
| Warning | `#b58900` (yellow) | `#b58900` (yellow) |
| Error | `#dc322f` (red) | `#dc322f` (red) |
| Success | `#859900` (green) | `#859900` (green) |
| Info | `#268bd2` (blue) | `#268bd2` (blue) |

**フォント**:
- Body: Nunito (Google Fonts, rounded sans-serif), 14px
- Heading: Nunito, 20-32px
- Mono (コード・数値表示): JetBrains Mono

**レスポンシブ設計** (Mobile-first):

| ブレークポイント | 幅 | レイアウト |
|---|---|---|
| sm | 640px | モバイル: シングルカラム、ハンバーガーメニュー |
| md | 768px | タブレット: サイドバー折りたたみ、2カラム |
| lg | 1024px | デスクトップ: フルサイドバー、マルチカラム |
| xl | 1280px | ワイドデスクトップ: 余裕のあるレイアウト |

**認証**: なし (シングルユーザー、localhost アクセス前提)
**外部通知**: なし (Slack/メール連携なし) — ダッシュボード画面のみで完結
**自動更新**: `DASHBOARD_AUTO_REFRESH_SEC` (system_settings) で設定可能

```
┌─────────────────────────────────────────────────────────────────┐
│                    Next.js Dashboard                            │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 読み取り (Read-Only Views)                                │   │
│  │                                                           │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │    │
│  │  │ KPI進捗      │  │ アルゴリズム │  │ 投稿別       │   │       │
│  │  │              │  │ 精度推移     │  │パフォーマンス│   │       │
│  │  │ ・目標vs実績 │  │              │  │              │   │      │
│  │  │・アカウント別│  │ ・仮説的中率 │  │ ・views      │   │        │
│  │  │ ・日次/週次  │  │ ・学習曲線   │  │ ・engagement │   │       │
│  │  │ ・トレンド   │  │ ・ジャンル別 │  │ ・比較       │   │        │
│  │  └──────────────┘  └──────────────┘  └──────────────┘   │    │
│  │                                                           │  │
│  │  ┌──────────────┐  ┌──────────────┐                      │   │
│  │  │ 学習ログ     │  │ エージェント │                      │      │
│  │  │              │  │ 実行ログ     │                      │    │
│  │  │ ・知見一覧   │  │              │                      │     │
│  │  │ ・仮説→結果  │  │ ・タスク状況 │                      │      │
│  │  │ ・改善提案   │  │ ・エラー率   │                      │      │
│  │  └──────────────┘  └──────────────┘                      │   │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 書き込み (Human Intervention)                             │   │
│  │                                                           │  │
│  │  ┌──────────────────────┐  ┌──────────────────────────┐  │   │
│  │  │ 仮説投入             │  │ 設定変更                 │  │     │
│  │  │                      │  │                          │  │   │
│  │  │ ・人間が仮説を       │  │ ・計測タイミング         │  │        │
│  │  │   直接追加           │  │   (48h → 24h 等)         │  │     │
│  │  │ ・参考コンテンツURL  │  │ ・投稿頻度               │  │       │
│  │  │   の指定             │  │ ・コスト上限             │  │      │
│  │  │ ・優先度の指示       │  │ ・エージェント有効/無効  │  │         │
│  │  └──────────────────────┘  └──────────────────────────┘  │   │
│  │                                                           │  │
│  │  ┌────────────────────────────────────────────────────┐   │  │
│  │  │ コンテンツ計画承認                                 │   │     │
│  │  │ (REQUIRE_HUMAN_APPROVAL=true 時のみ表示)           │   │    │
│  │  │                                                    │   │  │
│  │  │ ・pending_approval 状態の計画一覧                  │   │    │
│  │  │ ・アカウント/シナリオ/仮説/コスト の詳細表示       │   │        │
│  │  │ ・承認 → planned に遷移 (制作開始)                 │   │     │
│  │  │ ・差戻 → 計画策定に戻す (理由コメント付き)         │   │        │
│  │  │ ・一括承認/一括差戻                                │   │     │
│  │  └────────────────────────────────────────────────────┘   │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│                     │ Prisma or Drizzle ORM                     │
│                     ▼                                           │
│              PostgreSQL (直結)                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 ダッシュボードの設計方針

| 方針 | 説明 |
|---|---|
| **DB直結** | MCP Serverを経由せず、Prisma/Drizzle ORMでPostgreSQLに直接接続。ダッシュボードはLLMではないため、MCPプロトコルは不要 |
| **読み取り中心** | 大半の画面は読み取り専用。AIが自律的に回しているため、人間は基本的に監視のみ |
| **介入は限定的** | 書き込みは「仮説投入」「参考コンテンツ指定」「設定変更」「コンテンツ計画承認」に限定。日常的な操作は全てAIが行う。計画承認は `REQUIRE_HUMAN_APPROVAL=true` 時のみ |
| **リアルタイム性不要** | ポーリング (30秒〜1分) で十分。WebSocketは不要 |
| **人間-エージェント協働** | AIチームを管理する「マネージャー」としての人間を支援する。エージェントの思考プロセスを可視化し、1on1フィードバック・進化の追跡・プロンプト調整を可能にする |

### 6.3 エージェント思考ログビューア (Agent Thought Log Viewer)

エージェントがどのデータを読み、何を考慮し、どんな判断を下し、なぜそう判断したかを可視化するビューア。「何を生産したか」だけでなく「どう思考したか」を人間が理解できるようにする。

```
┌──────────────────────────────────────────────────────────────────────┐
│  エージェント思考ログビューア                                            │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐     │
│  │ フィルタ                                                    │      │
│  │                                                             │     │
│  │  エージェント: [全て ▼]  サイクル: [Cycle #127 ▼]           │         │
│  │  日付: [2026-03-01] 〜 [2026-03-07]  種別: [判断 ▼]         │       │
│  └─────────────────────────────────────────────────────────────┘     │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐     │
│  │ Cycle #127 — 戦略サイクル (2026-03-07 06:00)                │       │
│  │                                                             │     │
│  │  [リサーチャー] 09:01                                       │       │
│  │  ├── 読み取りデータ:                                          │     │
│  │  │   ・トレンドAPI: beauty系 +15%, tech系 -3%                 │     │
│  │  │   ・競合データ: @competitor_a の直近7日 avg ER 4.8%         │     │
│  │  │   ・過去パフォーマンス: ACC_0013 先週ER 3.2% (前週比-0.5%) │        │
│  │  ├── 考慮事項:                                                │    │
│  │  │   ・beauty系トレンド上昇中だがACC_0013は先週不調            │       │
│  │  │   ・pgvector類似検索: 過去の類似トレンドでは2週間後に反転   │         │
│  │  └── 判断: beautyトレンドは継続と判断、データをアナリストに渡す │         │
│  │                                                             │     │
│  │  [アナリスト] 09:03                                         │       │
│  │  ├── 読み取りデータ:                                          │     │
│  │  │   ・リサーチャーからの市場データ                             │      │
│  │  │   ・過去仮説的中率: beauty系 42%, tech系 28%                │     │
│  │  │   ・pgvector類似仮説検索: 3件の類似仮説 (全てconfirmed)     │       │
│  │  ├── 考慮事項:                                                │    │
│  │  │   ・類似仮説が全て的中 → 高信頼度パターン                   │        │
│  │  │   ・ただし季節性を考慮すると3月は例外的な動きの可能性あり    │         │
│  │  └── 判断: 新仮説「3月のbeauty系は季節需要で+20%」を生成      │         │
│  │                                                             │     │
│  │  [戦略Agent] 09:05                                          │      │
│  │  ├── 読み取りデータ: アナリストの仮説 + プランナーの計画        │        │
│  │  ├── 考慮事項: コスト上限 $50/day に対して計画は $42/day       │       │
│  │  └── 判断: 計画を承認 (コスト余裕あり + 仮説信頼度高)          │        │
│  └─────────────────────────────────────────────────────────────┘     │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

**データソース**: `agent_thought_logs` テーブル。各エージェントの実行ステップごとに、入力データ・考慮事項・判断結果・判断理由をJSONBで記録する。

**主な機能**:

| 機能 | 説明 |
|---|---|
| **エージェント別フィルタ** | 戦略Agent、リサーチャー、アナリスト、プランナー等、特定エージェントのログのみ表示 |
| **サイクル別フィルタ** | 特定の戦略サイクル (Cycle #127等) に紐づくログを時系列で表示 |
| **日付範囲フィルタ** | 指定期間内のログを表示 |
| **ステップ種別フィルタ** | 「データ収集」「分析」「判断」「承認」等のステップ種別で絞り込み |
| **詳細展開** | 各ステップをクリックすると、MCPツール呼び出しの引数・戻り値の詳細を表示 |
| **判断の追跡** | 特定の判断が後続のどのコンテンツ・投稿・結果に繋がったかをリンクで追跡 |

### 6.4 人間↔エージェント対話インターフェース (Human-Agent Dialogue)

マネージャーがチームメンバーに1on1でフィードバックするように、人間が特定のエージェントに対して持続的な指示を送るインターフェース。既存の `human_directives` テーブル (03-database-schema.md 4.2節) を拡張し、エージェント単位のターゲティングとチャット形式のUIを提供する。

```
┌──────────────────────────────────────────────────────────────────────┐
│  人間↔エージェント対話                                                  │
│                                                                      │
│  ┌──────────────┐  ┌──────────────────────────────────────────────┐  │
│  │ エージェント │  │ アナリスト との対話                          │       │
│  │               │  │                                              │ │
│  │ ● 戦略Agent │  │  ┌────────────────────────────────────────┐ │     │
│  │ ● リサーチ  │  │  │ [人間] 2026-03-05 10:30                │ │      │
│  │ ◉ アナリスト│  │  │ 今後はエンゲージメント率をビュー数より │ │           │
│  │ ● プランナー│  │  │ 重視して仮説を生成して。ビュー数が多く │ │           │
│  │ ● ツールSP  │  │  │ てもER低いコンテンツは失敗と判断して。 │ │           │
│  │ ● キュレーター│ │  │                                        │ │     │
│  │ ─────────── │  │  │→ ステータス: applied (Cycle #125で適用)│ │      │
│  │ 📢 全体通知 │  │  └────────────────────────────────────────┘ │      │
│  │               │  │                                              │ │
│  │               │  │  ┌────────────────────────────────────────┐ │  │
│  │               │  │  │ [人間] 2026-03-07 14:00                │ │   │
│  │               │  │  │ beauty系の仮説生成時、韓国トレンドも   │ │       │
│  │               │  │  │ 考慮に入れて。K-beautyの影響が大きい。 │ │       │
│  │               │  │  │                                        │ │  │
│  │               │  │  │ → ステータス: pending                  │ │    │
│  │               │  │  └────────────────────────────────────────┘ │  │
│  │               │  │                                              │ │
│  │               │  │  ┌────────────────────────────────────────┐ │  │
│  │               │  │  │ 指示を入力...                          │ │    │
│  │               │  │  │                                        │ │  │
│  │               │  │  │  優先度: [normal ▼]  [送信]            │ │    │
│  │               │  │  └────────────────────────────────────────┘ │  │
│  └──────────────┘  └──────────────────────────────────────────────┘  │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

**既存スキーマとの関係**: `human_directives` テーブルの `directive_type = 'instruction'` としてDBに保存される。`target_agents` カラムの追加により、特定エージェントへの指示を実現する (全体ブロードキャストは `target_agents = NULL`)。

**主な機能**:

| 機能 | 説明 |
|---|---|
| **エージェント選択** | 左パネルから対話対象のエージェントを選択。各エージェントの未読指示数をバッジ表示 |
| **チャット形式UI** | 時系列で人間の指示を表示。各指示のステータス (pending/acknowledged/applied/expired) をリアルタイム更新 |
| **全体ブロードキャスト** | 「全体通知」を選択すると、全エージェントに共通の指示を送信。`target_agents = NULL` でDBに保存 |
| **持続的指示** | 送信された指示は `human_directives` に永続化され、対象エージェントが毎サイクル開始時に読み取る |
| **適用確認** | 指示が実際にどのサイクルで反映されたか、どのコンテンツ計画に影響したかを追跡表示 |
| **優先度設定** | low/normal/high/urgent の4段階。`urgent` は進行中サイクルに割り込み |

**指示の例**:

| 対象エージェント | 指示例 | 効果 |
|---|---|---|
| アナリスト | 「エンゲージメント率をビュー数より重視して」 | 仮説生成の評価基準が変更される |
| リサーチャー | 「TikTokの@xxx_accountを定点観測対象に追加して」 | 市場データ収集の対象が拡張される |
| プランナー | 「beauty系は週3本から週5本に増やして」 | コンテンツ計画の配分が変更される |
| 戦略Agent | 「今月はコスト上限を$80/dayに引き上げてOK」 | 承認基準のコスト閾値が変更される |
| 全体 | 「来週から新ジャンル'cooking'を追加する」 | 全エージェントが新ジャンルを認識して対応 |

### 6.5 エージェント進化ダッシュボード (Agent Evolution Dashboard)

各エージェントが時間とともにどのように「成長」しているかを可視化するダッシュボード。`algorithm_performance` テーブル (03-database-schema.md 4.4節) のデータを基に、時系列グラフでシステムの学習状況を追跡する。

```
┌─────────────────────────────────────────────────────────────────────┐
│  エージェント進化ダッシュボード                                          │
│                                                                     │
│  期間: [過去90日 ▼]  粒度: [weekly ▼]                                 │
│                                                                     │
│  ┌────────────────────────────┐  ┌────────────────────────────┐     │
│  │ 蓄積知見数                 │  │ 仮説的中率                 │        │
│  │                             │  │                             │   │
│  │  200 ┤          ___---      │  │ 65% ┤                       │   │
│  │  150 ┤      __--           │  │ 55% ┤          ___---       │    │
│  │  100 ┤   _--              │  │ 45% ┤      __--            │      │
│  │   50 ┤ _-                 │  │ 35% ┤   _--               │       │
│  │    0 ┤-                   │  │ 25% ┤ _-                  │       │
│  │      └──────────────────  │  │      └──────────────────  │       │
│  │       W1  W4  W8  W12     │  │       W1  W4  W8  W12     │       │
│  │                             │  │                             │   │
│  │  現在: 187件 (+12/週)       │  │  現在: 52% (目標: 65%)      │     │
│  │  ステータス: 順調 ↑        │  │  ステータス: 改善中 ↑      │          │
│  └────────────────────────────┘  └────────────────────────────┘     │
│                                                                     │
│  ┌────────────────────────────┐  ┌────────────────────────────┐     │
│  │ コンテンツ品質スコア       │  │エージェント別パフォーマンス│            │
│  │                             │  │                             │   │
│  │  4.5 ┤          ___---   │  │  アナリスト:                │        │
│  │  4.0 ┤      __--         │  │    仮説的中率  52% (+3%)    │        │
│  │  3.5 ┤   _--             │  │    生成仮説数  23/週        │        │
│  │  3.0 ┤ _-                │  │                             │      │
│  │  2.5 ┤-                  │  │  リサーチャー:              │        │
│  │      └────────────────── │  │    データ収集量 1,200件/週  │        │
│  │       W1  W4  W8  W12       │  │    有用データ率 78% (+5%)   │     │
│  │                             │  │                             │   │
│  │  現在: 4.2/5.0 (+0.3/月)    │  │  プランナー:                │     │
│  │  ステータス: 順調 ↑        │  │    計画承認率  89% (+4%)   │         │
│  └────────────────────────────┘  └────────────────────────────┘     │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ アラート                                                    │     │
│  │                                                             │    │
│  │ ⚠ [2026-03-05] tech系の仮説的中率が3週連続低下 (38%→32%→28%)│        │
│  │  ⚠ [2026-03-03] リサーチャーの有用データ率が先週比-8%       │         │
│  │  ✓ [2026-03-01] beauty系の知見蓄積ペースが目標を上回っている│          │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**データソース**: `algorithm_performance` テーブル (weekly/monthly集計) + `agent_thought_logs` テーブル (エージェント別集計) + `hypotheses` テーブル (的中率算出) + `learnings` テーブル (システム全体の共有知見数集計) + `agent_individual_learnings` テーブル (エージェント別個別知見数集計)。

**表示指標**:

| グラフ | 指標 | データソース | 意味 |
|---|---|---|---|
| **蓄積知見数** | `learning_count` の時系列推移 | `algorithm_performance` | システムが蓄積した知見の総量。増加ペースが鈍化するとアラート |
| **仮説的中率** | `hypothesis_accuracy` の時系列推移 | `algorithm_performance` | 仮説の正確性。目標 初期30% → 6ヶ月後65%。低下が続くとアラート |
| **コンテンツ品質スコア** | 投稿パフォーマンスの加重平均 (ER, views, watch_time) | `metrics` + `content` | 生成されたコンテンツの品質トレンド |
| **エージェント別パフォーマンス** | 各エージェント固有のKPI | `agent_thought_logs` + 各種テーブル | エージェントごとの成長度合い |

**アラート条件**:

| 条件 | 閾値 | アラートレベル |
|---|---|---|
| 仮説的中率が3週連続低下 | `improvement_rate < 0` が3週連続 | 警告 (黄) |
| 蓄積知見ペースが50%以下に鈍化 | 週次増加率が過去平均の50%未満 | 警告 (黄) |
| コンテンツ品質スコアが前月比10%以上低下 | 月次比較で-10%以上 | 危険 (赤) |
| 特定ジャンルの的中率が20%未満 | ジャンル別 `hypothesis_accuracy < 0.20` | 危険 (赤) |

#### 学習方法レビューパネル (Learning Method Review)

各エージェントが **どのように学習しているか** を人間が確認し、学習方法そのものに指導を与えるパネル。プロンプトチューニング (6.6) が「何をすべきか」を変えるのに対し、本パネルは「どのように学ぶか」を軌道修正する。

**設計方針**: 初期フェーズでは人間が各エージェントの学習方法を積極的に確認・軌道修正し、安定期に入ったら自律学習に移行する。

```
┌───────────────────────────────────────────────────────────────────────┐
│  学習方法レビュー                                                       │
│                                                                       │
│  ┌──────────────┐  ┌──────────────────────────────────────────────┐   │
│  │ エージェント │  │ アナリスト — 学習方法レビュー                │         │
│  │               │  │                                              │  │
│  │ ● 社長        │  │  ■ 直近リフレクション (self_score推移)       │      │
│  │ ● リサーチャー│  │  ┌────────────────────────────────────────┐ │     │
│  │ ◉ アナリスト  │  │  │ #125: 7/10 → #126: 6/10 → #127: 5/10  │ │      │
│  │ ● プランナー  │  │  │ 改善点: 「サンプル数3で仮説を確認した   │ │         │
│  │ ● ツールSP    │  │  │  が後にrejectされた。基準が甘い」       │ │       │
│  │ ● キュレーター│  │  └────────────────────────────────────────┘ │     │
│  │               │  │                                              │  │
│  │               │  │  ■ 個別学習メモリ (最新5件)                  │     │
│  │               │  │  ┌────────────────────────────────────────┐ │   │
│  │               │  │  │ #89 [technique] 「n<30はinconclusive」  │ │   │
│  │               │  │  │   success_rate: 0.85 適用12回            │ │  │
│  │               │  │  │ #87 [pattern] 「朝投稿はER+20%」        │ │    │
│  │               │  │  │   success_rate: 0.70 適用8回             │ │  │
│  │               │  │  └────────────────────────────────────────┘ │   │
│  │               │  │                                              │  │
│  │               │  │  ■ 学習パターン可視化                        │     │
│  │               │  │  ┌────────────────────────────────────────┐ │   │
│  │               │  │  │ カテゴリ分布: technique 34 | pattern 28 │ │    │
│  │               │  │  │ 学習ペース: +8件/週 (加速中)             │ │    │
│  │               │  │  │ 弱点: サンプル数基準が一貫していない     │ │      │
│  │               │  │  └────────────────────────────────────────┘ │   │
│  │               │  │                                              │  │
│  │               │  │  ■ 学習方法指導を送信                        │     │
│  │               │  │  ┌────────────────────────────────────────┐ │   │
│  │               │  │  │ カテゴリ: [統計的検証方法 ▼]             │ │    │
│  │               │  │  │ 指導内容:                                │ │  │
│  │               │  │  │ ┌──────────────────────────────────┐   │ │   │
│  │               │  │  │ │サンプル数3で仮説を確認している    │   │ │       │
│  │               │  │  │ │が、最低10件は必要。n<10の場合は   │   │ │      │
│  │               │  │  │ │必ずinconclusiveとし、追加データを  │   │ │    │
│  │               │  │  │ │要求すること                       │   │ │    │
│  │               │  │  │ └──────────────────────────────────┘   │ │   │
│  │               │  │  │                                        │ │   │
│  │               │  │  │  [送信]  [テンプレートから選択]         │ │      │
│  │               │  │  └────────────────────────────────────────┘ │   │
│  └──────────────┘  └──────────────────────────────────────────────┘   │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
```

**パネル構成**:

| セクション | データソース | 説明 |
|---|---|---|
| **直近リフレクション** | `agent_reflections` (直近N件) | self_score推移と改善点。学習の方向性が正しいかを人間が確認 |
| **個別学習メモリ** | `agent_individual_learnings` (最新5件) | エージェントが蓄積した個別知見の内容。学習内容の妥当性を確認 |
| **学習パターン可視化** | `agent_individual_learnings` (カテゴリ集計) + `agent_reflections` (推移分析) | カテゴリ分布・学習ペース・弱点の自動検出 |
| **学習方法指導フォーム** | → `human_directives` INSERT (`directive_type='learning_guidance'`) | 人間が「学習方法そのもの」に対して指導を送信 |

**フェーズ別の運用**:

| フェーズ | 人間の関与 | 説明 |
|---|---|---|
| **初期 (Phase 2-3)** | 週次で全エージェントの学習方法をレビュー | 各エージェントの学習パターンが正しい方向か確認し、積極的に軌道修正 |
| **中期 (Phase 4-5)** | 月次レビュー + アラート時のみ介入 | 学習停滞・退行アラート発火時に学習方法を確認・修正 |
| **安定期 (Phase 6+)** | 自律学習に移行。異常時のみ介入 | エージェントが自律的に学習方法を改善。人間は監視のみ |

### 6.6 プロンプト管理UI (Prompt Management UI)

各エージェントのシステムプロンプト (性格・判断基準・行動指針) をダッシュボードから閲覧・編集するUI。プロンプト変更前後のパフォーマンス比較により、チューニングの効果を定量的に評価できる。

```
┌──────────────────────────────────────────────────────────────────────┐
│  プロンプト管理                                                        │
│                                                                      │
│  ┌──────────────┐  ┌──────────────────────────────────────────────┐  │
│  │ エージェント │  │ アナリスト — システムプロンプト              │        │
│  │               │  │                                              │ │
│  │ ● 戦略Agent   │  │  バージョン: v3 (2026-03-05)  [履歴 ▼]       │    │
│  │ ● リサーチャー│  │                                              │   │
│  │ ◉ アナリスト  │  │  ┌────────────────────────────────────────┐ │    │
│  │ ● プランナー  │  │  │あなたはAI KOLシステムのアナリストです。│ │         │
│  │               │  │  │                                        │ │  │
│  │               │  │  │ ## 役割                                │ │   │
│  │               │  │  │市場データと過去パフォーマンスを分析し、│ │        │
│  │               │  │  │ 検証可能な仮説を生成する。             │ │      │
│  │               │  │  │                                        │ │  │
│  │               │  │  │ ## 判断基準                            │ │   │
│  │               │  │  │ - エンゲージメント率を最重要指標とする │ │        │
│  │               │  │  │ - ビュー数は参考値として扱う ← v3で追加 │ │      │
│  │               │  │  │ - 類似仮説の過去実績を必ず確認する      │ │      │
│  │               │  │  │ ...                                     │ │ │
│  │               │  │  └────────────────────────────────────────┘ │  │
│  │               │  │                                              │ │
│  │               │  │  [保存 (v4として)]  [差分表示]  [元に戻す]   │     │
│  └──────────────┘  └──────────────────────────────────────────────┘  │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐     │
│  │ バージョン比較                                              │       │
│  │                                                             │     │
│  │  v2 → v3 変更 (2026-03-05):                                 │      │
│  │  + 「エンゲージメント率を最重要指標とする」を追加           │            │
│  │  + 「ビュー数は参考値として扱う」を追加                     │           │
│  │  - 「ビュー数とER を同等に重視する」を削除                  │           │
│  │                                                             │     │
│  │  変更後のパフォーマンス:                                    │        │
│  │  ┌─────────────┬─────────┬──────────┬────────┐              │     │
│  │  │ 指標        │ v2期間  │ v3期間   │ 変化   │              │       │
│  │  ├─────────────┼─────────┼──────────┼────────┤              │     │
│  │  │ 仮説的中率  │ 45%     │ 52%      │ +7%    │              │       │
│  │  │ 平均ER      │ 3.8%    │ 4.5%     │ +0.7%  │              │      │
│  │  │ 平均views   │ 12,500  │ 10,800   │ -14%   │              │      │
│  │  │ 品質スコア  │ 3.8     │ 4.2      │ +0.4   │              │       │
│  │  └─────────────┴─────────┴──────────┴────────┘              │     │
│  │                                                             │     │
│  │  結論: ER重視方針への切替でER+0.7%, 的中率+7%。             │          │
│  │  views減少はトレードオフだが品質スコア向上で妥当。          │            │
│  └─────────────────────────────────────────────────────────────┘     │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐     │
│  │ テンプレート                                                │       │
│  │                                                             │     │
│  │  [ER重視に切替]  [保守的判断に変更]  [新ジャンル追加]       │           │
│  │  [コスト意識強化]  [実験的姿勢に変更]  [季節性考慮を追加]   │            │
│  └─────────────────────────────────────────────────────────────┘     │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

**プロンプトの保存先**: `agent_prompt_versions` テーブル。`active = true` の行が現在有効なプロンプト。新バージョン保存時は既存の `active` を `false` に更新し、新行を `active = true` で INSERT する。

**主な機能**:

| 機能 | 説明 |
|---|---|
| **閲覧・編集** | 各エージェントのシステムプロンプトをマークダウンエディタで表示・編集 |
| **バージョン管理** | 保存時に自動でバージョン番号をインクリメント。過去バージョンの一覧と差分表示 |
| **パフォーマンス比較** | プロンプト変更前後の指定期間で、仮説的中率・ER・品質スコア等を自動比較 |
| **ロールバック** | 過去のバージョンにワンクリックで戻す。戻した場合も新バージョンとして記録 |
| **テンプレート** | よくあるチューニングパターンをテンプレートとして提供。クリックでプロンプトに差分適用 |
| **変更影響の追跡** | 変更適用後、次サイクルから自動的にパフォーマンス計測開始。一定期間後に効果レポートを生成 |

**テンプレート例**:

| テンプレート名 | 適用先 | 変更内容 |
|---|---|---|
| ER重視に切替 | アナリスト | 仮説生成時の評価基準をビュー数からERに変更 |
| 保守的判断に変更 | 戦略Agent | 承認閾値を厳しく (コスト余裕30%以上必要、仮説信頼度0.6以上必要) |
| 新ジャンル追加 | 全エージェント | 新ジャンルの定義・特性・参考データを各プロンプトに追加 |
| コスト意識強化 | プランナー | 制作計画でのコスト見積もり精度を上げ、低コスト手法を優先 |
| 実験的姿勢に変更 | アナリスト | 類似仮説が少ない未開拓領域の仮説生成を促進 |
| 季節性考慮を追加 | リサーチャー | 月次・四半期の季節変動パターンを市場データ分析に組み込む |

### 6.7 推奨プロンプト改善パネル (Prompt Improvement Suggestions)

エージェントのパフォーマンス低下を自動検知し、thought_logsの分析に基づいてプロンプトの改善提案を表示するパネル。6.6のプロンプト管理UIと連携し、ワンクリックでプロンプト編集画面に遷移できる。

```
┌─────────────────────────────────────────────────────────────────────┐
│  推奨プロンプト改善                                                    │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ 検知されたパフォーマンス低下                                │        │
│  │                                                             │    │
│  │  ⚠ [アナリスト] self_score 3週連続低下: 7 → 6 → 5             │     │
│  │ ⚠ [プランナー] 計画承認率 4週連続低下: 89% → 82% → 75% → 68%│         │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ 改善提案 #1 — アナリスト                       優先度: high │        │
│  │                                                             │    │
│  │  検知トリガー: self_score 3週連続低下                       │       │
│  │                                                             │    │
│  │  thought_logs分析結果:                                      │     │
│  │  ・直近15サイクルのthought_logsを分析                       │       │
│  │  ・「季節性の考慮が不十分」との自己振り返りが5回出現        │            │
│  │  ・tech系ジャンルでの仮説生成時に一貫してデータ不足を報告   │            │
│  │  ・類似仮説検索のヒット率が30%→15%に低下 (知見の陳腐化?)    │           │
│  │                                                             │    │
│  │  推奨プロンプト変更:                                        │       │
│  │  ┌─────────────────────────────────────────────────────┐    │    │
│  │  │ + 「仮説生成時、必ず季節性を3段階で考慮すること:    │    │           │
│  │  │     高シーズン/中シーズン/低シーズン」              │    │         │
│  │  │ + 「データ不足 (n<30) の場合は仮説の信頼度を        │    │         │
│  │  │     'low' に設定し、実験的仮説として明示すること」  │    │          │
│  │  │ + 「30日以上前の知見は再検証対象として              │    │         │
│  │  │     マークすること」                                │    │      │
│  │  └─────────────────────────────────────────────────────┘    │    │
│  │                                                             │    │
│  │  [プロンプト編集画面で適用 →]  [却下]  [保留]               │         │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ 改善提案 #2 — プランナー                     優先度: medium │        │
│  │                                                             │    │
│  │  検知トリガー: 計画承認率 4週連続低下                       │         │
│  │                                                             │    │
│  │  thought_logs分析結果:                                      │     │
│  │  ・差し戻し理由の72%が「コスト過大」                        │         │
│  │  ・tech系ニッチの制作コスト見積もりが実績の1.4倍で乖離      │           │
│  │  ・戦略Agentのコスト閾値との不整合を検出                    │         │
│  │                                                             │    │
│  │  推奨プロンプト変更:                                        │       │
│  │  ┌─────────────────────────────────────────────────────┐    │    │
│  │  │ + 「計画策定時、制作コスト見積もりの                │    │         │
│  │  │     精度を過去実績から算出すること                  │    │         │
│  │  │     (直近10件の実績平均 × 1.1 を上限)」             │    │        │
│  │  │ + 「コスト上限の80%を超える計画は                   │    │        │
│  │  │     代替案も併記すること」                          │    │       │
│  │  └─────────────────────────────────────────────────────┘    │    │
│  │                                                             │    │
│  │  [プロンプト編集画面で適用 →]  [却下]  [保留]               │         │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**検知ロジック**:

| 検知条件 | 閾値 | 分析対象 |
|---|---|---|
| self_score連続低下 | 3サイクル以上連続で前サイクル比マイナス | `agent_reflections.self_score` |
| 承認率低下 | 4週連続で前週比マイナス | `content` テーブルの承認/差戻比率 |
| 仮説的中率低下 | 3週連続で前週比マイナス | `hypotheses` テーブルの的中率 |
| エラー率上昇 | 週次エラー率が前4週平均の2倍超 | `agent_thought_logs` のエラー記録 |

**データ永続化**: 検知された改善提案は `prompt_suggestions` テーブルに保存される。status カラム (`pending` / `accepted` / `rejected` / `on_hold`) で管理状態を追跡する。

**thought_logs分析フロー**:

```
検知トリガー発火
    │
    ▼
agent_reflections から直近N件の振り返りを取得
    │
    ▼
what_went_well / what_to_improve の頻出パターンを抽出
    │
    ▼
agent_thought_logs のthought_logs (判断過程) を分析
    │
    ▼
低下の原因仮説を生成
    │
    ▼
推奨プロンプト変更を具体的な差分として提示
    │
    ▼
「プロンプト編集画面で適用 →」ボタン
    → 6.6 プロンプト管理UIに遷移 (差分をプリセット)
```

### 6.8 エージェント個別成長トラッキング (Individual Agent Growth Tracking)

各エージェントを「チームメンバー」として個別に追跡する画面。システム全体の進化ダッシュボード (6.5) がチーム全体のKPIを示すのに対し、本画面は **一人ひとりの成長** にフォーカスする。`agent_reflections` テーブルの `self_score` と `agent_individual_learnings` テーブルのデータを基に、各エージェントの成長度合い・蓄積知見・振り返り内容を可視化する。

#### エージェント個別パフォーマンスカード

```
┌─────────────────────────────────────────────────────────────────────┐
│  エージェント個別成長トラッキング                                        │
│                                                                     │
│  期間: [過去30日 ▼]                                                   │
│                                                                     │
│  ┌──────────────────────┐  ┌──────────────────────┐                 │
│  │ 戦略Agent (社長)     │  │ リサーチャー         │                    │
│  │                      │  │                      │                 │
│  │  self_score (7日平均)│  │  self_score (7日平均)│                   │
│  │    7 / 10            │  │    8 / 10            │                 │
│  │    トレンド: ↑ 改善中│  │    トレンド: → 安定  │                     │
│  │                      │  │                      │                 │
│  │  蓄積学習数: 42件    │  │  蓄積学習数: 67件    │                     │
│  │    (今週 +5)         │  │    (今週 +3)         │                  │
│  │                      │  │                      │                 │
│  │  直近の振り返り:     │  │  直近の振り返り:     │                     │
│  │  ・コスト配分の判断が│  │  ・K-beautyトレンド  │                      │
│  │    改善した          │  │    の検出精度が向上  │                     │
│  │  ・新ニッチ判断は    │  │  ・データ鮮度の管理  │                      │
│  │    まだ慎重すぎる    │  │    が安定してきた    │                     │
│  │  ・urgent指示への    │  │  ・TikTokの情報源が  │                    │
│  │    対応速度を上げる  │  │    まだ少ない        │                     │
│  │                      │  │                      │                 │
│  │  [詳細を表示]        │  │  [詳細を表示]        │                    │
│  └──────────────────────┘  └──────────────────────┘                 │
│                                                                     │
│  ┌──────────────────────┐  ┌──────────────────────┐                 │
│  │ アナリスト           │  │ プランナー           │                    │
│  │                      │  │                      │                 │
│  │  self_score (7日平均)│  │  self_score (7日平均)│                   │
│  │    8 / 10            │  │    6 / 10            │                 │
│  │    トレンド: ↑ 改善中│  │    トレンド: ↓ 低下  │                     │
│  │                      │  │                      │                 │
│  │  蓄積学習数: 89件    │  │  蓄積学習数: 31件    │                     │
│  │    (今週 +8)         │  │    (今週 +1)         │                  │
│  │                      │  │                      │                 │
│  │  直近の振り返り:     │  │  直近の振り返り:     │                     │
│  │  ・ER重視方針が仮説  │  │  ・beauty系の計画は  │                     │
│  │    精度向上に寄与    │  │    精度が上がった    │                     │
│  │  ・anomaly検出の     │  │  ・tech系の計画承認  │                    │
│  │    閾値が適切になった│  │    率が低い          │                     │
│  │  ・inconclusive判定  │  │  ・コスト見積もりの  │                     │
│  │    の基準を明確化    │  │    精度が不足        │                     │
│  │                      │  │                      │                 │
│  │  [詳細を表示]        │  │  [詳細を表示] ⚠      │                    │
│  └──────────────────────┘  └──────────────────────┘                 │
│                                                                     │
│  ┌──────────────────────┐  ┌──────────────────────┐                 │
│  │ ツールSP             │  │ キュレーター         │                    │
│  │                      │  │                      │                 │
│  │  self_score (7日平均)│  │  self_score (7日平均)│                   │
│  │    7 / 10            │  │    8 / 10            │                 │
│  │    トレンド: → 安定  │  │    トレンド: ↑ 改善中│                     │
│  │                      │  │                      │                 │
│  │  蓄積学習数: 25件    │  │  蓄積学習数: 38件    │                     │
│  │    (今週 +2)         │  │    (今週 +4)         │                  │
│  │                      │  │                      │                 │
│  │  直近の振り返り:     │  │  直近の振り返り:     │                     │
│  │  ・MCP呼び出しの     │  │  ・シナリオ抽出の    │                     │
│  │    エラーハンドリング│  │    精度が向上した    │                      │
│  │    が改善した        │  │  ・モーション分類の  │                     │
│  │  ・バッチ処理の      │  │    カテゴリ精度を    │                     │
│  │    効率化余地あり    │  │    改善中            │                    │
│  │                      │  │                      │                 │
│  │  [詳細を表示]        │  │  [詳細を表示]        │                    │
│  └──────────────────────┘  └──────────────────────┘                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**カード表示項目**:

| 項目 | データソース | 説明 |
|---|---|---|
| **self_score (7日平均)** | `agent_reflections.self_score` (直近7日のAVG) | エージェント自身による自己評価スコア (1-10)。各サイクル終了時に記録 |
| **スコアトレンド** | `agent_reflections.self_score` の7日移動平均の傾き | ↑改善中 / →安定 / ↓低下。低下が3サイクル連続でカードに警告マーク表示 |
| **蓄積学習数** | `agent_individual_learnings` のCOUNT (agent_type別) | そのエージェントが蓄積した個別知見の総数。週次増加数も表示 |
| **直近の振り返り (Top 3)** | `agent_reflections.what_went_well` + `what_to_improve` (直近3件) | 最新の自己振り返りから良かった点と改善点を要約表示 |

#### エージェント成長比較ビュー

全エージェントの成長状況を並べて比較する。「誰が最も伸びているか」「誰が停滞しているか」を一目で把握できる。

```
┌─────────────────────────────────────────────────────────────────────┐
│  エージェント成長比較                                                  │
│                                                                     │
│  期間: [過去90日 ▼]  粒度: [weekly ▼]                                 │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ self_score 推移 (全エージェント)                            │       │
│  │                                                             │    │
│  │  10 ┤                                                       │    │
│  │   9 ┤                                                       │    │
│  │   8 ┤                             __--- アナリスト          │      │
│  │   7 ┤              ___---===---''' リサーチャー             │      │
│  │   6 ┤       __--'''              社長                       │     │
│  │   5 ┤   _--'     ___---...--- プランナー                    │      │
│  │      └──────────────────────────────────────────────────── │     │
│  │       W1    W4    W8    W12                                  │   │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ エージェント成長ランキング                                  │        │
│  │                                                             │    │
│  │  ┌───────────┬──────────┬─────────┬──────────┬───────────┐ │     │
│  │  │ 順位      │ Agent    │score推移│ 学習蓄積 │ 成長速度  │ │         │
│  │  ├───────────┼──────────┼─────────┼──────────┼───────────┤ │     │
│  │  │ 1 (最速)  │アナリスト│ 5→8     │ 89件     │ +0.25/週  │ │        │
│  │  │ 2         │ 社長     │ 6→7     │ 42件     │ +0.1/週   │ │      │
│  │  │ 3         │ リサーチ │ 7→8     │ 67件     │ +0.1/週   │ │       │
│  │  │ 4         │ツールSP  │ 6→7     │ 25件     │ +0.1/週   │ │       │
│  │  │ 5         │キュレーター│ 6→8   │ 38件     │ +0.15/週  │ │       │
│  │  │ 6 (要注意)│プランナー│ 7→6     │ 31件     │ -0.1/週  ⚠│ │        │
│  │  └───────────┴──────────┴─────────┴──────────┴───────────┘ │     │
│  │                                                             │    │
│  │  注意: プランナーのself_scoreが4週連続低下中                │         │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**比較指標**:

| 指標 | 算出方法 | 意味 |
|---|---|---|
| **score推移** | 90日前の `self_score` → 現在の `self_score` | 成長の絶対量 |
| **学習蓄積** | `agent_individual_learnings` のCOUNT | 知見の蓄積総量。多いほど経験豊富 |
| **成長速度** | `self_score` の週次変化率 (線形回帰の傾き) | 正=成長中、0=安定、負=退行。-0.1以下でアラート |

#### 個別学習ブラウザ

各エージェントの「個人ノート」を閲覧する。エージェントが何を学んだか、どのカテゴリの知見が多いか、各知見の実用度 (success_rate) を確認できる。

```
┌──────────────────────────────────────────────────────────────────────┐
│  個別学習ブラウザ                                                      │
│                                                                      │
│  ┌──────────────┐  ┌──────────────────────────────────────────────┐  │
│  │ エージェント │  │ アナリスト の学習ノート (89件)               │        │
│  │               │  │                                              │ │
│  │ ● 社長 (42)   │  │  フィルタ: [全カテゴリ ▼]  ソート: [最新順 ▼]│      │
│  │ ● リサーチ(67)│  │                                              │  │
│  │ ◉ アナリスト │  │  カテゴリ分布:                               │     │
│  │   (89)       │  │   technique: 34  pattern: 28  insight: 15    │  │
│  │ ● プランナー │  │   data_source: 8  mistake: 4                 │    │
│  │   (31)       │  │                                              │  │
│  │ ● ツールSP   │  │                                              │   │
│  │   (25)       │  │                                              │  │
│  │ ● キュレーター│ │                                              │    │
│  │   (38)       │  │                                              │  │
│  │               │  │  ┌────────────────────────────────────────┐ │  │
│  │               │  │  │ #89 [technique] 2026-03-07              │ │ │
│  │               │  │  │                                        │ │  │
│  │               │  │  │ 「サンプル数30未満の仮説はinconclusive │ │      │
│  │               │  │  │  判定を徹底する。n=15で有意とした過去の│ │       │
│  │               │  │  │  判定3件中2件が後にrejectされた」      │ │      │
│  │               │  │  │                                        │ │  │
│  │               │  │  │  success_rate: 0.85  適用回数: 12      │ │   │
│  │               │  │  │  元の振り返り: Cycle #120 (self: 8)    │ │    │
│  │               │  │  └────────────────────────────────────────┘ │  │
│  │               │  │                                              │ │
│  │               │  │  ┌────────────────────────────────────────┐ │  │
│  │               │  │  │ #88 [pattern] 2026-03-06                │ │ │
│  │               │  │  │                                        │ │  │
│  │               │  │  │ 「beauty系の仮説は季節性を3段階で考慮  │ │       │
│  │               │  │  │  すべき: 高(12-2月), 中(3-5月,9-11月), │ │    │
│  │               │  │  │  低(6-8月)。高シーズンの的中率+15%」   │ │      │
│  │               │  │  │                                        │ │  │
│  │               │  │  │  success_rate: 0.72  適用回数: 5       │ │   │
│  │               │  │  │  元の振り返り: Cycle #118 (self: 4.2)  │ │    │
│  │               │  │  └────────────────────────────────────────┘ │  │
│  │               │  │                                              │ │
│  │               │  │  ┌────────────────────────────────────────┐ │  │
│  │               │  │  │ #85 [mistake] 2026-03-04                │ │ │
│  │               │  │  │                                        │ │  │
│  │               │  │  │ 「techニッチでn=5の急伸を過大評価し、  │ │       │
│  │               │  │  │  リソース増加を推奨した。結果は一時的な│ │        │
│  │               │  │  │  バズで翌週に平均以下に戻った」        │ │       │
│  │               │  │  │                                        │ │  │
│  │               │  │  │  success_rate: 0.90  適用回数: 8       │ │   │
│  │               │  │  │  (この失敗を避ける判断の成功率)        │ │      │
│  │               │  │  │  元の振り返り: Cycle #112 (self: 3.0)  │ │    │
│  │               │  │  └────────────────────────────────────────┘ │  │
│  └──────────────┘  └──────────────────────────────────────────────┘  │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

**データソース**: `agent_individual_learnings` テーブル + `agent_reflections` テーブル (source_reflection_id でJOIN)。

**主な機能**:

| 機能 | 説明 |
|---|---|
| **エージェント選択** | 左パネルから対象エージェントを選択。各エージェント名の横に学習総数を表示 |
| **カテゴリフィルタ** | `data_source` / `technique` / `pattern` / `mistake` / `insight` の5カテゴリで絞り込み |
| **カテゴリ分布表示** | 各カテゴリの件数を表示。どの種類の知見が多いかでエージェントの特性を把握 |
| **success_rate表示** | 各知見が実際に適用されたときの成功率。0.80以上 = 高信頼、0.50未満 = 要見直し |
| **適用回数** | `times_applied` カラム。多いほど実践で活用されている知見 |
| **元の振り返りリンク** | `source_reflection_id` を辿り、この知見が生まれたサイクルの振り返り全文を表示 |
| **成長軌跡グラフ** | カード詳細画面で `self_score` の時系列グラフを表示。振り返りポイントをホバーで内容確認可能 |

### 6.9 エージェントからの受信トレイ (Agent Inbox)

エージェントが人間マネージャーに対して **自発的に送信するメッセージ** を一元管理する受信トレイ。`agent_communications` テーブルのデータを表示し、人間の返信を `human_directives` テーブルに書き込む。6.4の「人間→エージェント」の指示フローとは逆方向の「エージェント→人間」のコミュニケーションチャネル。

#### 受信トレイUI

```
┌─────────────────────────────────────────────────────────────────────┐
│  エージェント受信トレイ                              未読: 5 件         │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │ フィルタ                                                      │   │
│  │                                                               │  │
│  │  送信元: [全エージェント ▼]  種別: [全て ▼]                   │      │
│  │  優先度: [全て ▼]  期間: [過去7日 ▼]  状態: [未読優先 ▼]      │       │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │ ■ [urgent] プランナー — 2026-03-07 14:32          ● 未読      │    │
│  │                                                               │  │
│  │  種別: struggle (困りごと報告)                                │    │
│  │                                                               │  │
│  │  「tech系クラスターの制作計画で、承認率が3サイクル連続で      │          │
│  │   50%を下回っています。社長からの差し戻し理由は "コスト過大"  │          │
│  │   ですが、techニッチの制作コストを下げる方法が見つかりません。│           │
│  │   コスト上限の見直し、もしくはtechニッチの一時縮小を          │         │
│  │   ご検討いただけないでしょうか?」                             │       │
│  │                                                               │  │
│  │  ┌──────────────────────────────────────────────────────┐    │   │
│  │  │ 返信を入力...                                        │    │     │
│  │  │                                                       │    │  │
│  │  │  [返信 (human_directiveとして送信)]                   │    │    │
│  │  └──────────────────────────────────────────────────────┘    │   │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │   [high] アナリスト — 2026-03-07 10:15            ● 未読      │    │
│  │                                                               │  │
│  │  種別: proposal (提案)                                        │   │
│  │                                                               │  │
│  │  「beauty系の仮説的中率が65%に到達しました (目標達成)。       │         │
│  │   一方でtech系は28%と低迷しています。                         │      │
│  │   提案: beauty系のアプローチをtech系に横展開する実験を        │        │
│  │   実施してはどうでしょうか? 具体的には:                       │       │
│  │   (1) ER重視の仮説生成基準をtech系にも適用                    │       │
│  │   (2) beauty系で効果が確認されたHookパターンをtech系で検証」  │        │
│  │                                                               │  │
│  │  [返信する]                                                   │   │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │   [normal] リサーチャー — 2026-03-06 09:00        ○ 既読      │    │
│  │                                                               │  │
│  │  種別: status_report (状況報告)                               │    │
│  │                                                               │  │
│  │  「今週の市場データ収集状況: TikTok 450件, YouTube 380件,     │       │
│  │   Instagram 290件。TikTokのbeautyトレンドで新しい動きを       │      │
│  │   検出しました (K-beauty × sustainability)。                  │    │
│  │   トレンド信頼度は中程度 (3日間の継続を確認)。」              │         │
│  │                                                               │  │
│  │  返信済み: 「引き続きモニタリングして。1週間継続したら        │          │
│  │   アナリストにも共有して仮説に組み込んで」(2026-03-06 11:20)  │        │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**メッセージ種別** (`agent_communications.message_type`):

| 種別 | 説明 | 例 |
|---|---|---|
| `struggle` | 困りごと・解決できない問題の報告 | 「tech系の承認率が低い。コスト上限を見直してほしい」 |
| `proposal` | エージェントからの改善提案 | 「beauty系のアプローチをtech系に横展開する実験を提案」 |
| `question` | 判断を仰ぐ質問・確認事項 | 「beauty系の仮説でABテストを実施してよいか?」 |
| `status_report` | 定期的な状況報告 | 「今週の市場データ収集状況: TikTok 450件...」 |
| `anomaly_alert` | 異常値・想定外事象の報告 | 「ACC_0015のフォロワーが24時間で-20%。原因調査中」 |
| `milestone` | 目標達成・成果の報告 | 「beauty系の仮説的中率が目標の65%に到達しました」 |

#### 返信フロー

人間がメッセージに返信すると、その返信内容は `human_directives` テーブルに新規INSERTされ、元のメッセージの `agent_communications.human_response` にも記録される。エージェントは次サイクル開始時に `get_human_responses` ツールで返信を読み取る。

```
┌───────────── ┐     受信トレイで閲覧    ┌─────────────────   ┐
│ agent_       │ ──────────────────────► │ ダッシュボード     │
│communications│                         │ (受信トレイUI)     │
│              │                         │                  │
│ message_type │     返信入力            │ 人間が返信を        │
│ content      │ ◄────────────────────── │ テキスト入力       │
│ priority     │                         └─────────┬────────┘
│ status       │                                            │
└──────────────┘                                            │
       ▲                                           │ 2つのテーブルに書き込み
       │ human_response                                      │
       │ UPDATE                                              │
       │                                            ▼
       │                              ┌──────────────────────┐
       └───────────────────────────── │ human_directives     │
                                      │                       │
                                      │ directive_type =      │
                                      │   'agent_response'    │
                                      │ target_agents =       │
                                      │   [送信元agent_type]   │
                                      │ content = 返信内容     │
                                      └───────────────────────┘
                                              │
                                              │ 次サイクル開始時に読み取り
                                              ▼
                                      ┌───────────────────────┐
                                      │ 対象エージェント        │
                                      │                       │
                                      │ get_human_responses() │
                                      └───────────────────────┘
```

#### 週次ダイジェスト

1週間分のエージェントコミュニケーションをサマリ表示する。マネージャーが「今週チームに何が起きたか」を素早く把握するための集約ビュー。

```
┌─────────────────────────────────────────────────────────────────────┐
│  週次ダイジェスト — 2026-03-01 〜 2026-03-07                           │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ サマリ                                                      │     │
│  │                                                             │    │
│  │  受信メッセージ: 18件                                       │      │
│  │    ├── struggle:  3件  (プランナー2, リサーチャー1)          │       │
│  │    ├── proposal:  4件  (アナリスト2, プランナー1, 社長1)     │       │
│  │    ├── status:    8件  (全エージェントから各2件)              │      │
│  │    ├── anomaly:   1件  (アナリスト)                          │     │
│  │    └── milestone: 2件  (アナリスト1, リサーチャー1)          │       │
│  │                                                             │    │
│  │  返信済み: 12件 / 未返信: 6件                               │       │
│  │  平均返信時間: 3.2時間                                      │      │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ 注目トピック                                                │      │
│  │                                                             │    │
│  │  1. [要対応] プランナーのtech系承認率低下 (struggle x2)     │         │
│  │     → 未返信。コスト上限見直し or ニッチ縮小の判断が必要    │           │
│  │                                                             │    │
│  │  2. [提案] アナリストのbeauty→tech横展開実験                │        │
│  │     → 返信済み「来週から小規模で実験開始」                  │          │
│  │                                                             │    │
│  │  3. [達成] beauty系仮説的中率65%到達                        │       │
│  │     → マイルストーン達成。次の目標設定を検討                │          │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ エージェント別コミュニケーション頻度                        │          │
│  │                                                             │    │
│  │  ┌───────────┬────────┬────────┬────────┬────────┬────────┐│     │
│  │  │ Agent     │struggle│proposal│status  │anomaly │ total  ││     │
│  │  ├───────────┼────────┼────────┼────────┼────────┼────────┤│     │
│  │  │ 社長      │   0    │   1    │   2    │   0    │   3    ││      │
│  │  │ リサーチ   │   1    │   0    │   2    │   0    │   3    ││     │
│  │  │ アナリスト │   0    │   2    │   2    │   1    │   5    ││      │
│  │  │ プランナー │   2    │   1    │   2    │   0    │   5    ││      │
│  │  │ ツールSP   │   0    │   0    │   2    │   0    │   2    ││     │
│  │  │ キュレーター│  0    │   1    │   2    │   0    │   3    ││      │
│  │  └───────────┴────────┴────────┴────────┴────────┴────────┘│     │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**ダイジェスト集計クエリ**:

```sql
-- 週次ダイジェスト: メッセージ種別 × エージェント別集計
SELECT
    agent_type,
    message_type,
    COUNT(*) as count,
    COUNT(*) FILTER (WHERE status = 'unread') as unread_count,
    COUNT(*) FILTER (WHERE human_response IS NOT NULL) as responded_count
FROM agent_communications
WHERE created_at >= NOW() - INTERVAL '7 days'
GROUP BY agent_type, message_type
ORDER BY agent_type, count DESC;
```

**生成方法**: カウント・集計はSQLクエリで算出。「注目トピック」のナラティブ要約はClaude Sonnet 4.5による自動生成 (週次cronジョブ)。結果は `agent_communications` テーブルの `weekly_digest` エントリとして保存。

**主な機能**:

| 機能 | 説明 |
|---|---|
| **未読バッジ** | ヘッダーに未読メッセージ数をバッジ表示。urgentメッセージは赤バッジ |
| **優先度ソート** | urgent > high > normal > low の優先度順にソート。同優先度内は新しい順 |
| **送信元フィルタ** | 特定エージェントからのメッセージのみ表示 |
| **種別フィルタ** | `struggle` / `proposal` / `question` / `status_report` / `anomaly_alert` / `milestone` で絞り込み |
| **返信→human_directive** | 返信テキストを入力すると `human_directives` にINSERT + `agent_communications.human_response` にUPDATE |
| **週次ダイジェスト** | 1週間分を自動集約。未返信の重要メッセージをハイライト表示 |
| **返信テンプレート** | よくある返信パターンをワンクリックで挿入 (「了解、継続して」「詳細を報告して」「提案を承認、実行して」等) |
| **レート制限** | エージェントあたり最大10件/日。urgent以外のメッセージは上限到達時にバッファリングされ、翌日配信 |

### 6.10 ダッシュボード画面一覧

ダッシュボードは以下の15画面で構成される。

| # | 画面名 | 主な機能 | データソース |
|---|--------|---------|------------|
| 1 | **ダッシュボード（ホーム）** | KPI概要, 本日の制作状況, 直近のアラート | metrics, content, task_queue |
| 2 | **KPI** | アカウント別/期間別KPI進捗, 目標vs実績グラフ | metrics, accounts, algorithm_performance |
| 3 | **制作キュー** | task_queue一覧, ステータス別フィルター, 優先度変更 | task_queue, content |
| 4 | **コンテンツレビュー** | pending_review一覧, プレビュー+承認/差戻し | content (review_status) |
| 5 | **コンテンツ一覧** | 全content検索, ステータス別フィルター | content, publications |
| 6 | **アカウント管理** | accounts CRUD, OAuth設定, 認証情報入力 | accounts |
| 7 | **キャラクター管理** | characters CRUD, アセットアップロード | characters, Google Drive |
| 8 | **エージェント** | 各エージェントの状態, 思考ログ, 反省, 学習 | agent_thought_logs, agent_reflections, agent_individual_learnings |
| 9 | **仮説ブラウザ** | hypotheses一覧, 的中率推移, カテゴリ別分析 | hypotheses |
| 10 | **知見ブラウザ** | learnings一覧, 信頼度別フィルター, 類似知見検索 | learnings |
| 11 | **ツール管理** | tool_catalog, レシピ管理, ツール経験一覧 | tool_catalog, production_recipes, tool_experiences |
| 12 | **エラーログ** | failed/retrying タスク一覧, リトライ/破棄操作 | task_queue (status IN retrying, failed_permanent) |
| 13 | **コスト管理** | 日次/月次API支出, 予算消化率, アラート | system_settings (cost_control), task_queue |
| 14 | **設定** | system_settings全項目のカテゴリ別表示+編集 | system_settings |
| 15 | **人間指示** | human_directives作成, 履歴閲覧 | human_directives |

### 6.11 ダッシュボード機能一覧 (サマリ)

```
┌──────────────────────────────────────────────────────────────────────┐
│                    Next.js Dashboard — 機能全体像                      │
│                                                                      │
│  ┌─── 監視系 (Read-Only) ─────────────────────────────────────────┐   │
│  │                                                                │  │
│  │  6.1 基本監視                                                  │   │
│  │  ├── KPI進捗モニタ (目標vs実績, アカウント別, 日次/週次)       │        │
│  │  ├── アルゴリズム精度推移 (仮説的中率, 学習曲線, ジャンル別)   │         │
│  │  ├── 投稿別パフォーマンス (views, engagement, 比較)            │      │
│  │  ├── 学習ログ (知見一覧, 仮説→結果, 改善提案)                  │       │
│  │  └── エージェント実行ログ (タスク状況, エラー率)               │        │
│  │                                                                │  │
│  │  6.3 エージェント思考ログビューア                              │      │
│  │  ├── エージェント別/サイクル別/日付別フィルタ                  │        │
│  │  ├── 読み取りデータ → 考慮事項 → 判断 の追跡                   │       │
│  │  └── MCPツール呼び出し詳細の展開表示                           │      │
│  │                                                                │  │
│  │  6.5 エージェント進化ダッシュボード                            │       │
│  │  ├── 蓄積知見数/仮説的中率/品質スコア 時系列グラフ             │         │
│  │  ├── エージェント別パフォーマンスKPI                           │      │
│  │  ├── 学習停滞・退行アラート                                    │     │
│  │  └── 学習方法レビュー (リフレクション確認, 学習指導送信)       │         │
│  │                                                                │  │
│  │  6.7 推奨プロンプト改善パネル                         ← NEW    │      │
│  │  ├── self_score低下傾向検知 → 改善提案表示                     │      │
│  │  ├── thought_logs分析による改善箇所の特定                      │      │
│  │  └── ワンクリックでプロンプト編集画面に遷移                    │        │
│  │                                                                │  │
│  │  6.8 エージェント個別成長トラッキング                          │       │
│  │  ├── 個別パフォーマンスカード (self_score, 学習数, 振返り)     │        │
│  │  ├── エージェント成長比較ビュー (ランキング, 推移グラフ)       │         │
│  │  └── 個別学習ブラウザ (カテゴリ別, success_rate表示)           │       │
│  │                                                                │  │
│  │  6.9 エージェント受信トレイ (監視部分)                         │       │
│  │  ├── 受信メッセージ一覧 (優先度/未読バッジ)                    │       │
│  │  └── 週次ダイジェスト (種別集計, 注目トピック)                 │        │
│  │                                                                │  │
│  │  6.12 キュレーション結果レビュー (監視部分)            ← NEW   │       │
│  │  ├── データキュレーターが生成したコンポーネント一覧            │         │
│  │  ├── キュレーター自信度 (confidence) + 元データのプレビュー    │        │
│  │  └── コンポーネント種別別の統計 (scenario/motion/audio/image)  │      │
│  │                                                                │  │
│  └────────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌─── 介入系 (Write) ─────────────────────────────────────────────┐   │
│  │                                                                │  │
│  │  6.1 基本介入                                                  │   │
│  │  ├── 仮説投入 (人間が仮説を直接追加)                           │      │
│  │  ├── 参考コンテンツURL指定                                     │     │
│  │  ├── 設定変更 (計測タイミング, 投稿頻度, コスト上限)           │        │
│  │  └── コンテンツ計画承認 (pending_approval→planned)      ← NEW  │     │
│  │       REQUIRE_HUMAN_APPROVAL=true時のみ表示                    │    │
│  │                                                                │  │
│  │  6.4 人間↔エージェント対話                                     │     │
│  │  ├── エージェント個別フィードバック (1on1)                     │       │
│  │  ├── 全体ブロードキャスト                                      │     │
│  │  └── 指示ステータス追跡 (pending→applied)                      │     │
│  │                                                                │  │
│  │  6.6 プロンプト管理                                            │    │
│  │  ├── プロンプト閲覧・編集 (マークダウンエディタ)               │        │
│  │  ├── バージョン管理 + 差分表示                                 │     │
│  │  ├── パフォーマンス比較 (before/after)                         │     │
│  │  └── チューニングテンプレート適用                              │      │
│  │                                                                │  │
│  │  6.5 学習方法レビュー (介入部分)                                │     │
│  │  └── 学習方法指導の送信 → human_directive (learning_guidance)   │    │
│  │                                                                │  │
│  │  6.7 推奨プロンプト改善パネル (介入部分)                ← NEW  │       │
│  │  ├── 改善提案の承認/却下/保留                                  │     │
│  │  └── 「プロンプト編集画面で適用」→ 6.6への遷移                 │        │
│  │                                                                │  │
│  │  6.9 エージェント受信トレイ (返信部分)                         │       │
│  │  ├── メッセージ返信 → human_directiveとして保存                │      │
│  │  └── 返信テンプレート適用                                      │     │
│  │                                                                │  │
│  │  6.12 キュレーション結果レビュー (介入部分)            ← NEW   │       │
│  │  ├── コンポーネントの承認/修正/削除                            │      │
│  │  ├── 参考コンテンツの提出 (URL/ファイル → キューに投入)        │        │
│  │  └── キュレーション対象タイプの指定 (scenario/motion等)        │       │
│  │                                                                │  │
│  └────────────────────────────────────────────────────────────────┘  │
│                                                                      │
│                        │ Prisma/Drizzle ORM                          │
│                        ▼                                             │
│                 PostgreSQL (直結)                                     │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

### 6.12 キュレーション結果レビュー (Curation Review)

データキュレーターが自動生成したコンポーネントを人間がレビュー・承認するためのパネル。初期フェーズ (`REQUIRE_AUTO_CURATION = true`) ではこのパネルで品質を確認し、信頼度が高まれば自動承認に移行する。

| 機能 | 種別 | 説明 |
|------|------|------|
| キュレーション結果一覧 | 監視 | `review_status = 'pending_review'` のコンポーネント一覧。種別・自信度・元データのプレビュー付き |
| コンポーネント承認/修正/削除 | 介入 | キュレーション結果の承認 (→ `human_approved`)、データ修正後の承認、不要コンポーネントの削除 |
| 参考コンテンツ提出 | 介入 | 人間が参考動画URL/参考投稿/ファイルIDを入力 → `task_queue` (type='curate') に投入 |
| キュレーション統計 | 監視 | 種別ごとの自動生成数、人間レビュー率、承認率の推移グラフ |

## 7. データフロー図

### 7.1 全体データフロー

システム全体のデータの流れを方向別に示す。

```
                          上→下: 方針・指示
                          下→上: 報告・データ
                          横:   判断材料の提供

┌────────────────────────────────────────────────────────────────────┐
│  Human Dashboard                                                   │
│                                                                    │
│  ・仮説投入 (下方向)  ・KPI確認 (上方向)  ・設定変更 (下方向)             │
│  ・計画承認 (pending_approval → planned, REQUIRE_HUMAN_APPROVAL時)   │
└─────────┬────────────────────▲──────────────────┬────────────────  ┘
          │                    │                                 │
    仮説・指示を          KPI進捗・             設定変更を
    DBに書込み           学習ログを表示          DBに書込み
          │                    │                                 │
          ▼                    │                  ▼
┌────────────────────────────────────────────────────────────────────┐
│  戦略サイクルグラフ                                                   │
│                                                                    │
│  ┌────────────┐    判断材料    ┌─────────────┐                      │
│  │ 戦略Agent  │◄────────────── │ リサーチャー│                       │
│  │ (Opus)     │    (横方向)    │ (Sonnet)    │                      │
│  │            │                │             │                     │
│  │  方針決定  │    判断材料    │ 市場データ  │                         │
│  │  承認/却下 │◄────────────── │ 収集        │                       │
│  └──────┬─────┘               └─────────────┘                      │
│         │                                                          │
│         │方針指示 (下方向)                                           │
│         │                                                          │
│  ┌──────▼─────┐    判断材料    ┌─────────────┐                      │
│  │ プランナー │◄────────────── │ アナリスト  │                        │
│  │ (Sonnet)   │    (横方向)    │ (Sonnet)    │                      │
│  │            │                │             │                     │
│  │ 計画策定   │                │ 仮説生成    │                       │
│  │ (planned)  │                │ 分析        │                      │
│  └──────┬─────┘               └─────────────┘                      │
│         │                                                          │
│         │ 計画確定後                                                 │
│         ▼                                                          │
│  ┌─────────────────┐                                               │
│  │ ツールスペシャ   │  ← select_tools ノード                          │
│  │ リスト (Sonnet)  │  各コンテンツに最適な制作レシピを設計               │
│  │                  │  (ツール組み合わせ + パラメータ推奨)              │
│  └──────┬──────────┘                                               │
│         │                                                          │
│         │ 制作指示 (下方向): content.status = 'planned'              │
└─────────┼──────────────────────────────────────────────────────────┘
                                                                 │
          ▼
┌────────────────────────────────────────────────────────────────────┐
│  制作パイプライングラフ                                               │
│                                                                    │
│  planned → レシピに基づき制作実行 → producing → ready                 │
│  (レシピは戦略サイクルのselect_toolsノードで事前設計済み)                 │
│  動画制作ワーカー / テキスト制作ワーカー の2系統で実行                    │
│                                                                    │
│  完了報告 (上方向): content.status = 'ready'                         │
└─────────┬──────────────────────────────────────────────────────────┘
                                                                 │
          │ 投稿指示 (下方向): publications.status = 'scheduled' + planned_post_date到来
          ▼
┌────────────────────────────────────────────────────────────────────┐
│  投稿スケジューラーグラフ                                              │
│                                                                    │
│  ready → scheduled → posted                                        │
│                                                                    │
│  完了報告 (上方向): posted_at, measure_after 記録                     │
└─────────┬──────────────────────────────────────────────────────────┘
                                                                 │
          │ 計測対象 (下方向): NOW() > measure_after
          ▼
┌────────────────────────────────────────────────────────────────────┐
│  計測ジョブグラフ                                                    │
│                                                                    │
│  publications.status: posted → measured (各publication個別)         │
│  content.status: → analyzed (全publicationsがmeasured後)            │
│                                                                    │
│  パフォーマンスデータ (上方向): metricsテーブルに時系列保存               │
│  → 次の戦略サイクルでリサーチャー・アナリストが参照                       │
└────────────────────────────────────────────────────────────────────┘

          ┌──────────────────────────────────────────────────────┐
          │  データキュレーターグラフ (横断的に動作)                   │
          │                                                      │
          │  外部ソース (Drive, 参考URL, 人間提出) → 構造化          │
          │  → components テーブルに保存 (review_status管理)        │
          │  → 人間レビュー後に human_approved → 制作で利用可能       │
          │                                                      │
          │  task_queue (type='curate') 経由でタスク受信           │
          └──────────────────────────────────────────────────────┘

                    ▼ 全データの最終保存先 ▼

┌──────────────────────────┐    ┌──────────────────────────          ┐
│ PostgreSQL               │    │ Google Drive                       │
│                          │    │                                    │
│ ・content (ステータス)   │    │ ・final.mp4                          │
│ ・components (素材)      │    │ ・section_01.mp4                    │
│・metrics (パフォーマンス)│    │ ・section_02.mp4                      │
│ ・hypotheses (仮説)      │    │ ・section_03.mp4 ...                │
│ ・learnings (知見)       │    │ ・キャラクター画像                     │
│ ・agent_thought_logs     │    │                                    │
│                          │    │                                    │
│ （主要テーブルのみ。     │    │                                       │
│  全26テーブルは          │    │                                      │
│  03-database-schema.md   │    │                                    │
│  参照）                  │    │                                     │
└──────────────────────────┘    └──────────────────────────          ┘
```

### 7.2 エージェント共通のデータアクセスパターン

全エージェントは同一のパターンでデータにアクセスする。

```
エージェント (LangGraph ノード)
    │
    │  1. MCPツールを選択
    │     (例: get_account_performance)
    │
    │  2. 引数を指定
    │     (例: { account_id: "ACC_0013", period: "7d" })
    │
    ▼
MCP Server
    │
    │  3. 入力バリデーション
    │  4. SQLクエリ構築
    │     SELECT ... FROM metrics m
    │     JOIN publications p ON m.publication_id = p.id
    │     JOIN accounts a ON p.account_id = a.account_id
    │     WHERE a.account_id = $1
    │     AND p.posted_at > NOW() - INTERVAL '7 days'
    │
    │  5. クエリ実行
    │  6. 結果フォーマット
    │
    ▼
エージェントに返却
    {
      "account_id": "ACC_0013",
      "period": "7d",
      "total_views": 12500,
      "avg_engagement_rate": 0.045,
      "top_performing_content": "CNT_202603_0042",
      "trend": "improving"
    }
```

## 8. コンテンツライフサイクル

### 8.1 ステータス遷移

v5.0では **2層ステータス管理** を採用する。コンテンツの制作ライフサイクル (`content.status`) と、各投稿先のライフサイクル (`publications.status`) を分離する。

**content.status** (制作ライフサイクル):

```
                    REQUIRE_HUMAN_APPROVAL=true の場合:
pending_approval ──→ planned ──→ producing ──→ ready ──→ analyzed
       │               │            │           │           │
       ▼               ▼            ▼           ▼           ▼
  Dashboard承認    戦略サイクル  制作PL     制作PL    戦略サイクル
  待ち (人間)      グラフ       グラフ      グラフ    (次サイクル)

                    REQUIRE_HUMAN_APPROVAL=false の場合:
                    planned ──→ producing ──→ ready ──→ analyzed
                    (pending_approval をスキップ)
```

**publications.status** (投稿ライフサイクル、contentが `ready` になった後にN件作成):

```
content.status = 'ready'
         │
         ▼
    ┌───────────────────────────────────────────────────┐
    │  publications (N件、各platform/accountに1件)        │
    │                                                   │
    │  pub#1 (YouTube):  scheduled → posted → measured  │
    │  pub#2 (TikTok):   scheduled → posted → measured  │
    │  pub#3 (Instagram): scheduled → posted → measured │
    └───────────────────────────────────────────────────┘
         │
         │ 全publicationsが measured になった後
         ▼
content.status = 'analyzed'
```

**エラー時の分岐**:

```
content:
  producing ──→ error (制作失敗)
                  │
                  └──→ planned (リトライ対象として再キューイング)

  pending_approval ──→ cancelled (人間が差戻し後に取消)

publications:
  posted ──→ failed (投稿失敗)
                │
                └──→ scheduled (再投稿対象として戻す)
```

**リトライポリシー**:

| 対象 | 最大リトライ回数 | バックオフ戦略 | 上限超過時の動作 |
|---|---|---|---|
| content (制作エラー) | 3回 | 指数バックオフ (1min, 5min, 30min) | `error` ステータスに固定。ダッシュボードに通知 |
| publications (投稿失敗) | 3回 | 指数バックオフ (5min, 30min, 2h) | `failed` ステータスに固定。ダッシュボードに通知 |
| 外部API呼び出し (fal.ai等) | 5回 | 指数バックオフ (10s, 30s, 90s, 270s, 810s) | 呼び出し元のタスクをエラーに遷移 |

### 8.2 ステータス定義

**content テーブルのステータス**:

| ステータス | 意味 | 設定するグラフ | 主要なカラム |
|---|---|---|---|
| `pending_approval` | AI承認済み、人間の承認待ち (`REQUIRE_HUMAN_APPROVAL=true` 時のみ) | 戦略サイクル | `planned_post_date`, `character_id` |
| `planned` | 制作計画が承認済み。制作待ち | 戦略サイクル / Dashboard承認 | `planned_post_date`, `character_id` |
| `producing` | 動画生成中 | 制作パイプライン | `production_metadata` |
| `ready` | 動画完成。投稿待ちプール内 | 制作パイプライン | `drive_folder_id`, `video_drive_id` |
| `analyzed` | 全publicationsの計測完了後、分析結果が知見として保存済み | 戦略サイクル (次回) | — |
| `error` | 制作で回復不能エラー発生 (終端ステータス。リトライ上限超過) | 制作パイプライン | `error_message` |
| `cancelled` | 人間orエージェントが取消 (終端ステータス) | 任意 | — |

**publications テーブルのステータス**:

| ステータス | 意味 | 設定するグラフ | 主要なカラム |
|---|---|---|---|
| `scheduled` | 投稿スケジュール確定 | 投稿スケジューラー | `content_id`, `account_id` |
| `posted` | 投稿完了 | 投稿スケジューラー | `posted_at`, `platform_post_id`, `measure_after` |
| `measured` | パフォーマンス計測完了 (最大3回) | 計測ジョブ | metrics テーブルにレコード追加 |
| `failed` | 投稿失敗 (APIエラー、アカウントBAN等) | 投稿スケジューラー | `metadata` にエラー詳細 |

### 8.3 時間軸とタイムスタンプ

```
時間軸 ──────────────────────────────────────────────────────────→

D-3                D-1             D (当日)           D+2
│                  │               │                  │
│ planned_post_date│               │                  │
│ の設定           │               │ posted_at        │ measure_after
│                  │ ready         │ (実際の投稿時刻) │ (posted_at + 48h)
│                  │ (制作完了)    │                   │
│                  │               │                  │
▼                  ▼               ▼                  ▼
planned           ready          posted            measured
└─ 戦略サイクル ──┘ └─ 制作PL ──┘ └─ 投稿 ────────┘ └─ 計測 ──→ analyzed
```

| タイムスタンプ | 説明 | 設定タイミング | 変更可否 |
|---|---|---|---|
| `planned_post_date` | 投稿予定日。数日前に計画する (**content テーブル**) | 戦略サイクルで `planned` 設定時 | ダッシュボードから変更可 |
| `started_at` | 制作開始日時 (**task_queue テーブル**。contentではなくタスクキューで管理) | タスクが `processing` に遷移した時 | 不可 |
| `posted_at` | 実際の投稿日時 (**publications テーブル**) | 投稿スケジューラーで `posted` 設定時 | 不可 |
| `measure_after` | 計測開始可能日時。デフォルト `posted_at + 48h` (**publications テーブル**) | 投稿完了時に自動計算 | ダッシュボードから計測間隔を変更可 |
| `measured_at` | 計測実行日時 (**metrics テーブル**。各計測レコードに記録) | 計測ジョブで metrics レコード作成時 | 不可 |

## 9. エラーリカバリーアーキテクチャ

### 9.1 3段階リカバリーモデル

本システムは外部API依存度が高いため（fal.ai, Fish Audio, Claude API, 各プラットフォームAPI）、
障害発生を前提とした3段階のリカバリーモデルを採用する。

#### Level 1: API呼び出しレベル（自動リトライ）

| 設定キー | デフォルト値 | 説明 |
|---------|------------|------|
| `MAX_RETRY_ATTEMPTS` | 3 | 最大リトライ回数 |
| `RETRY_BACKOFF_BASE_SEC` | 2 | 指数バックオフ基準秒数 |

リトライ待機時間 = `RETRY_BACKOFF_BASE_SEC` × 2^(attempt - 1)
- 1回目: 2秒後
- 2回目: 4秒後
- 3回目: 8秒後

対象エラー（リトライ可能）:
- HTTP 429 (Rate Limit) — 必ずリトライ
- HTTP 500/502/503 (Server Error) — リトライ
- HTTP 408 (Timeout) — リトライ
- Network Error (ECONNRESET, ETIMEDOUT) — リトライ

対象外エラー（即座に失敗）:
- HTTP 400 (Bad Request) — パラメータ不正、リトライしても同じ結果
- HTTP 401/403 (Unauthorized/Forbidden) — 認証問題、人間の介入が必要
- HTTP 422 (Unprocessable) — 入力データ不正

#### Level 2: タスクレベル（LangGraphチェックポイントリカバリー）

LangGraph.jsのdurable execution機能を活用:
- 各グラフノード完了時にPostgreSQLにチェックポイントを自動保存
- 障害発生時、最後の完了ノードから再開（全体の再実行は不要）
- 動画制作パイプライン（〜12分）の途中障害でも、完了セクションは保持

チェックポイント保存先: PostgreSQLの専用テーブル（LangGraph管理）
保持期間: 7日間（設定キー `CHECKPOINT_RETENTION_DAYS`、デフォルト: 7）

#### Level 3: パイプラインレベル（ステータスベースリカバリー）

`content.status` と `task_queue.status` の遷移を利用した障害復旧:
- `producing` 中に障害 → 再起動時に `status='producing'` のレコードを検出 → 再開
- `failed_permanent` → ダッシュボードに表示、人間が判断（リトライ or 破棄）

### 9.2 エスカレーションフロー

```
API呼び出し失敗
  │
  ▼
Level 1: 自動リトライ (MAX_RETRY_ATTEMPTS回)
  │
  │ (全リトライ失敗)
  ▼
Level 2: LangGraphチェックポイントから再開
  │
  │ (再開も失敗)
  ▼
Level 3: task_queue.status → 'failed_permanent'
  │
  ▼
ダッシュボードのエラーログに表示
  │
  ▼
人間が判断: リトライ / パラメータ変更して再実行 / 破棄
```

### 9.3 ダッシュボードでのエラー可視化

エラーログビューア（ダッシュボード画面 #12）:
- `task_queue WHERE status IN ('retrying', 'failed_permanent')` を一覧表示
- 各タスクの `last_error`, `retry_count`, `last_error_at` を表示
- 「再試行」ボタン: `status → 'pending'`, `retry_count → 0` にリセット
- 「破棄」ボタン: `status → 'failed'`, 関連 `content.status → 'cancelled'`
- フィルター: `task_type` 別, 期間別, エラー種類別

影響範囲表示:
- 失敗したタスクに関連する `content`, `account`, `character` を表示
- 同じエラーが複数タスクで発生している場合はグルーピング表示

## 10. コンテンツレビューワークフロー

### 10.1 レビューフロー概要

コンテンツの品質を人間が確認してから投稿する仕組み。
`system_settings.HUMAN_REVIEW_ENABLED` で有効/無効を切り替え可能。

#### コンテンツライフサイクル（レビュー有効時）

```
planned → producing → ready
  → (quality_score >= AUTO_APPROVE_SCORE_THRESHOLD の場合)
    → approved (自動承認) → posted → measured
  → (quality_score < AUTO_APPROVE_SCORE_THRESHOLD の場合)
    → pending_review → approved → posted → measured
                     → rejected → revision_needed → producing (再制作)
```

#### コンテンツライフサイクル（レビュー無効時）

```
planned → producing → ready → posted → measured
```

### 10.2 レビューダッシュボード

レビュー待ちキュー画面（ダッシュボード画面 #4）:
- `content WHERE review_status = 'pending_review'` を一覧表示
- プレビュー: 動画サムネイル + スクリプト + 使用コンポーネント一覧
- 承認ボタン: `review_status → 'approved'`, `content.status → 'approved'`
- 差し戻しボタン: `reviewer_comment` 入力 → `review_status → 'rejected'`, `content.status → 'revision_needed'`

差し戻し時のフロー:
1. 人間が `reviewer_comment` に理由を記載（例: 「フックが弱い」「ブランドイメージと不一致」）
2. `content.revision_count += 1`
3. 新しい `human_directives` レコード生成 (`directive_type='content_review_result'`)
4. Production Pipeline Graphが再制作をキューイング
5. Plannerが `reviewer_comment` を参照して改善指示を含むコンテンツプランを再生成

### 10.3 自動承認の条件

`HUMAN_REVIEW_ENABLED = true` の場合でも、以下の全条件を満たせば自動承認:
- `quality_score >= AUTO_APPROVE_SCORE_THRESHOLD` (デフォルト: 8.0)
- `revision_count = 0` (初回生成であること)
- 該当アカウントの直近10件の承認率が100%であること

これにより、学習が進んで品質が安定したアカウントは徐々に自動承認に移行する。

## 11. システム設定管理（ソフトコーディング原則）

### 11.1 設計原則

全ての設定値は `system_settings` テーブルに格納し、ハードコーディングを禁止する。
これにより:
- ダッシュボードから任意のタイミングで設定変更が可能
- 変更履歴が `updated_at`, `updated_by` で追跡可能
- デフォルト値へのリセットが容易

### 11.2 設定値の読み込みパターン

各エージェント/ワーカーは起動時とポーリング時に `system_settings` を参照:

```typescript
// MCP Server側のツール実装パターン
async function getSetting(key: string): Promise<any> {
  const row = await db.query(
    'SELECT setting_value, value_type FROM system_settings WHERE setting_key = $1',
    [key]
  );
  return castValue(row.setting_value, row.value_type);
}
```

キャッシュ戦略:
- LangGraphグラフの各サイクル開始時に全設定をバッチ取得
- サイクル中は変更されない（一貫性保証）
- 次サイクル開始時に最新値を再取得

### 11.3 ダッシュボードの設定画面

カテゴリ別タブ表示（ダッシュボード画面 #14）:

| カテゴリ | 含まれる設定例 |
|---------|-------------|
| Production | 同時制作数、ポーリング間隔、リトライ、品質フィルター |
| Posting | ポーリング間隔、投稿上限、時刻ジッター |
| Review | レビュー有効/無効、自動承認閾値、戦略承認、レシピ承認 |
| Agent | サイクル間隔、異常検知閾値、学習閾値、重複検知閾値 |
| Measurement | 収集遅延、リトライ間隔、最大試行回数 |
| Cost Control | 日次/月次予算上限、残高アラート |
| Dashboard | テーマ、ページ件数、自動更新間隔 |
| Credentials | APIキー入力（マスク表示） |

各設定項目の表示:
- 現在値 + デフォルト値
- 値の型と制約（min/max, options）
- 最終更新日時と更新者
- 「リセット」ボタン（デフォルト値に戻す）

## 12. クレデンシャル管理アーキテクチャ

### 12.1 プラットフォーム認証情報

各アカウントのOAuth認証情報は `accounts.auth_credentials` (JSONB) に格納。
ダッシュボードのアカウント管理画面（画面 #6）から入力・更新。

プラットフォーム別スキーマ:

| プラットフォーム | 識別子 | 認証方式 | 主要フィールド |
|---------------|-------|---------|-------------|
| YouTube | `channel_id` | OAuth2 | `client_id`, `client_secret`, `refresh_token` |
| TikTok | `open_id` | OAuth2 | `client_key`, `client_secret`, `access_token`, `refresh_token` |
| Instagram | `ig_user_id` + `page_id` | Facebook OAuth | `app_id`, `app_secret`, `long_lived_token` |
| X | `user_id` | OAuth 1.0a | `api_key`, `api_secret`, `access_token`, `access_token_secret` |

トークンリフレッシュ:
- YouTube: `refresh_token` → `access_token` 自動更新（Posting Worker実行時）
- TikTok: 24時間有効 → `refresh_token` で自動更新
- Instagram: `long_lived_token` 60日有効 → 期限前に自動更新
- X: OAuth 1.0aのためトークン更新不要

### 12.2 ツールAPIキー

外部サービスのAPIキーは `system_settings` (`category='credentials'`) に格納:

| 設定キー | サービス | 用途 |
|---------|---------|------|
| `CRED_FAL_AI_API_KEY` | fal.ai | Kling動画生成, Sync Lipsync |
| `CRED_FISH_AUDIO_API_KEY` | Fish Audio | TTS音声合成 |
| `CRED_OPENAI_API_KEY` | OpenAI | Embedding生成 (text-embedding-3-small) |
| `CRED_ANTHROPIC_API_KEY` | Anthropic | Claude API (Opus/Sonnet) |

ダッシュボードでの表示: マスク表示 (`sk-***xxx`)、更新ボタンあり

### 12.3 ダッシュボードからの入力フロー

1. **アカウント追加**: platform選択 → 認証情報フォーム入力 → バリデーション → `accounts.auth_credentials` 保存
2. **APIキー設定**: サービス選択 → キー入力 → テスト呼び出しで検証 → `system_settings` 保存
3. **OAuthフロー支援**: 「OAuth認証開始」ボタン → ブラウザでOAuth画面 → コールバックで自動保存

## 13. 人間介入ポイント一覧

### 13.1 介入が必須な箇所（システムが代行不可能）

| # | 介入ポイント | 理由 | 頻度 |
|---|------------|------|------|
| 1 | プラットフォームアカウント作成 | メール・電話認証、利用規約同意が必要 | アカウント追加時 |
| 2 | OAuthコンセントフロー完了 | ブラウザでの人間操作が必須 | アカウント追加時 |
| 3 | ツールサービス登録+APIキー作成 | サービス利用規約同意、決済情報登録が必要 | 初回セットアップ時 |
| 4 | 決済手段設定 | クレジットカード情報はシステムが扱えない | 初回セットアップ時 |
| 5 | キャラクター初期アセットアップロード | 画像・音声素材の準備は人間のクリエイティブ判断 | キャラクター追加時 |
| 6 | インフラ構築 | Cloud SQL, GCE VM, ドメインのプロビジョニング | 初回のみ |
| 7 | system_settings初期確認 | デフォルト値の妥当性を人間が確認 | 初回のみ |

### 13.2 介入が選択可能な箇所（system_settingsで切り替え）

| # | 介入ポイント | 設定キー | デフォルト | 説明 |
|---|------------|---------|----------|------|
| 1 | コンテンツ投稿前レビュー | `HUMAN_REVIEW_ENABLED` | `true` | 品質確認してから投稿 |
| 2 | 戦略サイクルポリシー承認 | `STRATEGY_APPROVAL_REQUIRED` | `true` | 日次戦略の最終承認 |
| 3 | 新レシピ使用承認 | `RECIPE_APPROVAL_REQUIRED` | `true` | 未検証のツール組合せ |
| 4 | 仮説の手動注入 | — | 随時可能 | `human_directives` 経由 |
| 5 | リファレンスコンテンツ指定 | — | 随時可能 | `human_directives` 経由 |
| 6 | エージェントプロンプト編集 | — | 随時可能 | `agent_prompt_versions` |
| 7 | コンポーネント品質レビュー | — | Data Curator出力を確認 | キュレーションレビュー画面 |
| 8 | 予算増額承認 | — | 手動 | `cost_control` 設定変更 |
| 9 | 知見の有効性検証 | — | 随時可能 | `learnings` 確認画面 |
| 10 | 異常検知への対応 | — | アラート時 | `analyses` 確認画面 |
| 11 | 新アカウントオンボーディング | — | 随時 | アカウント管理画面 |

### 13.3 介入の段階的縮小

| フェーズ | 方針 | 説明 |
|---------|------|------|
| 初期（Phase 1-2） | 全ての選択的介入をON | 品質基準の学習、AIの判断精度を人間が検証 |
| 安定期（Phase 3-4） | `AUTO_APPROVE_SCORE_THRESHOLD` を下げ、自動承認を拡大 | 品質が安定したアカウントから段階的に自動化 |
| 成熟期（Phase 5+） | `HUMAN_REVIEW_ENABLED=false` に移行可能 | 品質が安定している場合、完全自動運用に移行 |

## 14. v4.0からの移行ポイント

### 14.1 移行対象一覧

| 項目 | v4.0 (現行) | v5.0 (新) | 移行方法 |
|---|---|---|---|
| **データストア** | Google Sheets (5 Spreadsheet + 1 Master) | PostgreSQL 16+ | マイグレーションスクリプトで全データを移行 |
| **タスクキューイング** | 人間がSheets UIから手動キューイング (PipelineUI.gs) | 戦略サイクルグラフが自律的にDBにタスク作成 | 機能置換 (v4.0のGAS UIメニューは段階的廃止) |
| **ジョブ監視** | watch-pipeline.js (PM2, 30秒ポーリング) | 制作パイプライングラフ (LangGraphノード) | LangGraphのグラフに組み込み。PM2管理は継続 |
| **アナリティクス** | GAS (Code.gs + 14モジュール, 379テスト) | アナリストエージェント + PostgreSQL | 段階的移行。GASのロジックをMCPツール+エージェントに分解 |
| **インベントリ管理** | inventory-reader.js → Sheets API | MCP Server → PostgreSQL | テーブル設計後にデータ移行 |
| **コンポーネント作成** | 人間が手動でSpreadsheetに作成 | データキュレーターが自動生成 + 人間レビュー | task_queue (type='curate') 経由で自動化 |
| **制作管理** | production-manager.js → Sheets API (33カラム) | MCP Server → PostgreSQL (content テーブル) | カラムマッピングを定義して移行 |
| **コンテンツ生成** | orchestrator.js + media/* | **変更なし** (そのまま再利用) | タスク取得元をSheets→DBに変更するだけ |
| **投稿** | posting/adapters/* (youtube.js, tiktok.js, instagram.js, x.js) | **変更なし** (そのまま再利用) | スケジュール管理をSheets→DBに変更 |
| **投稿デーモン** | watch-*-posting.js (4種: X, YT, TikTok, IG) | 投稿スケジューラーグラフに統合 | PM2デーモン → LangGraphノード |
| **認証管理** | *-credential-manager.js (yt, tiktok, ig) | credentials ボリュームで管理 | ファイルベース認証情報をそのまま再利用 |
| **投稿タスク管理** | *-posting-task-manager.js (x, yt, tiktok, ig) | 投稿スケジューラーグラフに統合 | Sheets→DB (publications テーブル) |

### 14.2 移行アーキテクチャ図

```
v4.0 (現行)                              v5.0 (新)
═══════════                              ═══════

┌───────────────────┐                    ┌─────────────────────── ┐
│ Google Sheets UI  │    ─────────→     │ Human Dashboard         │
│ (手動キューイング)│    置換           │ (Next.js, 監視+介入)        │
└─────────┬─────────┘                    └───────────┬─────────── ┘
          │                                          │
          ▼                                          ▼
┌───────────────────┐                    ┌─────────────────────── ┐
│ PipelineUI.gs     │    ─────────→      │ 戦略サイクルグラフ        │
│ (GAS メニュー)    │    置換            │ (LangGraph.js)           │
└─────────┬─────────┘                    └───────────┬─────────── ┘
          │                                          │
          ▼                                          ▼
┌───────────────────┐                    ┌─────────────────────── ┐
│ watch-pipeline.js │    ─────────→      │ 制作パイプライングラフ    │
│ (PM2 ポーリング)  │    置換            │ (LangGraph.js)           │
└─────────┬─────────┘                    └───────────┬─────────── ┘
          │                                          │
          ▼                                          ▼
┌───────────────────┐                    ┌─────────────────────── ┐
│ orchestrator.js   │    ─────────→     │ orchestrator.js         │
│ + media/*         │    再利用         │ + media/*                │
│ (fal.ai, Fish     │    (変更なし)     │ (同じ。タスク取得元         │
│  Audio, ffmpeg)   │                   │  のみ変更)               │
└─────────┬─────────┘                    └───────────┬─────────── ┘
          │                                          │
          ▼                                          ▼
┌───────────────────┐                    ┌─────────────────────── ┐
│ inventory-reader  │    ─────────→     │ MCP Server              │
│ production-manager│    置換           │ (PostgreSQL経由)         │
│ (Sheets API)      │                    │                        │
└─────────┬─────────┘                    └───────────┬─────────── ┘
          │                                          │
          ▼                                          ▼
┌───────────────────┐                    ┌─────────────────────── ┐
│ Google Sheets     │    ─────────→     │ PostgreSQL 16+          │
│ (5 Spreadsheet)   │    データ移行     │ + pgvector                │
└───────────────────┘                    └─────────────────────── ┘

┌───────────────────┐                    ┌─────────────────────── ┐
│ GAS Analytics     │    ─────────→      │ アナリストエージェント    │
│ (14モジュール)    │    段階的移行      │ + 計測ジョブグラフ           │
│                   │                    │ + MCP Server           │
└───────────────────┘                    └─────────────────────── ┘

┌───────────────────┐                    ┌─────────────────────── ┐
│ Google Drive      │    ─────────→     │ Google Drive            │
│ (Shared Drive)    │    継続利用       │ (Shared Drive)           │
│                   │    (変更なし)      │ (同じ構造)               │
└───────────────────┘                    └─────────────────────── ┘
```

### 14.3 段階的移行の順序

v4.0からv5.0への移行は一括ではなく段階的に行う。各フェーズで既存システムと並行運用し、安全に切り替える。

> **注**: ここでのPhase 1-6は移行フェーズであり、開発フェーズ (`06-development-roadmap.md` の Phase 1-5) とは番号体系が異なる。移行作業は対応する開発フェーズ内で実施する。

| フェーズ | 作業内容 | v4.0側の状態 | v5.0側の状態 |
|---|---|---|---|
| **Phase 1** | PostgreSQLセットアップ + スキーマ作成 + データ移行 | 稼働中 (変更なし) | DB準備完了 |
| **Phase 2** | MCP Server構築 + 基本ツール実装 | 稼働中 | MCPツール動作確認 |
| **Phase 3** | 制作パイプライングラフ構築 (orchestrator.jsを呼び出す) | 停止 (watch-pipeline.js) | 制作パイプライン稼働 |
| **Phase 4** | 投稿スケジューラー + 計測ジョブグラフ構築 | GAS Analytics停止 | 投稿+計測稼働 |
| **Phase 5** | 戦略サイクルグラフ構築 + ダッシュボード | Sheets UI不要に | 全機能稼働 |
| **Phase 6** | GASコード・Sheetsの段階的廃止 | 完全停止 | 本番運用 |

### 14.4 互換性と並行運用

移行期間中、v4.0とv5.0は並行運用する。以下の点に注意する。

- **Google Driveは共有**: v4.0もv5.0も同じShared Driveのフォルダ構造を使用する。ファイルの二重保存は発生しない
- **Sheetsは読み取り専用に段階移行**: Phase 3以降、Sheetsへの書き込みはv5.0側で停止し、PostgreSQLが正のデータソースとなる
- **GASテストは維持**: 379テストは移行完了まで維持する。v5.0側のテストと並行して実行し、データ整合性を検証する
- **ロールバック可能**: 各フェーズでv4.0に戻せるようにする。PostgreSQLのデータをSheetsに逆同期するスクリプトを用意する

## 15. 環境分離設計

### 15.1 環境構成

開発環境と本番環境を明確に分離し、安全な開発・テスト・デプロイのサイクルを実現する。

> **ステージング環境について**: 現時点ではステージング環境を設けず、開発 (dev) と本番 (prod) の2環境構成とする。アカウント数が増加し、本番デプロイのリスクが高まった段階 (Phase 5以降) でステージング環境の導入を検討する。

```
┌─────────────────────────────────────────────────────────────────────┐
│  開発環境 (Development)                                              │
│                                                                     │
│  場所: ローカル or GCE開発用VM                                         │
│  起動: docker-compose -f docker-compose.dev.yml up                   │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │ docker-compose.dev.yml                                        │  │
│  │                                                               │  │
│  │  postgres-dev     (port: 5433)   ← 開発用DB                   │   │
│  │  mcp-server-dev   (port: 3100)   ← ホットリロード有効         │     │
│  │  strategy-agent   (port: 3200)   ← デバッグモード             │    │
│  │  production-agent (port: 3300)   ← dry-run対応                │   │
│  │  posting-agent    (port: 3400)   ← テスト投稿先              │     │
│  │  measurement-agent(port: 3500)   ← モックAPI対応             │     │
│  │  dashboard-dev    (port: 3000)   ← next dev (HMR有効)        │    │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  環境変数: .env.development                                          │
│  DB: dev_ai_influencer (テストデータ)                                 │
│  特徴:                                                               │
│  ・ソースコードのホットリロード (nodemon / next dev)                     │
│  ・fal.ai dry-runモード (実際のAPI呼び出しをスキップ)                    │
│  ・テスト用のSNSアカウントに投稿                                        │
│  ・デバッグログ詳細出力                                                │
│  ・LLM呼び出しのモック切替可能                                          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│  本番環境 (Production)                                               │
│                                                                     │
│  場所: GCE本番VM                                                     │
│  起動: docker-compose -f docker-compose.prod.yml up -d               │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │ docker-compose.prod.yml                                       │  │
│  │                                                               │  │
│  │  mcp-server        (port: 3100)   ← 最適化ビルド              │    │
│  │  strategy-agent    (port: 3200)   ← 本番モード                │    │
│  │  production-agent  (port: 3300)   ← 実API接続                 │   │
│  │  posting-agent     (port: 3400)   ← 本番SNSアカウント        │     │
│  │  measurement-agent (port: 3500)   ← 本番API接続              │    │
│  │  dashboard         (port: 3000)   ← next start (最適化)      │    │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │ 外部マネージドサービス                                        │     │
│  │                                                               │  │
│  │  Cloud SQL (PostgreSQL 16 + pgvector)  ← 本番DB               │   │
│  │  ・自動バックアップ + ポイントインタイムリカバリ               │        │
│  │  ・高可用性 (リージョンHA構成)                                 │     │
│  │  ・DATABASE_URL で接続 (Cloud SQL Auth Proxy 経由)             │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  環境変数: .env.production                                           │
│  DB: prod_ai_influencer (本番データ, Cloud SQL)                       │
│  特徴:                                                               │
│  ・最適化済みビルドイメージ                                             │
│  ・本番SNSアカウントに投稿                                             │
│  ・構造化ログ (JSON形式)                                              │
│  ・エラー通知 (Slack/Discord)                                         │
│  ・自動リスタート (restart: unless-stopped)                           │
│  ・DBはCloud SQL (コンテナ管理外)                                      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 15.2 DB分離

開発DBと本番DBは完全に分離する。開発はDockerコンテナ内のPostgreSQL、本番はCloud SQL (マネージドサービス) を使用する。

```
開発環境 (Docker コンテナ)              本番環境 (Cloud SQL)
┌──────────────────────────┐          ┌────────────────────────── ┐
│ PostgreSQL (port: 5433)  │          │ Cloud SQL for PostgreSQL  │
│ (docker-compose管理)     │          │ (GCPマネージドサービス)      │
│                          │          │                           │
│ DB名: dev_ai_influencer  │          │ DB名: prod_ai_influencer   │
│                          │          │                           │
│ ・テストデータ投入済み   │          │ ・本番データ                   │
│ ・resetスクリプトで      │          │ ・自動バックアップ (日次)       │
│   初期化可能             │          │ ・ポイントインタイム           │
│ ・マイグレーション検証用 │          │   リカバリ (PITR)              │
│                          │          │ ・リージョンHA構成          │
│ pgvector: 有効           │          │ pgvector: 有効             │
│ max_connections: 20      │          │ max_connections: 100      │
└──────────────────────────┘          └────────────────────────── ┘
                                       接続: Cloud SQL Auth Proxy
                                       or プライベートIP
```

**DB運用ルール**:

| ルール | 説明 |
|---|---|
| **マイグレーション先行** | スキーマ変更は必ず開発DBで検証後、本番DBに適用 |
| **本番データの取扱い** | 本番DBのデータを開発にコピーする場合は匿名化スクリプトを通す |
| **シードデータ** | 開発用のテストデータは `seeds/` ディレクトリで管理 |
| **バックアップ** | 本番DBは日次でバックアップ。7日分保持 |

### 15.3 環境変数管理

```
プロジェクトルート/
├── .env.development          ← 開発環境用 (gitignored)
├── .env.production           ← 本番環境用 (gitignored)
├── .env.example              ← テンプレート (git管理)
└── docker/
    ├── docker-compose.dev.yml
    └── docker-compose.prod.yml
```

**主要な環境変数**:

| 変数名 | 開発環境 (.env.development) | 本番環境 (.env.production) |
|---|---|---|
| `NODE_ENV` | `development` | `production` |
| `DATABASE_URL` | `postgres://dev:dev@localhost:5433/dev_ai_influencer` | `postgres://prod:***@/prod_ai_influencer?host=/cloudsql/PROJECT:REGION:INSTANCE` |
| `FAL_KEY` | テスト用APIキー (低レート) | 本番用APIキー |
| `FISH_AUDIO_API_KEY` | テスト用APIキー | 本番用APIキー |
| `ANTHROPIC_API_KEY` | テスト用APIキー | 本番用APIキー |
| `LOG_LEVEL` | `debug` | `info` |
| `DRY_RUN` | `true` (デフォルト) | `false` |
| `DASHBOARD_URL` | `http://localhost:3000` | `https://dashboard.example.com` |
| `GOOGLE_SERVICE_ACCOUNT` | 開発用SA | 本番用SA |

### 15.4 デプロイフロー

```
開発者のローカル                        GCE本番VM
┌───────────────────┐                  ┌───────────────────────┐
│                   │                  │                       │
│  コード変更       │                  │                         │
│       │           │                  │                       │
│       ▼           │                  │                       │
│  ローカルテスト   │                  │                         │
│  (docker-compose   │                  │                      │
│   dev.yml)        │                  │                       │
│       │           │                  │                       │
│       ▼           │                  │                       │
│  git push         │   ─────────→    │  git pull              │
│  (main branch)    │                  │       │               │
│                   │                  │       ▼               │
│                   │                  │  docker-compose       │
│                   │                  │  -f prod.yml          │
│                   │                  │  pull                 │
│                   │                  │       │               │
│                   │                  │       ▼               │
│                   │                  │  docker-compose       │
│                   │                  │  -f prod.yml          │
│                   │                  │  up -d                │
│                   │                  │       │               │
│                   │                  │       ▼               │
│                   │                  │  ヘルスチェック         │
│                   │                  │  確認                  │
│                   │                  │                       │
└───────────────────┘                  └───────────────────────┘
```

**デプロイ手順** (Phase別の段階的Docker化に対応):

| ステップ | コマンド | 説明 |
|---|---|---|
| 1. コード取得 | `git pull origin main` | 最新コードを取得 |
| 2. イメージ更新 | `docker-compose -f docker-compose.prod.yml pull` | 最新イメージを取得 (外部イメージ) |
| 3. ビルド | `docker-compose -f docker-compose.prod.yml build` | 自作イメージをビルド |
| 4. マイグレーション | `docker-compose -f docker-compose.prod.yml run --rm mcp-server npx prisma migrate deploy` | Cloud SQLへのスキーマ更新 (DATABASE_URL経由) |
| 5. 起動 | `docker-compose -f docker-compose.prod.yml up -d` | アプリケーションコンテナ起動 (DBはCloud SQLで常時稼働) |
| 6. 確認 | `docker-compose -f docker-compose.prod.yml ps` | 全サービスの稼働確認 |

> **注**: 本番環境ではpostgresコンテナは存在しない。DBはCloud SQLで管理されるため、docker-composeでのDB起動/停止は不要。マイグレーションはCloud SQL Auth Proxy経由でDATABASE_URLを使って実行する。

> **CI/CDについて**: 現時点ではCI/CDパイプラインは設けず、手動デプロイ (上記手順) で運用する。アカウント数増加に伴いデプロイ頻度が上がった段階で GitHub Actions 等によるCI/CD自動化を導入予定。

## 16. コンテナアーキテクチャ

### 16.1 docker-compose構成図

全サービスをDockerコンテナとして管理し、再現性のある環境構築とデプロイを実現する。本番DBはCloud SQLを使用するため、postgresコンテナは開発環境のみ。

```
┌──────────────────────────────────────────────────────────────────────┐
│  docker-compose (v5.0 全サービス)                                      │
│                                                                      │
│  ┌─── external network ─────────────────────────────────────────┐    │
│  │                                                               │   │
│  │  ┌─────────────────────────────────────────────────────┐     │    │
│  │  │ dashboard (Next.js)                                   │     │  │
│  │  │                                                       │     │  │
│  │  │  image: node:20-slim                                  │     │  │
│  │  │  port: 3000:3000                                      │     │  │
│  │  │  volumes: ./dashboard:/app                            │     │  │
│  │  │                                                       │     │  │
│  │  │  Prisma/Drizzle ORM → DB接続                          │     │   │
│  │  │  (dev: postgres container / prod: Cloud SQL)          │     │  │
│  │  └───────────────────────────────┬───────────────────────┘     │  │
│  │                                  │                             │  │
│  └──────────────────────────────────┼─────────────────────────────┘  │
│                                     │                                │
│  ┌─── internal network ────────────┼─────────────────────────────┐   │
│  │                                  │                             │  │
│  │  ┌──────────────────────────────┴──────────────────────────┐  │   │
│  │  │ postgres (pgvector/pgvector:pg16) ★開発環境のみ          │  │    │
│  │  │                                                          │  │  │
│  │  │  port: 5433:5432 (devポート)                              │  │  │
│  │  │  volumes: pgdata:/var/lib/postgresql/data                 │  │ │
│  │  │  environment:                                            │  │  │
│  │  │    POSTGRES_DB, POSTGRES_USER, POSTGRES_PASSWORD          │  │ │
│  │  │  healthcheck: pg_isready                                 │  │  │
│  │  └──────────────────────────────────────────────────────────┘  │  │
│  │                                                                 │ │
│  │  ┌──────────────────────────────────────────────────────────┐  │  │
│  │  │ Cloud SQL (PostgreSQL 16 + pgvector) ★本番環境のみ       │  │    │
│  │  │ (外部マネージドサービス — docker-compose管理外)           │  │     │
│  │  │                                                          │  │  │
│  │  │  Cloud SQL Auth Proxy or プライベートIP経由で接続        │  │     │
│  │  │  自動バックアップ / HA / PITR                            │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │  │
│  │           ▲          ▲          ▲          ▲                  │   │
│  │           │          │          │          │                  │   │
│  │  ┌────────┴───┐ ┌───┴────────┐ ┌┴─────────┐ ┌┴────────────┐ │     │
│  │  │ mcp-server │ │ strategy-  │ │production│ │posting-     │ │     │
│  │  │            │ │ agent      │ │-agent    │ │agent        │ │     │
│  │  │ Node.js    │ │ LangGraph  │ │LangGraph │ │LangGraph    │ │     │
│  │  │ 89 MCP    │ │ .js        │ │.js +     │ │.js          │ │      │
│  │  │ ツール    │ │            │ │ffmpeg    │ │             │ │       │
│  │  │            │ │            │ │          │ │             │ │     │
│  │  │ port: 3100 │ │ Opus +     │ │          │ │ Sonnet×N   │ │      │
│  │  │            │ │ Sonnet×3   │ │ Sonnet×N│ │             │ │      │
│  │  │ SQL実行    │ │ (リサーチャー│ │       │ │ 4 platform  │ │        │
│  │  │ Drive API  │ │  アナリスト│ │ fal.ai  │ │ adapters   │ │         │
│  │  │            │ │  プランナー)│ │ Fish   │ │             │ │        │
│  │  │            │ │ +ツールSP  │ │ Audio   │ │             │ │       │
│  │  │            │ │ +データ    │ │         │ │             │ │       │
│  │  │            │ │  キュレーター│ │       │ │             │ │        │
│  │  └────────────┘ └────────────┘ └─────────┘ └─────────────┘ │      │
│  │                                                               │   │
│  │  ┌─────────────────────┐                                     │    │
│  │  │ measurement-agent   │                                     │    │
│  │  │                     │                                     │    │
│  │  │ LangGraph.js        │                                     │    │
│  │  │ Sonnet×N           │                                     │     │
│  │  │                     │                                     │    │
│  │  │ Platform API        │                                     │    │
│  │  │ (YT/TikTok/IG/X)   │                                     │     │
│  │  └─────────────────────┘                                     │    │
│  │                                                               │   │
│  └───────────────────────────────────────────────────────────────┘   │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

### 16.2 コンテナ一覧

| コンテナ名 | ベースイメージ | 役割 | ポート | 特記事項 |
|---|---|---|---|---|
| `postgres` | `pgvector/pgvector:pg16` | PostgreSQL 16 + pgvector拡張 | 5433 (dev) | **開発環境のみ**。本番はCloud SQL。ヘルスチェック: `pg_isready` |
| `mcp-server` | `node:20-slim` | MCP Server (89 MCPツール) | 3100 | SQL実行 + Drive API。13 REST APIはdashboard側 |
| `strategy-agent` | `node:20-slim` | 戦略サイクルグラフ (日次)。データキュレーターを内包 | 3200 | Opus + Sonnet×3 (リサーチャー+アナリスト+プランナー) + ツールSP + データキュレーター |
| `production-agent` | `node:20-slim` + ffmpeg | 制作パイプライングラフ (連続) | 3300 | fal.ai + Fish Audio + ffmpeg |
| `posting-agent` | `node:20-slim` | 投稿スケジューラーグラフ (連続) | 3400 | 4プラットフォームアダプター |
| `measurement-agent` | `node:20-slim` | 計測ジョブグラフ (連続) | 3500 | Platform API接続 |
| `dashboard` | `node:20-slim` | Next.js + Shadcn/ui | 3000 | Prisma/Drizzle ORM + 13 REST API |

> **注**: 本番環境ではpostgresコンテナの代わりにCloud SQL (PostgreSQL 16 + pgvector) を使用する。コンテナ数は本番6 (postgres除外) / 開発7。
> データキュレーターは独立コンテナではなく `strategy-agent` コンテナ内で動作する (戦略サイクルグラフのノードとして実装)。

> **リソース制限**: コンテナのCPU/メモリ制限は Phase 2 以降の負荷テスト結果に基づいて設定する。初期目安: production-agent (ffmpegのため 2CPU / 4GB)、他のエージェント (1CPU / 2GB)、mcp-server (1CPU / 1GB)、dashboard (0.5CPU / 512MB)。

### 16.3 ボリューム

| ボリューム名 | マウント先 | 用途 |
|---|---|---|
| `pgdata` | `/var/lib/postgresql/data` | PostgreSQLデータ永続化 (開発環境のみ。本番はCloud SQLが管理) |
| `credentials` | `/app/credentials` (各エージェント) | OAuth認証情報 (Google, SNS各プラットフォーム) |
| `prompts` | `/app/prompts` (各エージェント) | エージェントプロンプトファイル (バックアップ用、正はDB `agent_prompt_versions` テーブル)。移行パス: Phase 1でファイルベースで開始 → Phase 3以降でDB管理に移行。ファイルはフォールバックとして維持 |

### 16.4 ネットワーク

```
┌─────────────────────────────────────────────────────────┐
│  external (ブリッジネットワーク)                           │
│                                                         │
│  ・dashboard → 外部公開 (port 3000)                       │
│  ・dashboard → DB接続:                                   │
│    dev: postgres container (internal経由)                │
│    prod: Cloud SQL (Auth Proxy or プライベートIP)         │
│  ・将来的にリバースプロキシ (nginx/Caddy) を前段に配置        │
│                                                         │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  internal (内部ネットワーク)                              │
│                                                         │
│  ・DB接続:                                               │
│    dev: postgres container ← 全アプリコンテナ             │
│    prod: Cloud SQL ← 全アプリコンテナ (DATABASE_URL)      │
│  ・mcp-server ← 各エージェント (MCP Protocol)             │
│  ・外部からの直接アクセス不可                               │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**ネットワーク分離の理由**:

| ネットワーク | 接続可能なコンテナ | 理由 |
|---|---|---|
| `external` | dashboard | ダッシュボードのみ外部公開 |
| `internal` | 全アプリコンテナ + postgres (dev) | エージェント間・MCP Server・DBの内部通信。外部から隠蔽 |
| Cloud SQL (prod) | 全アプリコンテナから接続 (外部マネージドサービス) | 本番DBはCloud SQL Auth Proxy経由。docker networkの外 |

### 16.5 Phase別の段階的Docker化計画

全サービスを一括でDocker化するのではなく、開発フェーズに合わせて段階的にコンテナ化する。

> **注**: ここでのPhase 1-5は Docker化の段階を示す。開発全体のフェーズ定義は `06-development-roadmap.md` を参照。

| Phase | Docker化対象 | 理由 |
|---|---|---|
| **Phase 1** (DB + MCP) | dev: `postgres` container / prod: Cloud SQL セットアップ + `mcp-server` | データ基盤が最初に必要。開発はDockerコンテナ、本番はCloud SQLインスタンスを作成 |
| **Phase 2** (制作PL) | `production-agent` | 制作パイプラインはffmpeg依存があり、コンテナ化による環境統一のメリットが大きい |
| **Phase 3** (投稿+計測) | `posting-agent` + `measurement-agent` | OAuth認証情報のボリューム管理が重要。コンテナ化で認証情報を安全に管理 |
| **Phase 4** (戦略) | `strategy-agent` (データキュレーター含む) | 最もLLM依存が重く、開発が最も後。他の全コンテナが安定してからDocker化 |
| **Phase 5** (UI + 接続プール) | `dashboard` + pgBouncer導入 (01-tech-stack.md参照) | 最後にUI。全バックエンドが安定してからフロントエンド。pgBouncerで接続プール管理 |

**各Phaseでの docker-compose.yml の状態**:

```
Phase 1: postgres (dev) + mcp-server                     (dev: 2コンテナ / prod: 1コンテナ + Cloud SQL)
Phase 2: + production-agent                               (dev: 3 / prod: 2 + Cloud SQL)
Phase 3: + posting-agent + measurement-agent              (dev: 5 / prod: 4 + Cloud SQL)
Phase 4: + strategy-agent                                 (dev: 6 / prod: 5 + Cloud SQL)
Phase 5: + dashboard + pgbouncer                          (dev: 8 / prod: 7 + Cloud SQL = 完全体)
```
