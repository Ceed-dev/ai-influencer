# システムアーキテクチャ

> v5.0のシステム全体構造、各層の設計、データフロー、移行ポイントを詳細に定義する

## 1. 全体アーキテクチャ

v5.0は **4層構造** で構成される。上位層が方針を決定し、下位層がデータを蓄積・提供する。全ての層はMCP Serverを介して疎結合に接続される。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│   Layer 1: Human Dashboard (Next.js + Shadcn/ui)                        │
│                                                                         │
│   ┌───────────────┐  ┌────────────────┐  ┌───────────────────────┐     │
│   │ KPI進捗モニタ   │  │ アルゴリズム精度 │  │ 人間介入パネル         │     │
│   │ ・目標 vs 実績  │  │ ・仮説的中率推移│  │ ・仮説の差し込み       │     │
│   │ ・アカウント別   │  │ ・学習ログ     │  │ ・参考コンテンツ指定   │     │
│   │ ・日次/週次     │  │ ・改善トレンド  │  │ ・計測タイミング変更   │     │
│   └───────────────┘  └────────────────┘  └───────────────────────┘     │
│                                                                         │
│                          │ Prisma/Drizzle ORM (DB直結)                  │
├─────────────────────────┼───────────────────────────────────────────────┤
│                          ▼                                               │
│   Layer 2: LangGraph.js Orchestration                                    │
│                                                                         │
│   ┌──────────────────────────────────────────────────────────────┐      │
│   │  ┌─────────────┐  ┌──────────────┐  ┌──────────────────┐   │      │
│   │  │ 戦略サイクル   │  │ 制作パイプライン │  │ 投稿スケジューラー │   │      │
│   │  │ グラフ (日次) │  │ グラフ (連続)  │  │ グラフ (連続)     │   │      │
│   │  └──────┬──────┘  └──────┬───────┘  └────────┬─────────┘   │      │
│   │         │                │                    │              │      │
│   │         │         ┌──────┴───────┐            │              │      │
│   │         │         │ 計測ジョブ     │            │              │      │
│   │         │         │ グラフ (連続)  │            │              │      │
│   │         │         └──────────────┘            │              │      │
│   │         └────────────────┼────────────────────┘              │      │
│   │                          │ langchain-mcp-adapters            │      │
│   └──────────────────────────┼───────────────────────────────────┘      │
│                              │                                          │
├──────────────────────────────┼──────────────────────────────────────────┤
│                              ▼                                          │
│   Layer 3: MCP Server (自作 Node.js, ~60ツール)                         │
│                                                                         │
│   ┌────────────────────────────────────────────────────────────────┐   │
│   │  アカウント管理  │ コンテンツ管理  │ 仮説管理  │ 計測管理         │   │
│   │  投稿管理       │ 戦略管理       │ 知見管理  │ スケジュール管理  │   │
│   │  キャラクター管理 │ シナリオ管理   │ 分析管理  │ 設定管理         │   │
│   └────────────────────────────────────────────────────────────────┘   │
│                    │ SQL (pg)                    │ googleapis                │
├────────────────────┼────────────────────────────┼─────────────────────┤
│                    ▼                             ▼                     │
│   Layer 4: Data Stores                                                  │
│                                                                         │
│   ┌──────────────────────────┐    ┌──────────────────────────────┐    │
│   │ PostgreSQL 16+ (GCE)     │    │ Google Drive (Shared Drive)  │    │
│   │                          │    │                              │    │
│   │ ・全構造化データ           │    │ ・動画ファイル (MP4)         │    │
│   │ ・pgvector (類似検索)     │    │ ・キャラクター画像 (PNG)     │    │
│   │ ・タスクキュー             │    │ ・音声ファイル (MP3)         │    │
│   │ ・時系列メトリクス         │    │ ・モーション参照動画         │    │
│   │ ・仮説 + 知見 + embedding │    │ ・アナリティクスCSV          │    │
│   └──────────────────────────┘    └──────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 層間の通信方向

```
                    ┌─────────────────┐
                    │  Human Dashboard │
                    └────────┬────────┘
                      読み取り│▲書き込み
                 (KPI,ログ等) ││(仮説投入, 設定変更)
                             │▼
                    ┌────────┴────────┐
                    │   LangGraph.js   │
                    │  (4つのグラフ)    │
                    └────────┬────────┘
                  MCPツール呼│▲結果返却
                  び出し     ││(JSON)
                             │▼
                    ┌────────┴────────┐
                    │   MCP Server     │
                    └───┬─────────┬───┘
                SQL実行 │         │ Drive API
                        ▼         ▼
               ┌──────────┐  ┌──────────┐
               │PostgreSQL │  │Google    │
               │           │  │Drive     │
               └──────────┘  └──────────┘
```

**原則**: 上位層は下位層に「何をしたいか」を伝え、下位層は「結果」を返す。エージェントがSQLを直接書くことはない。全てMCPツールの呼び出しで抽象化する。

## 2. データ基盤層

### 2.1 PostgreSQL 16+ (GCE上)

全ての構造化データを一元管理するリレーショナルデータベース。GCE上の既存VMにインストールするか、将来的にCloud SQLへ移行する。

```
┌─────────────────────────────────────────────────────────────┐
│                    PostgreSQL 16+                             │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ Core Tables                                          │    │
│  │                                                      │    │
│  │  accounts        アカウント情報 (プラットフォーム別)    │    │
│  │  characters      キャラクター設定 + Drive file_id      │    │
│  │  scenarios        シナリオ (script_en/jp)              │    │
│  │  motions          モーション参照動画                    │    │
│  │  content         コンテンツ (ライフサイクル管理)       │    │
│  │  posts            投稿記録 (プラットフォーム別)         │    │
│  │  metrics          パフォーマンス計測値 (時系列)         │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ Intelligence Tables                                  │    │
│  │                                                      │    │
│  │  hypotheses       仮説 (embedding付き, pgvector)      │    │
│  │  experiments      実験 (仮説の検証結果)                │    │
│  │  insights         知見 (学習結果, embedding付き)       │    │
│  │  market_research  市場調査データ                       │    │
│  │  trend_signals    トレンドシグナル                     │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ Operational Tables                                   │    │
│  │                                                      │    │
│  │  task_queue       制作・投稿・計測のタスクキュー        │    │
│  │  schedules        投稿スケジュール                     │    │
│  │  agent_logs       エージェント実行ログ                 │    │
│  │  settings         システム設定 (計測タイミング等)       │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ pgvector Extension                                   │    │
│  │                                                      │    │
│  │  hypotheses.embedding   vector(1536)                  │    │
│  │  insights.embedding     vector(1536)                  │    │
│  │  market_research.embedding  vector(1536)              │    │
│  │                                                      │    │
│  │  用途: 類似仮説検索、関連知見の自動発見、              │    │
│  │        トレンドの類似性比較                            │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 pgvector拡張

仮説・知見・市場調査データにベクトル埋め込み (embedding) を付与し、類似検索を可能にする。

| 用途 | テーブル | カラム | 埋め込みモデル | 次元数 |
|---|---|---|---|---|
| 類似仮説の検索 | hypotheses | embedding | text-embedding-3-small or Voyage-3 | 1536 |
| 関連知見の自動発見 | insights | embedding | 同上 | 1536 |
| 市場調査の類似検索 | market_research | embedding | 同上 | 1536 |

**検索例**:
- 新しい仮説を生成する際、過去の類似仮説とその検証結果を自動参照
- 「このトレンドに似た過去のトレンド」を発見し、当時のパフォーマンスを参考にする
- ジャンル・テーマ横断で関連する知見を自動クラスタリング

### 2.3 Google Drive (Shared Drive)

動画・画像・音声などのバイナリファイルは引き続きGoogle Driveに保存する。PostgreSQLにはDriveのfile_idを格納し、メタデータとファイル実体を紐付ける。

```
Shared Drive: Product > AI-Influencer (1KRQuZ4W7u5CXRamjvN4xmavfu-7TPb0X)
├── Characters/        キャラクター画像 (PNG)
│   └── CHR_XXXX/      キャラクター別フォルダ
├── Motions/           モーション参照動画
│   ├── Hooks/         Hook用モーション
│   ├── Bodies/        Body用モーション
│   └── CTAs/          CTA用モーション
├── Scenarios/         シナリオ関連ファイル
├── Audio/             音声ファイル
├── Productions/       制作済み動画
│   └── YYYY-MM-DD/    日付別
│       └── VID_YYYYMM_XXXX/  動画別
│           ├── 01_hook.mp4
│           ├── 02_body.mp4
│           ├── 03_cta.mp4
│           └── final.mp4
└── Analytics/         分析CSV (レガシー、段階的廃止)
```

**PostgreSQLとDriveの紐付け**:

```
PostgreSQL                              Google Drive
┌──────────────────────┐               ┌──────────────────┐
│ characters           │               │ Characters/       │
│  id: CHR_0001        │──drive_file_id──>│ CHR_0001/       │
│  drive_file_id: 1zAZ │               │   image.png      │
│  name: "Hana"        │               │                   │
└──────────────────────┘               └──────────────────┘

┌──────────────────────┐               ┌──────────────────┐
│ content             │               │ Productions/      │
│  id: VID_202602_0001 │──drive_folder_id─>│ 2026-02-10/   │
│  drive_folder_id: .. │               │   VID_202602_0001/│
│  status: "posted"    │               │     final.mp4    │
└──────────────────────┘               └──────────────────┘
```

### 2.4 なぜSheetsからPostgreSQLに移行するのか

v4.0ではGoogle Sheetsを全データの管理基盤として使用していた。v5.0でPostgreSQLに移行する理由を以下に整理する。

| 観点 | Google Sheets (v4.0) | PostgreSQL (v5.0) | 移行の必要性 |
|---|---|---|---|
| **横断クエリ** | 5つの独立したSpreadsheet。JOIN不可。inventory-reader.jsで個別にフェッチし、コード内で結合 | 全テーブルをSQLのJOINで横断クエリ。1クエリで「このキャラの過去30日の全投稿パフォーマンス」を取得可能 | AIエージェントが自律的に分析するには横断クエリが必須 |
| **時系列分析** | タイムスタンプのフィルタリングはGASコードで手動実装。日付範囲指定が困難 | `WHERE posted_at BETWEEN ... AND ...` + ウィンドウ関数 (`LAG`, `LEAD`, `MOVING AVG`) で時系列分析がネイティブ | 「先週vs今週」「30日移動平均」等の分析が頻繁に必要 |
| **ACID保証** | シートの同時編集でデータ破損のリスク。トランザクションなし | ACID準拠のトランザクション。制作・投稿・計測の同時並行でもデータ整合性を保証 | 複数エージェントが同時にDB操作する前提 |
| **スケール耐性** | Sheets API: 300リクエスト/分。3,500アカウント運用時にレート制限に到達 | PostgreSQL: 数万行/秒のスループット。インデックスで高速検索 | KPI目標 3,500アカウント/日に対応 |
| **ベクトル検索** | 不可能。類似仮説の検索はコード内でコサイン類似度を計算する必要がある | pgvectorで `ORDER BY embedding <=> $1 LIMIT 10` と書くだけ | 仮説駆動サイクルの中核機能 |
| **型安全性** | 全カラムが文字列。数値・日付・配列は全てテキスト表現 | カラム型 (INTEGER, TIMESTAMP, JSONB, vector) を厳密に定義。ORMで型安全 | LLMが扱うデータの品質向上 |

## 3. AIエージェント層

### 3.1 LangGraph.js v1.0によるオーケストレーション

全エージェントの実行制御はLangGraph.js v1.0が担う。エージェントを「ノード」、状態遷移を「エッジ」としてグラフを定義する。

**LangGraphの採用理由** (詳細は [01-tech-stack.md](01-tech-stack.md) を参照):
- 唯一のv1.0 GA安定版
- Supervisorパターン + 階層Supervisorが公式サポート
- 耐久実行 (Durable Execution): 12分の動画生成中にプロセスが落ちてもチェックポイントから再開
- JS/TS公式サポート

### 3.2 4つの独立したLangGraphグラフ

v5.0は **4つの独立したグラフ** で構成される。各グラフは独立して実行され、**PostgreSQLを通じてのみ連携**する（直接通信しない）。

```
┌──────────────────────────────────────────────────────────────────────┐
│                      LangGraph.js Runtime (PM2管理)                    │
│                                                                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────────────┐ │
│  │ 1. 戦略サイクル    │  │ 2. 制作パイプライン │  │ 3. 投稿スケジューラー  │ │
│  │    グラフ         │  │    グラフ         │  │    グラフ             │ │
│  │    (日次実行)     │  │    (連続実行)     │  │    (連続実行)         │ │
│  │                  │  │                  │  │                      │ │
│  │ Opus + Sonnet×3 │  │ Sonnet×N        │  │ Sonnet×N             │ │
│  └────────┬─────────┘  └────────┬─────────┘  └──────────┬───────────┘ │
│           │                     │                        │             │
│           │              ┌──────┴──────────┐             │             │
│           │              │ 4. 計測ジョブ      │             │             │
│           │              │    グラフ         │             │             │
│           │              │    (連続実行)     │             │             │
│           │              │                  │             │             │
│           │              │ Sonnet×N        │             │             │
│           │              └──────┬───────────┘             │             │
│           │                     │                        │             │
│           └─────────────────────┼────────────────────────┘             │
│                                 │                                      │
│                    全グラフ共通: MCP Server経由でDB読み書き              │
│                    グラフ間通信: なし (DBのステータス変更で間接連携)       │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

**グラフ間の間接連携の例**:
1. 戦略サイクルグラフが `content` テーブルにステータス `planned` のレコードを作成
2. 制作パイプライングラフが `planned` ステータスの行をポーリングして検出し、制作を開始
3. 制作完了で `ready` に更新
4. 投稿スケジューラーグラフが `ready` の行を検出し、スケジュールに従って投稿
5. 投稿完了で `posted` に更新、`posted_at` を記録
6. 計測ジョブグラフが `posted_at + 48h` を過ぎた行を検出し、メトリクスを収集

### 3.3 グラフ1: 戦略サイクルグラフ (Strategy Cycle)

**実行頻度**: 日次 (1日1回)
**目的**: 市場データを分析し、仮説を生成し、コンテンツ制作計画を策定する

```
                    ┌──────────────┐
                    │    START     │
                    └──────┬───────┘
                           │
                           ▼
              ┌────────────────────────┐
              │  市場データ収集          │  リサーチャー (Sonnet)
              │                        │
              │  ・トレンドAPI取得       │  MCPツール:
              │  ・競合データ取得        │   get_trending_topics
              │  ・過去パフォーマンス取得 │   get_competitor_data
              │  ・類似市場調査を検索    │   search_similar_research
              │    (pgvector)          │   get_performance_summary
              └────────────┬───────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │  仮説生成              │  アナリスト (Sonnet)
              │                        │
              │  ・過去仮説の的中率参照  │  MCPツール:
              │  ・類似仮説をpgvectorで │   get_hypothesis_accuracy
              │    検索して重複回避     │   search_similar_hypotheses
              │  ・新仮説をDB保存       │   create_hypothesis
              │  ・embedding付与       │   get_recent_insights
              └────────────┬───────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │  計画策定              │  プランナー (Sonnet)
              │                        │
              │  ・仮説に基づく         │  MCPツール:
              │    コンテンツ計画作成    │   create_content_plan
              │  ・アカウント×シナリオの │   get_available_accounts
              │    マッチング           │   get_scenarios
              │  ・planned_post_date   │   assign_scenario_to_account
              │    の設定              │   set_planned_date
              └────────────┬───────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │  計画承認              │  戦略Agent (Opus)
              │                        │
              │  ・計画の妥当性レビュー  │  MCPツール:
              │  ・コスト上限チェック    │   review_plan
              │  ・承認 → planned      │   approve_plan
              │  ・差戻 → 計画策定に戻る│   reject_plan
              │  ・知見の要約と保存     │   save_insight
              └────────────┬───────────┘
                           │
                     ┌─────┴──────┐
                     │            │
                  承認 │         差戻│
                     ▼            │
              ┌──────────┐        │
              │   END    │        │
              │ (DB更新:  │        │
              │  planned) │        │
              └──────────┘        │
                                   ▼
                          計画策定ノードに戻る
```

**参加エージェントとLLMモデル**:

| エージェント | LLMモデル | 役割 | 判断の重さ |
|---|---|---|---|
| 戦略Agent | Claude Opus 4.6 | 最終承認・方針決定 | 高 (コスト判断、品質基準) |
| リサーチャー | Claude Sonnet 4.5 | 市場データ収集・整理 | 低 (データ取得が主) |
| アナリスト | Claude Sonnet 4.5 | 仮説生成・分析 | 中 (パターン認識) |
| プランナー | Claude Sonnet 4.5 | 制作計画の具体化 | 中 (リソース配分) |

### 3.4 グラフ2: 制作パイプライングラフ (Production Pipeline)

**実行頻度**: 連続 (ポーリング)
**目的**: `planned` ステータスのコンテンツを検出し、動画を生成する

```
              ┌──────────────┐
              │    START     │
              └──────┬───────┘
                     │
                     ▼
          ┌────────────────────┐
          │  タスク取得          │
          │                    │  MCPツール:
          │  status='planned'  │   get_pending_tasks
          │  のコンテンツを検索  │
          │                    │  なければ待機 (30秒sleep)
          └────────┬───────────┘
                   │
            タスクあり│         タスクなし
                   │              │
                   ▼              ▼
          ┌────────────────┐  ┌────────┐
          │ スクリプト生成   │  │ 待機   │──→ タスク取得に戻る
          │                │  └────────┘
          │ シナリオ取得    │  MCPツール:
          │ → LLMで調整    │   get_scenario_detail
          │ → DB保存       │   update_content_script
          └────────┬───────┘
                   │
                   ▼
          ┌────────────────────────────────────────────────┐
          │ 動画生成 (v4.0パイプライン再利用)                │
          │                                                │
          │  ┌──────────────────────────────────────────┐  │
          │  │ Promise.all (3セクション並列)              │  │
          │  │                                          │  │
          │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐ │  │
          │  │  │  Hook   │  │  Body   │  │  CTA    │ │  │
          │  │  │         │  │         │  │         │ │  │
          │  │  │ Kling   │  │ Kling   │  │ Kling   │ │  │
          │  │  │   +     │  │   +     │  │   +     │ │  │
          │  │  │ TTS     │  │ TTS     │  │ TTS     │ │  │
          │  │  │   ↓     │  │   ↓     │  │   ↓     │ │  │
          │  │  │Lipsync  │  │Lipsync  │  │Lipsync  │ │  │
          │  │  └─────────┘  └─────────┘  └─────────┘ │  │
          │  └──────────────────────────────────────────┘  │
          │                      │                         │
          │                      ▼                         │
          │             ffmpeg concat + 黒フレーム検証       │
          │                      │                         │
          │                      ▼                         │
          │             Google Drive 保存                    │
          └────────────────────────┬───────────────────────┘
                                   │
                                   ▼
          ┌────────────────────────────────────────────────┐
          │ 品質チェック                                     │
          │                                                │
          │  ・ファイルサイズ検証 (0バイトでないこと)           │
          │  ・黒フレーム検出結果の確認                       │
          │  ・Drive保存の成功確認                           │
          │                                                │
          │  合格 → status = 'ready'                        │
          │  不合格 → status = 'failed' + エラーログ          │
          └────────────────────────┬───────────────────────┘
                                   │
                                   ▼
                            タスク取得に戻る
```

### 3.5 グラフ3: 投稿スケジューラーグラフ (Publishing Scheduler)

**実行頻度**: 連続 (ポーリング)
**目的**: `ready` ステータスのコンテンツを適切なタイミングで投稿する

```
              ┌──────────────┐
              │    START     │
              └──────┬───────┘
                     │
                     ▼
          ┌────────────────────────┐
          │  スケジュール確認        │
          │                        │  MCPツール:
          │  ・planned_post_date   │   get_scheduled_posts
          │    が現在時刻を過ぎた    │   get_account_posting_rules
          │    ready状態のコンテンツ │
          │  ・プラットフォーム別の   │
          │    投稿制限チェック      │
          │  ・最適投稿時間帯の確認  │
          └────────────┬───────────┘
                       │
                投稿対象あり│      なし
                       │         │
                       ▼         ▼
          ┌──────────────────┐  ┌────────┐
          │  投稿実行         │  │ 待機   │──→ スケジュール確認に戻る
          │                  │  └────────┘
          │  アダプター呼出:  │
          │  ・YouTube       │  (v4.0の投稿アダプターを再利用)
          │  ・Instagram     │
          │  ・TikTok        │
          │  ・X/Twitter     │
          └────────┬─────────┘
                   │
                   ▼
          ┌──────────────────────┐
          │  結果記録             │  MCPツール:
          │                      │   record_post_result
          │  ・status = 'posted' │   set_posted_at
          │  ・posted_at記録     │   set_measure_after
          │  ・platform_post_id  │
          │  ・measure_after設定 │
          │    (posted_at + 48h) │
          └──────────┬───────────┘
                     │
                     ▼
              スケジュール確認に戻る
```

### 3.6 グラフ4: 計測ジョブグラフ (Measurement Jobs)

**実行頻度**: 連続 (ポーリング)
**目的**: 投稿後一定時間が経過したコンテンツのパフォーマンスを計測する

```
              ┌──────────────┐
              │    START     │
              └──────┬───────┘
                     │
                     ▼
          ┌────────────────────────┐
          │  計測対象検出           │  MCPツール:
          │                        │   get_posts_needing_measurement
          │  ・status = 'posted'   │
          │  ・NOW() > measure_after│
          │  ・まだ計測されていない  │
          └────────────┬───────────┘
                       │
                対象あり │      なし
                       │         │
                       ▼         ▼
          ┌──────────────────┐  ┌────────┐
          │  メトリクス収集    │  │ 待機   │──→ 計測対象検出に戻る
          │                  │  └────────┘
          │  プラットフォーム  │  MCPツール:
          │  APIから取得:     │   fetch_youtube_metrics
          │  ・views         │   fetch_tiktok_metrics
          │  ・likes         │   fetch_instagram_metrics
          │  ・comments      │   fetch_x_metrics
          │  ・shares        │
          │  ・watch_time    │
          └────────┬─────────┘
                   │
                   ▼
          ┌──────────────────────┐
          │  DB保存              │  MCPツール:
          │                      │   save_metrics
          │  ・metricsテーブルに  │   update_content_status
          │    時系列データ保存   │
          │  ・status='measured' │
          │  ・次回計測日設定     │
          │    (追加計測が必要な  │
          │     場合)            │
          └──────────┬───────────┘
                     │
                     ▼
              計測対象検出に戻る
```

### 3.7 グラフ間のDB連携フロー

4つのグラフは互いに直接通信しない。全ての連携はPostgreSQLの `content` テーブルのステータス遷移を通じて行われる。

```
戦略サイクル          制作パイプライン        投稿スケジューラー       計測ジョブ
グラフ               グラフ                グラフ                グラフ
    │                    │                    │                    │
    │ planned            │                    │                    │
    ├──────────────────>│                    │                    │
    │    (DBに書込)      │ producing          │                    │
    │                    ├─ (status更新)      │                    │
    │                    │                    │                    │
    │                    │ ready              │                    │
    │                    ├──────────────────>│                    │
    │                    │   (DBに書込)       │ scheduled          │
    │                    │                    ├─ (status更新)      │
    │                    │                    │                    │
    │                    │                    │ posted             │
    │                    │                    ├──────────────────>│
    │                    │                    │   (DBに書込)       │ measured
    │                    │                    │                    ├─(status更新)
    │                    │                    │                    │
    │                    │                    │                    │ analyzed
    │<───────────────────────────────────────────────────────────┤
    │   (次サイクルで分析結果を読み取り、次の仮説生成に反映)         │
    │                    │                    │                    │
    ▼                    ▼                    ▼                    ▼
─────────────────────────────────────────────────────────────────────
                        PostgreSQL (共有データストア)
```

## 4. MCP Server層

### 4.1 自作MCP Server (Node.js)

エージェントとデータ基盤の間に位置する中間層。エージェントは **SQLを直接書かず、MCPツールを呼び出す** ことでデータベースにアクセスする。

```
┌──────────────────────────────────────────────────────────────────┐
│                    MCP Server (Node.js)                            │
│                                                                   │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │ Tool Registry (~60ツール)                                  │   │
│  │                                                           │   │
│  │  アカウント管理 (6)       コンテンツ管理 (8)                 │   │
│  │  ├ list_accounts         ├ get_pending_tasks              │   │
│  │  ├ get_account_detail    ├ create_content                 │   │
│  │  ├ create_account        ├ update_content_status          │   │
│  │  ├ update_account        ├ get_content_detail             │   │
│  │  ├ get_account_stats     ├ list_content_by_status        │   │
│  │  └ deactivate_account    ├ update_content_script          │   │
│  │                          ├ get_content_history            │   │
│  │  キャラクター管理 (4)     └ search_similar_content        │   │
│  │  ├ list_characters                                        │   │
│  │  ├ get_character_detail  仮説管理 (6)                      │   │
│  │  ├ create_character      ├ create_hypothesis              │   │
│  │  └ update_character      ├ list_hypotheses                │   │
│  │                          ├ search_similar_hypotheses       │   │
│  │  シナリオ管理 (5)         ├ get_hypothesis_accuracy        │   │
│  │  ├ list_scenarios        ├ update_hypothesis_result       │   │
│  │  ├ get_scenario_detail   └ archive_hypothesis             │   │
│  │  ├ create_scenario                                        │   │
│  │  ├ update_scenario       知見管理 (4)                      │   │
│  │  └ search_scenarios      ├ save_insight                   │   │
│  │                          ├ search_similar_insights         │   │
│  │  投稿管理 (5)            ├ get_recent_insights            │   │
│  │  ├ get_scheduled_posts   └ list_insights_by_topic         │   │
│  │  ├ record_post_result                                     │   │
│  │  ├ set_posted_at         計測管理 (5)                      │   │
│  │  ├ set_measure_after     ├ get_posts_needing_measurement  │   │
│  │  └ get_posting_history   ├ save_metrics                   │   │
│  │                          ├ get_metrics_summary             │   │
│  │  戦略管理 (4)            ├ get_performance_trend           │   │
│  │  ├ review_plan           └ compare_metrics                │   │
│  │  ├ approve_plan                                           │   │
│  │  ├ reject_plan           スケジュール管理 (3)              │   │
│  │  └ get_strategy_log      ├ get_account_posting_rules      │   │
│  │                          ├ set_posting_schedule            │   │
│  │  分析管理 (5)            └ get_optimal_posting_time       │   │
│  │  ├ get_performance_summary                                │   │
│  │  ├ get_trending_topics   設定管理 (3)                      │   │
│  │  ├ get_competitor_data   ├ get_setting                    │   │
│  │  ├ search_similar_research ├ update_setting               │   │
│  │  └ get_algorithm_accuracy └ list_settings                 │   │
│  │                                                           │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │ Business Logic Layer                                       │   │
│  │                                                           │   │
│  │  ・ツール入力のバリデーション                                │   │
│  │  ・SQLクエリの構築 (pg ドライバー)                           │   │
│  │  ・pgvectorの類似検索クエリ生成                             │   │
│  │  ・Drive API呼び出し (ファイルID解決)                       │   │
│  │  ・結果のフォーマット (エージェントが理解しやすい形式)        │   │
│  │  ・エラーハンドリング + リトライ                             │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │ Connection Pool                                            │   │
│  │                                                           │   │
│  │  PostgreSQL (pg)  ←→  max: 20 connections                 │   │
│  │  Google Drive API ←→  googleapis (service account)        │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

### 4.2 MCP Serverの設計原則

| 原則 | 説明 | 理由 |
|---|---|---|
| **SQLを隠蔽** | エージェントはSQLを書かない。`get_pending_tasks` のようなセマンティックなツール名で呼び出す | LLMのSQLハルシネーションを防止。クエリの最適化をサーバー側で一元管理 |
| **ビジネスロジック内包** | 「計測タイミングの計算」「仮説の的中率算出」等はMCPサーバー内で実装 | エージェントのプロンプトを軽量化。ロジック変更時にサーバーだけ更新 |
| **結果フォーマット** | 返却値はエージェントが理解しやすいJSON形式にフォーマット | トークン消費の最適化。不要なDB内部情報を隠蔽 |
| **冪等性** | 同じツールを同じ引数で複数回呼んでも副作用が発生しない (書き込み系はupsert) | LLMのリトライ時に安全 |

### 4.3 langchain-mcp-adaptersによる接続

LangGraph.jsからMCP Serverへの接続は `langchain-mcp-adapters` パッケージを使用する。

```
LangGraph.js
    │
    │  エージェントノード内で
    │  MCPツールをLangChainのTool形式で呼び出し
    │
    ▼
langchain-mcp-adapters
    │
    │  MCP Protocol (stdio or HTTP)
    │  ツール一覧の自動検出 (list_tools)
    │  入力スキーマの自動変換
    │
    ▼
自作 MCP Server (Node.js)
    │
    │  ツールハンドラーが実行
    │  SQL組み立て + 実行
    │
    ▼
PostgreSQL
```

## 5. コンテンツ生成層 (v4.0パイプライン再利用)

### 5.1 既存パイプラインの再利用

v4.0で構築したコンテンツ生成パイプラインをv5.0でもそのまま再利用する。変更点はタスクの発行者とデータソースのみ。

```
v4.0 (現行)                          v5.0 (新)
─────────────────                    ─────────────────
タスク発行者: 人間                     タスク発行者: 戦略サイクルグラフ (LLM)
  │                                    │
  ▼                                    ▼
データソース: Google Sheets             データソース: PostgreSQL
  (inventory-reader.js)                  (MCP Server経由)
  │                                    │
  ▼                                    ▼
┌──────────────────────────────────────────────────┐
│  以下は v4.0 / v5.0 で共通 (変更なし)              │
│                                                   │
│  orchestrator.js                                  │
│    │                                              │
│    ├── キャラクター画像取得 (Drive → fal.storage)  │
│    │                                              │
│    ├── 3セクション並列処理 (Promise.all)           │
│    │   ┌────────────────────────────────────┐     │
│    │   │ fal.ai Kling v2.6 ──┐  (並列)     │     │
│    │   │ Fish Audio TTS ─────┤             │     │
│    │   │                     ▼             │     │
│    │   │         fal.ai Sync Lipsync       │     │
│    │   └────────────────────────────────────┘     │
│    │                                              │
│    ├── ffmpeg concat (H.264 CRF18)               │
│    ├── blackdetect 検証 + 自動トリム               │
│    │                                              │
│    └── Google Drive 保存                          │
│        (Productions/YYYY-MM-DD/VID_YYYYMM_XXXX/) │
│                                                   │
└──────────────────────────────────────────────────┘
```

### 5.2 MCP化しない理由

コンテンツ生成パイプラインはMCPツールとして公開 **しない**。

| 観点 | MCP化した場合 | 直接API (現行方式) |
|---|---|---|
| 実行主体 | LLMがツールとして呼び出す | Node.jsコードが直接実行 |
| トークンコスト | fal.aiのレスポンス (数百行) をLLMが読む必要がある | コードが直接処理。LLMは不要 |
| エラー処理 | LLMが判断 (コスト高) | コードで自動リトライ (コスト0) |
| 処理時間 | LLMの応答待ち分遅延 | 最速 |
| 適合パターン | 判断を伴うタスク | 機械的な変換タスク |

**結論**: 制作パイプラインは「判断」ではなく「変換」のタスク。画像+音声→動画の生成はLLMの介在なしにコードが最も効率的に処理できる。LangGraphのノードからNode.jsの関数を直接呼び出す。

### 5.3 変更点サマリ

| 項目 | v4.0 | v5.0 |
|---|---|---|
| タスク発行者 | 人間 (Sheets UIでキューイング) | 戦略サイクルグラフ (LLM) |
| タスク読み取り元 | Google Sheets (production タブ) | PostgreSQL (content + task_queue テーブル) |
| ジョブ検出方法 | watch-pipeline.js (30秒ポーリング) | 制作パイプライングラフ (LangGraphノード) |
| 結果記録先 | Google Sheets (production タブ 33カラム) | PostgreSQL (content テーブル) + Drive |
| 動画生成エンジン | fal.ai Kling + Fish Audio + Lipsync | 同じ (変更なし) |
| 動画結合 | ffmpeg | 同じ (変更なし) |
| ファイル保存先 | Google Drive | 同じ (変更なし) |

## 6. ダッシュボード層

### 6.1 Next.js + Shadcn/ui

人間がシステムの状態を監視し、必要に応じて介入するためのWebダッシュボード。

```
┌─────────────────────────────────────────────────────────────────┐
│                    Next.js Dashboard                              │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 読み取り (Read-Only Views)                                 │  │
│  │                                                           │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │  │
│  │  │ KPI進捗       │  │ アルゴリズム   │  │ 投稿別        │   │  │
│  │  │              │  │ 精度推移      │  │ パフォーマンス │   │  │
│  │  │ ・目標vs実績  │  │              │  │              │   │  │
│  │  │ ・アカウント別│  │ ・仮説的中率  │  │ ・views     │   │  │
│  │  │ ・日次/週次  │  │ ・学習曲線    │  │ ・engagement│   │  │
│  │  │ ・トレンド   │  │ ・ジャンル別  │  │ ・比較      │   │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘   │  │
│  │                                                           │  │
│  │  ┌──────────────┐  ┌──────────────┐                      │  │
│  │  │ 学習ログ      │  │ エージェント   │                      │  │
│  │  │              │  │ 実行ログ      │                      │  │
│  │  │ ・知見一覧    │  │              │                      │  │
│  │  │ ・仮説→結果  │  │ ・タスク状況  │                      │  │
│  │  │ ・改善提案    │  │ ・エラー率   │                      │  │
│  │  └──────────────┘  └──────────────┘                      │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 書き込み (Human Intervention)                              │  │
│  │                                                           │  │
│  │  ┌──────────────────────┐  ┌──────────────────────────┐  │  │
│  │  │ 仮説投入              │  │ 設定変更                  │  │  │
│  │  │                      │  │                          │  │  │
│  │  │ ・人間が仮説を         │  │ ・計測タイミング          │  │  │
│  │  │   直接追加            │  │   (48h → 24h 等)        │  │  │
│  │  │ ・参考コンテンツURL    │  │ ・投稿頻度               │  │  │
│  │  │   の指定              │  │ ・コスト上限             │  │  │
│  │  │ ・優先度の指示         │  │ ・エージェント有効/無効   │  │  │
│  │  └──────────────────────┘  └──────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│                     │ Prisma or Drizzle ORM                      │
│                     ▼                                            │
│              PostgreSQL (直結)                                    │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 ダッシュボードの設計方針

| 方針 | 説明 |
|---|---|
| **DB直結** | MCP Serverを経由せず、Prisma/Drizzle ORMでPostgreSQLに直接接続。ダッシュボードはLLMではないため、MCPプロトコルは不要 |
| **読み取り中心** | 大半の画面は読み取り専用。AIが自律的に回しているため、人間は基本的に監視のみ |
| **介入は限定的** | 書き込みは「仮説投入」「参考コンテンツ指定」「設定変更」に限定。日常的な操作は全てAIが行う |
| **リアルタイム性不要** | ポーリング (30秒〜1分) で十分。WebSocketは不要 |

## 7. データフロー図

### 7.1 全体データフロー

システム全体のデータの流れを方向別に示す。

```
                          上→下: 方針・指示
                          下→上: 報告・データ
                          横:   判断材料の提供

┌─────────────────────────────────────────────────────────────────┐
│  Human Dashboard                                                  │
│                                                                   │
│  ・仮説投入 (下方向)  ・KPI確認 (上方向)  ・設定変更 (下方向)      │
└─────────┬────────────────────▲──────────────────┬────────────────┘
          │                    │                  │
    仮説・指示を          KPI進捗・             設定変更を
    DBに書込み           学習ログを表示          DBに書込み
          │                    │                  │
          ▼                    │                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  戦略サイクルグラフ                                                 │
│                                                                   │
│  ┌────────────┐    判断材料     ┌─────────────┐                   │
│  │ 戦略Agent   │◄──────────────│ リサーチャー   │                   │
│  │ (Opus)     │    (横方向)    │ (Sonnet)    │                   │
│  │            │                │             │                   │
│  │  方針決定  │    判断材料     │ 市場データ   │                   │
│  │  承認/却下 │◄──────────────│ 収集        │                   │
│  └──────┬─────┘               └─────────────┘                   │
│         │                                                        │
│         │方針指示 (下方向)                                         │
│         │                                                        │
│  ┌──────▼─────┐    判断材料     ┌─────────────┐                   │
│  │ プランナー   │◄──────────────│ アナリスト    │                   │
│  │ (Sonnet)   │    (横方向)    │ (Sonnet)    │                   │
│  │            │                │             │                   │
│  │ 計画策定   │                │ 仮説生成    │                   │
│  │ (planned)  │                │ 分析        │                   │
│  └──────┬─────┘               └─────────────┘                   │
│         │                                                        │
│         │ 制作指示 (下方向): content.status = 'planned'            │
└─────────┼────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────┐
│  制作パイプライングラフ                                             │
│                                                                   │
│  planned → producing → ready                                     │
│                                                                   │
│  完了報告 (上方向): content.status = 'ready'                      │
└─────────┬────────────────────────────────────────────────────────┘
          │
          │ 投稿指示 (下方向): status = 'ready' + planned_post_date到来
          ▼
┌─────────────────────────────────────────────────────────────────┐
│  投稿スケジューラーグラフ                                           │
│                                                                   │
│  ready → scheduled → posted                                      │
│                                                                   │
│  完了報告 (上方向): posted_at, measure_after 記録                   │
└─────────┬────────────────────────────────────────────────────────┘
          │
          │ 計測対象 (下方向): NOW() > measure_after
          ▼
┌─────────────────────────────────────────────────────────────────┐
│  計測ジョブグラフ                                                   │
│                                                                   │
│  posted → measured → analyzed                                     │
│                                                                   │
│  パフォーマンスデータ (上方向): metricsテーブルに時系列保存           │
│  → 次の戦略サイクルでリサーチャー・アナリストが参照                  │
└─────────────────────────────────────────────────────────────────┘

                    ▼ 全データの最終保存先 ▼

┌──────────────────────────┐    ┌──────────────────────────┐
│ PostgreSQL               │    │ Google Drive             │
│                          │    │                          │
│ ・content (ステータス)   │    │ ・final.mp4             │
│ ・metrics (パフォーマンス)│    │ ・01_hook.mp4           │
│ ・hypotheses (仮説)      │    │ ・02_body.mp4           │
│ ・insights (知見)        │    │ ・03_cta.mp4            │
│ ・agent_logs (実行ログ)  │    │ ・キャラクター画像       │
└──────────────────────────┘    └──────────────────────────┘
```

### 7.2 エージェント共通のデータアクセスパターン

全エージェントは同一のパターンでデータにアクセスする。

```
エージェント (LangGraph ノード)
    │
    │  1. MCPツールを選択
    │     (例: get_performance_summary)
    │
    │  2. 引数を指定
    │     (例: { account_id: "ACC_0013", period: "7d" })
    │
    ▼
MCP Server
    │
    │  3. 入力バリデーション
    │  4. SQLクエリ構築
    │     SELECT ... FROM metrics
    │     JOIN posts ON ...
    │     WHERE account_id = $1
    │     AND posted_at > NOW() - INTERVAL '7 days'
    │
    │  5. クエリ実行
    │  6. 結果フォーマット
    │
    ▼
エージェントに返却
    {
      "account_id": "ACC_0013",
      "period": "7d",
      "total_views": 12500,
      "avg_engagement_rate": 0.045,
      "top_performing_content": "VID_202603_0042",
      "trend": "improving"
    }
```

## 8. コンテンツライフサイクル

### 8.1 ステータス遷移

コンテンツは以下のステータスを順番に遷移する。各ステータスの変更は、対応するLangGraphグラフが担当する。

```
planned ──→ producing ──→ ready ──→ scheduled ──→ posted ──→ measured ──→ analyzed
   │            │           │           │            │           │            │
   │            │           │           │            │           │            │
   ▼            ▼           ▼           ▼            ▼           ▼            ▼
 戦略サイクル  制作PL     制作PL    投稿スケジュ   投稿スケジュ  計測ジョブ   戦略サイクル
 グラフ       グラフ      グラフ    ーラーグラフ   ーラーグラフ  グラフ       (次サイクル)
```

**エラー時の分岐**:

```
producing ──→ failed (制作失敗)
                │
                └──→ planned (リトライ対象として再キューイング)

posted ──→ post_failed (投稿失敗)
              │
              └──→ ready (再投稿対象としてプールに戻す)
```

### 8.2 ステータス定義

| ステータス | 意味 | 設定するグラフ | 主要なカラム |
|---|---|---|---|
| `planned` | 制作計画が承認済み。制作待ち | 戦略サイクル | `planned_post_date`, `account_id`, `scenario_id` |
| `producing` | 動画生成中 | 制作パイプライン | `started_at` |
| `ready` | 動画完成。投稿待ちプール内 | 制作パイプライン | `drive_folder_id`, `final_video_url` |
| `scheduled` | 投稿スケジュール確定 | 投稿スケジューラー | `scheduled_at` |
| `posted` | 投稿完了 | 投稿スケジューラー | `posted_at`, `platform_post_id`, `measure_after` |
| `measured` | パフォーマンス計測完了 | 計測ジョブ | `metrics_id`, `measured_at` |
| `analyzed` | 分析結果が知見として保存済み | 戦略サイクル (次回) | `insight_id` |
| `failed` | 制作失敗 | 制作パイプライン | `error_message`, `error_at` |
| `post_failed` | 投稿失敗 | 投稿スケジューラー | `error_message`, `error_at` |

### 8.3 時間軸とタイムスタンプ

```
時間軸 ──────────────────────────────────────────────────────────→

D-3                D-1             D (当日)           D+2
│                  │               │                  │
│ planned_post_date│               │                  │
│ の設定           │               │ posted_at        │ measure_after
│                  │ ready          │ (実際の投稿時刻)  │ (posted_at + 48h)
│                  │ (制作完了)      │                  │
│                  │               │                  │
▼                  ▼               ▼                  ▼
planned           ready          posted            measured
└─ 戦略サイクル ──┘ └─ 制作PL ──┘ └─ 投稿 ────────┘ └─ 計測 ──→ analyzed
```

| タイムスタンプ | 説明 | 設定タイミング | 変更可否 |
|---|---|---|---|
| `planned_post_date` | 投稿予定日。数日前に計画する | 戦略サイクルで `planned` 設定時 | ダッシュボードから変更可 |
| `started_at` | 制作開始日時 | 制作パイプラインで `producing` 設定時 | 不可 |
| `posted_at` | 実際の投稿日時 | 投稿スケジューラーで `posted` 設定時 | 不可 |
| `measure_after` | 計測開始可能日時。デフォルト `posted_at + 48h` | 投稿完了時に自動計算 | ダッシュボードから計測間隔を変更可 |
| `measured_at` | 計測実行日時 | 計測ジョブで `measured` 設定時 | 不可 |

## 9. v4.0からの移行ポイント

### 9.1 移行対象一覧

| 項目 | v4.0 (現行) | v5.0 (新) | 移行方法 |
|---|---|---|---|
| **データストア** | Google Sheets (5 Spreadsheet + 1 Master) | PostgreSQL 16+ | マイグレーションスクリプトで全データを移行 |
| **タスクキューイング** | 人間がSheets UIから手動キューイング (PipelineUI.gs) | 戦略サイクルグラフが自律的にDBにタスク作成 | 機能置換 (v4.0のGAS UIメニューは段階的廃止) |
| **ジョブ監視** | watch-pipeline.js (PM2, 30秒ポーリング) | 制作パイプライングラフ (LangGraphノード) | LangGraphのグラフに組み込み。PM2管理は継続 |
| **アナリティクス** | GAS (Code.gs + 14モジュール, 379テスト) | アナリストエージェント + PostgreSQL | 段階的移行。GASのロジックをMCPツール+エージェントに分解 |
| **インベントリ管理** | inventory-reader.js → Sheets API | MCP Server → PostgreSQL | テーブル設計後にデータ移行 |
| **制作管理** | production-manager.js → Sheets API (33カラム) | MCP Server → PostgreSQL (content テーブル) | カラムマッピングを定義して移行 |
| **コンテンツ生成** | orchestrator.js + media/* | **変更なし** (そのまま再利用) | タスク取得元をSheets→DBに変更するだけ |
| **投稿** | posting/adapters/* | **変更なし** (そのまま再利用) | スケジュール管理をSheets→DBに変更 |

### 9.2 移行アーキテクチャ図

```
v4.0 (現行)                              v5.0 (新)
═══════════                              ═══════

┌───────────────────┐                    ┌───────────────────────┐
│ Google Sheets UI  │    ─────────→     │ Human Dashboard       │
│ (手動キューイング)  │    置換            │ (Next.js, 監視+介入)  │
└─────────┬─────────┘                    └───────────┬───────────┘
          │                                          │
          ▼                                          ▼
┌───────────────────┐                    ┌───────────────────────┐
│ PipelineUI.gs     │    ─────────→     │ 戦略サイクルグラフ       │
│ (GAS メニュー)     │    置換            │ (LangGraph.js)        │
└─────────┬─────────┘                    └───────────┬───────────┘
          │                                          │
          ▼                                          ▼
┌───────────────────┐                    ┌───────────────────────┐
│ watch-pipeline.js │    ─────────→     │ 制作パイプライングラフ    │
│ (PM2 ポーリング)   │    置換            │ (LangGraph.js)        │
└─────────┬─────────┘                    └───────────┬───────────┘
          │                                          │
          ▼                                          ▼
┌───────────────────┐                    ┌───────────────────────┐
│ orchestrator.js   │    ─────────→     │ orchestrator.js       │
│ + media/*         │    再利用          │ + media/*             │
│ (fal.ai, Fish     │    (変更なし)      │ (同じ。タスク取得元     │
│  Audio, ffmpeg)   │                    │  のみ変更)            │
└─────────┬─────────┘                    └───────────┬───────────┘
          │                                          │
          ▼                                          ▼
┌───────────────────┐                    ┌───────────────────────┐
│ inventory-reader  │    ─────────→     │ MCP Server            │
│ production-manager│    置換            │ (PostgreSQL経由)       │
│ (Sheets API)      │                    │                       │
└─────────┬─────────┘                    └───────────┬───────────┘
          │                                          │
          ▼                                          ▼
┌───────────────────┐                    ┌───────────────────────┐
│ Google Sheets     │    ─────────→     │ PostgreSQL 16+        │
│ (5 Spreadsheet)   │    データ移行       │ + pgvector            │
└───────────────────┘                    └───────────────────────┘

┌───────────────────┐                    ┌───────────────────────┐
│ GAS Analytics     │    ─────────→     │ アナリストエージェント   │
│ (14モジュール)     │    段階的移行      │ + 計測ジョブグラフ      │
│                   │                    │ + MCP Server          │
└───────────────────┘                    └───────────────────────┘

┌───────────────────┐                    ┌───────────────────────┐
│ Google Drive      │    ─────────→     │ Google Drive          │
│ (Shared Drive)    │    継続利用        │ (Shared Drive)        │
│                   │    (変更なし)      │ (同じ構造)             │
└───────────────────┘                    └───────────────────────┘
```

### 9.3 段階的移行の順序

v4.0からv5.0への移行は一括ではなく段階的に行う。各フェーズで既存システムと並行運用し、安全に切り替える。

| フェーズ | 作業内容 | v4.0側の状態 | v5.0側の状態 |
|---|---|---|---|
| **Phase 1** | PostgreSQLセットアップ + スキーマ作成 + データ移行 | 稼働中 (変更なし) | DB準備完了 |
| **Phase 2** | MCP Server構築 + 基本ツール実装 | 稼働中 | MCPツール動作確認 |
| **Phase 3** | 制作パイプライングラフ構築 (orchestrator.jsを呼び出す) | 停止 (watch-pipeline.js) | 制作パイプライン稼働 |
| **Phase 4** | 投稿スケジューラー + 計測ジョブグラフ構築 | GAS Analytics停止 | 投稿+計測稼働 |
| **Phase 5** | 戦略サイクルグラフ構築 + ダッシュボード | Sheets UI不要に | 全機能稼働 |
| **Phase 6** | GASコード・Sheetsの段階的廃止 | 完全停止 | 本番運用 |

### 9.4 互換性と並行運用

移行期間中、v4.0とv5.0は並行運用する。以下の点に注意する。

- **Google Driveは共有**: v4.0もv5.0も同じShared Driveのフォルダ構造を使用する。ファイルの二重保存は発生しない
- **Sheetsは読み取り専用に段階移行**: Phase 3以降、Sheetsへの書き込みはv5.0側で停止し、PostgreSQLが正のデータソースとなる
- **GASテストは維持**: 379テストは移行完了まで維持する。v5.0側のテストと並行して実行し、データ整合性を検証する
- **ロールバック可能**: 各フェーズでv4.0に戻せるようにする。PostgreSQLのデータをSheetsに逆同期するスクリプトを用意する
